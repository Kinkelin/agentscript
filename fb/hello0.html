<html>
    <head>
        <title>Hello0</title>
    </head>
    <body>
        <script type="module">
            import firebase from 'https://cdn.skypack.dev/@firebase/app'
            import 'https://cdn.skypack.dev/@firebase/database'
            import Model from '../models/HelloModel.js'
            import util from '../src/util.js'
            import * as fbutils from './fbutils.js'

            firebase.initializeApp(fbutils.config)
            const db = firebase.database()
            db.ref().once('value', ev => {
                util.printToPage(util.objectToString(ev.val()))
                console.log('value', ev, ev.val())
            })

            const transformsRef = fbutils.transformsRef(db, 'hello')

            function addTransform(xfms, name, fcnBody) {
                const xfm = {}
                xfm.function = new Function('model, util', fcnBody)
                xfm.resultRef = transformsRef.child(name + '/result')
                xfms[name] = xfm
            }

            let transforms = {}
            transformsRef.on('child_added', ev => {
                console.log('transform child', ev, ev.val())
                window.ev = ev
                addTransform(transforms, ev.key, ev.val().function)
            })

            async function run() {
                const model = new Model()
                model.population = 1000
                await model.startup()
                model.setup()

                util.toWindow({ util, model, transforms })

                await util.timeoutLoop(
                    () => {
                        model.step()
                        util.forLoop(transforms, (val, key) => {
                            const fcn = transforms[key].function
                            const ref = transforms[key].resultRef
                            const result = fcn(model, util)
                            // If result is a object, this turns it into a string!
                            // Need ref.child() ?
                            ref.set(result)
                        })
                    },
                    -1, // 500,
                    33
                )
            }
            run()
        </script>
    </body>
</html>
