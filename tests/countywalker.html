<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>CountyWalker</title>
    </head>
    <body>
        <div id="map"></div>
        <script type="module">
            // import mapboxgl from 'https://cdn.skypack.dev/mapbox-gl'
            // import * as turf from 'https://cdn.skypack.dev/@turf/turf'

            import * as gis from '../src/gis.js'
            import * as L from 'https://unpkg.com/leaflet/dist/leaflet-src.esm.js'
            import ElementOverlay from './elementOverlay.esm.js'

            import * as util from '../src/utils.js'
            import CountiesModel from '../gis/CountiesModel.js'
            import TwoDraw from '../src/TwoDraw.js'
            import ColorMap from '../src/ColorMap.js'

            // mapboxgl.accessToken =
            //     'pk.eyJ1IjoiYmFja3NwYWNlcyIsImEiOiJjanVrbzI4dncwOXl3M3ptcGJtN3oxMmhoIn0.x9iSCrtm0iADEqixVgPwqQ'
            // mbox.setDefaultStyle()

            const drawOptions = {
                patchesColor: 'transparent',
                linksColor: 'gray',
                turtlesSize: 5,
                turtlesColor: t =>
                    view.drawOptions.turtlesMap.atIndex(t.county),
            }

            async function run() {
                await util.setCssStyle(
                    'https://unpkg.com/leaflet/dist/leaflet.css'
                )

                const counties = await util.xhrPromise(
                    '../gis/data/nmcounties.geojson',
                    'json'
                )
                const model = new CountiesModel(counties)
                const bbox = model.world.bbox
                console.log('bbox', bbox)

                await model.startup()
                model.setup()

                const view = new TwoDraw(model, {
                    div: util.createCanvas(0, 0), // the view will resize
                    drawOptions,
                })

                util.toWindow({ util, model, view })

                const map = L.map('map').setView(
                    model.world.bboxCenter('latlon'),
                    15
                )
                L.tileLayer(gis.template('osm'), {
                    attribution: gis.attribution('osm'),
                }).addTo(map)

                // const map = mbox.newMap(mapboxgl, {
                //     zoom: 5.5,
                //     center: model.world.bboxCenter(),
                // })
                // await mbox.mapLoadPromise(map)

                // mbox.addGeoLines(map, 'counties', counties, 'red', 3)

                // mbox.addBBoxLayer(map, 'bbox', bbox, 'red')

                // mbox.addViewLayer(map, 'model', bbox, view)

                util.timeoutLoop(
                    () => {
                        model.step()
                        view.draw()
                    },
                    -1, // forever
                    33 // 33ms => 30fps
                )
            }
            run()
        </script>
    </body>
</html>
