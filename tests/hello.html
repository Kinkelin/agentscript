<!DOCTYPE html>
<html>
    <head>
        <title>Fire</title>
    </head>

    <body>
        <script>
            function workerSrc(root) {
                importScripts(root + '../dist/agentscript.umd.js')
                importScripts(root + '../models/HelloScript.js')
                console.log('worker self', self)

                util.randomSeed(1)

                const model = new HelloModel()
                model.population = 1000
                model.setup()
                console.log('worker model', model)

                const postBuffers = !true

                const perf = util.fps()
                let steps = 0
                while (steps++ < 1000) {
                    model.step()
                    const data = Object.assign(
                        {},
                        model.turtles.propsObject({
                            x: Float32Array,
                            y: Float32Array,
                            theta: Float32Array,
                        }),
                        model.links.propsObject({
                            x0: Float32Array,
                            y0: Float32Array,
                            x1: Float32Array,
                            y1: Float32Array,
                        })
                    )
                    if (postBuffers) {
                        postMessage(data, [
                            data.x.buffer,
                            data.y.buffer,
                            data.theta.buffer,
                            data.x0.buffer,
                            data.y0.buffer,
                            data.x1.buffer,
                            data.y1.buffer,
                        ])
                    } else {
                        postMessage(data)
                    }
                    perf()
                }

                console.log('worker: done. steps, fps', perf.steps, perf.fps)
                postMessage('done')
            }
        </script>

        <script type="module">
            import util from '../src/util.js'

            const worker = util.fcnToWorker(workerSrc)
            console.log('worker:', worker)

            const perf = util.fps()
            const data = [] // history of data after each step
            worker.onmessage = e => {
                if (e.data === 'done') {
                    console.log('main: done.')
                    console.log('data:', data)
                    util.toWindow({ data })
                    console.log(`steps: ${perf.steps}, fps: ${perf.fps}`)
                } else {
                    data.push(e.data)
                    perf()
                }
            }
        </script>
    </body>
</html>
