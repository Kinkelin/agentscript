<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Test</title>
        <meta
            name="viewport"
            content="initial-scale=1,maximum-scale=1,user-scalable=no"
        />
    </head>
    <body>
        <div id="map"></div>
        <script type="module">
            import '../vendor/mapboxgl.css.js'
            import mapboxgl from '../vendor/mapbox-gl.esm.js'
            import * as turf from '../vendor/turf.esm.js'
            import * as mbox from '../src/mbtools.js'
            import gis from '../src/gis.js'
            import util from '../src/util.js'

            mapboxgl.accessToken =
                'pk.eyJ1IjoiYmFja3NwYWNlcyIsImEiOiJjanVrbzI4dncwOXl3M3ptcGJtN3oxMmhoIn0.x9iSCrtm0iADEqixVgPwqQ'
            mbox.setDefaultDivs()

            // const map = new mapboxgl.Map({
            //     container: 'map', // container id
            //     style: 'mapbox://styles/mapbox/streets-v11',
            //     center: [-105.941109, 35.68222],
            //     zoom: 9,
            //     renderWorldCopies: false,
            // })
            const map = mbox.newMap(mapboxgl, {
                // zoom: 9,
                // center: [-105.941109, 35.68222],
            })
            util.toWindow({ mbox, gis, turf, util, map })

            async function run() {
                await util.mapLoadPromise(map)

                // map.addLayer({
                //     id: 'raster',
                //     type: 'hillshade', // only layer type for raster-dem
                //     source: {
                //         type: 'raster-dem',
                //         url: 'mapbox://mapbox.terrain-rgb',
                //     },
                // })
                mbox.addDemLayer(map, 'raster')

                function centerTileBBox() {
                    const [lon, lat] = mbox.mapCenter(map)
                    const z = map.getZoom()
                    return gis.lonLat2bbox(lon, lat, z)
                }
                console.log('center tile:', centerTileBBox())
                mbox.addBBoxLayer(map, 'bbox', centerTileBBox(), 'red', 3)

                function report(eventType) {
                    // const bounds = map.getBounds().toArray()
                    // const [west, south] = bounds[0]
                    // const [east, north] = bounds[1]
                    // const bbox = [west, south, east, north]
                    const zoom = Math.round(map.getZoom())
                    map.setZoom(zoom)
                    const center = mbox.mapCenter(map)
                    const [x, y] = gis.lonlat2xy(...center, zoom)
                    const bbox = centerTileBBox()
                    // const [west, south, east, north] = bbox
                    // console.log(eventType, center, bbox, zoom)
                    console.log(eventType, zoom, x, y, center) //, bbox, zoom)
                    mbox.updateBBoxLayer(map, 'bbox', bbox)
                }
                map.on('dragend', function (e) {
                    report('dragend')
                })
                map.on('zoomend', function (e) {
                    report('zoomend')
                })
            }
            run()
        </script>
    </body>
</html>
