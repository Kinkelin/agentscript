<!DOCTYPE html>
<html>
    <head>
        <title>Fire</title>
        <!--
            <style>
                /* Drawing with fixed width text */
                body {
                    font-family: 'Courier New', Courier, monospace;
                    font-size: 8px;
                }
                /* canvas {
                    width: 600px;
                    height: 600px;
                } */
            </style>
        -->
    </head>

    <body>
        <canvas id="model" width="600" height="600"></canvas>
        <script type="module">
            import { util } from '../dist/agentscript.esm.js'
            util.toWindow({ util })

            const maxX = 50
            const width = 2 * maxX + 1
            const data = [] // one array of width**2 long each step
            util.toWindow({ data })

            const canvas = document.getElementById('model')
            const domCtx = canvas.getContext('2d')
            domCtx.imageSmoothingEnabled = false
            util.toWindow({ canvas, domCtx })

            const worker = new Worker('fireView1.js', { type: 'module' })
            worker.onerror = function(e) {
                console.log('ERROR: Line ', e.lineno, ': ', e.message)
            }
            worker.postMessage({ cmd: 'init', size: maxX })
            console.log('worker:', worker)
            util.toWindow({ worker })

            const perf = util.fps()
            worker.onmessage = e => {
                if (e.data === 'done') {
                    console.log('main: done.')
                    console.log('data:', data)
                    console.log('First data', data[0])
                    console.log('Last data', data[data.length - 1])
                    console.log(`steps: ${perf.steps}, fps: ${perf.fps}`)
                } else if (util.typeOf(e.data) === 'imagebitmap') {
                    console.log('main: step')
                    data.push(e.data)
                    perf()
                    draw(e.data)
                    worker.postMessage({ cmd: 'step' })
                } else {
                    console.log('unknown e.data:', e.data)
                }
            }

            function draw(img) {
                util.fillCtxWithImage(domCtx, img)
            }
        </script>
    </body>
</html>
