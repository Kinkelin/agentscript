<!DOCTYPE html>
<html>
    <head>
        <title>Fire</title>
    </head>

    <body>
        <script type="module">
            import { util } from '../dist/agentscript.esm.js'
            function fcnToURL(fcn) {
                const str = fcn
                    .toString()
                    // .replace(/^.*\(\).*{/, '')
                    .replace(/^.*{/, '')
                    .replace(/}$/, '')
                    .replace(/\/\/  *import /g, 'import ')
                window.fstr = str
                return URL.createObjectURL(
                    new Blob([str], { type: 'text/javascript' })
                )
            }
            function workerSrc() {
                // Note blob urls must be local or global, not relative
                // import {util} from 'https://backspaces.github.io/agentscript/dist/agentscript.esm.js'
                // import FireModel from 'https://backspaces.github.io/agentscript/models/FireModel.js'
                // importScripts(
                //     'https://backspaces.github.io/agentscript/dist/agentscript.umd.js'
                // )
                // importScripts(
                //     'https://backspaces.github.io/agentscript/models/FireScript.js'
                // )

                // note using importScripts, AS dumped into self
                util.randomSeed(1)

                const options = FireModel.defaultWorld(125) // ditto
                const model = new FireModel(options)
                model.setup()
                console.log('worker model', model)

                const perf = util.fps()
                while (!model.isDone()) {
                    model.step()
                    const data = model.patches.props('type')
                    postMessage(data)
                    perf()
                }

                console.log('worker: done. steps, fps', perf.steps, perf.fps)
                postMessage('done')
            }

            const workerURL = fcnToURL(workerSrc)
            const worker = new Worker(workerURL, { type: 'module' })
            worker.onerror = function(e) {
                console.log('ERROR: Line ', e.lineno, ': ', e.message)
            }
            console.log('worker:', worker)

            const perf = util.fps()
            const data = [] // 515 arrays of 63001 elements each!
            worker.onmessage = e => {
                if (e.data === 'done') {
                    console.log('main: done.')
                    console.log('data:', data)
                    console.log(`steps: ${perf.steps}, fps: ${perf.fps}`)
                } else {
                    data.push(e.data)
                    perf()
                }
            }
        </script>
    </body>
</html>
