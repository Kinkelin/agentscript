<!DOCTYPE html>
<html>
    <head>
        <title>FlockView</title>
    </head>
    <body>
        <canvas id="model"></canvas>
        <script type="module">
            import util from '../src/util.js'
            import Shapes from '../src/Shapes.js'
            util.toWindow({ util, Shapes })

            const params = {
                seed: null,
                maxX: 50,
                maxY: null,
                cell: 3,
                img: null,
                data: null,
                done: 0.9, // stop model when model.flockVectorSize() > done
            }
            Object.assign(params, util.parseQueryString())
            if (!params.maxY) params.maxY = params.maxX
            params.width = 2 * params.maxX + 1
            params.height = 2 * params.maxY + 1
            console.log('params', params)

            const canvas = document.getElementById('model')
            canvas.width = params.width * params.cell
            canvas.height = params.height * params.cell
            const canvasCtx = canvas.getContext('2d')
            // canvasCtx.imageSmoothingEnabled = false
            util.toWindow({ canvas, canvasCtx })
            if (!params.img) {
                const shapes = new Shapes()
                util.toWindow({ shapes })
            }

            const worker = new Worker('flockView.js', { type: 'module' })
            // const worker = new Worker('flockView.js')
            worker.onerror = function(e) {
                console.log('ERROR: Line ', e.lineno, ': ', e.message)
            }
            worker.postMessage({
                cmd: 'init',
                params: params,
            })
            console.log('main worker:', worker)
            util.toWindow({ worker })

            const data = [] // one array of width*height long each step
            let lastData

            const perf = util.fps()
            worker.onmessage = e => {
                if (e.data === 'done') {
                    console.log('main: done.')
                    if (params.data) {
                        util.toWindow({ data })
                        console.log('data:', data)
                        console.log('First data', data[0])
                        console.log('Last data', data[data.length - 1])
                        // console.log('Last pixels', patchesView.pixels)
                    } else {
                        util.toWindow({ lastData })
                        console.log('lastData', lastData)
                    }
                    console.log(`steps: ${perf.steps}, fps: ${perf.fps}`)
                } else {
                    // console.log('main: step')
                    if (params.data) data.push(e.data)
                    else lastData = e.data
                    perf()
                    draw(e.data)
                    worker.postMessage({ cmd: 'step' })
                }
            }

            function draw(data) {
                console.log('data:', data)
                // if (params.img) {
                //     util.fillCtxWithImage(canvasCtx, data)
                // } else {
                //     patchesView.installPixels(data, d => params.patchPixels[d])
                //     patchesView.draw(canvasCtx)
                // }
            }
        </script>
    </body>
</html>
