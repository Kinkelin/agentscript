let util={typeOf:t=>({}).toString.call(t).match(/\s(\w+)/)[1].toLowerCase(),isOneOfTypes:(t,n)=>n.includes(util.typeOf(t)),isUintArray:t=>/^uint.*array$/.test(util.typeOf(t)),isIntArray:t=>/^int.*array$/.test(util.typeOf(t)),isFloatArray:t=>/^float.*array$/.test(util.typeOf(t)),isImage:t=>util.typeOf(t)==='image',isImageable:t=>util.isOneOfTypes(t,['image','htmlimageelement','htmlcanvaselement']),isTypedArray:t=>util.typeOf(t.buffer)==='arraybuffer',isInteger:Number.isInteger||(t=>Math.floor(t)===t),isString:t=>util.typeOf(t)==='string',isObject:t=>util.typeOf(t)==='object',typeName:t=>t.constructor.name,isLittleEndian(){let t=new Uint32Array([16909060]);return(new Uint8ClampedArray(t.buffer))[0]===4},inNode:()=>typeof window==='undefined'&&typeof global!=='undefined',inBrowser:()=>!util.inNode(),globalObject:()=>util.inNode()?global:window,identity:t=>t,noop:()=>{},propFcn:t=>n=>n[t],convertArray(t,n){let e=t.constructor;if(e===n)return t;return n.from(t)},arrayToBuffer(t,n = Float64Array){t.constructor===Array&&(t=new n(t));return new Uint8Array(t.buffer)},bufferToArray(t,n,e = Float64Array){n===Array&&(n=e);return n===Array?Array.from(new e(t.buffer)):new n(t.buffer)},bufferToBase64(t){let n=Array.prototype.map.call(t,t=>String.fromCharCode(t)).join('');return btoa(n)},base64ToBuffer(t){let n=atob(t),e=new Uint8Array(n.length);Array.prototype.forEach.call(n,(t,n)=>{e[n]=t.charCodeAt(0)});return e},randomSeedSin(t = Math.PI/4){return()=>{let n=Math.sin(t++)*1e4;return n-Math.floor(n)}},randomSeedParkMiller(t = 123456){t%=2147483647;return()=>{t=t*16807%2147483647;return(t-1)/2147483646}},randomSeed(t,n = !0){Math.random=n?this.randomSeedParkMiller(t):this.randomSeedSin(t)},logOnce(t){this.logOnceMsgSet||(this.logOnceMsgSet=new Set);this.logOnceMsgSet.has(t)||(console.log(t),this.logOnceMsgSet.add(t))},warn(t){this.logOnce('Warning: '+t)},print(t,n = null){this.isObject(t)&&(t=JSON.stringify(t));!n&&this.inBrowser()&&(n=document.body);n?(n.style.fontFamily='monospace',n.innerHTML+=t+'<br />'):console.log(t)},timeit(t,n = 1e5,e = 'test'){console.time(e);for(let e=0;e<n;e++)t(e);console.timeEnd(e)},pps(t,n = ''){n&&console.log(n);let e=1,r='';while(t){if(typeof t==='function')r=t.constructor.toString();else{let n=Object.keys(t);r=n.length>0?`[${n.join(', ')}]`:`[${t.constructor.name}]`}console.log(`[${e++}]: ${r}`);t=Object.getPrototypeOf(t)}},arraysToString:t=>t.map(t=>`[${t}]`).join(','),toWindow(t){Object.assign(this.globalObject(),t);console.log('toWindow:',Object.keys(t).join(', '))},objectToString(t){return JSON.stringify(t,null,'  ').replace(/ {2}"/g,'  ').replace(/": /g,': ')},objectToString1(t){return JSON.stringify(t).replace(/{"/g,'{').replace(/,"/g,',').replace(/":/g,':')},parseQueryString(){let t={},n=document.location.search.substring(1);n.split('&').forEach(n=>{let e=n.split('=');t[e[0]]=e.length===1?!0:e[1]});return t},setScript(t,n = {}){let e=document.createElement('script');e.src=t;Object.assign(e,n);document.querySelector('head').appendChild(e)},getEventXY(t,n){let e=t.getBoundingClientRect();return[n.clientX-e.left,n.clientY-e.top]},randomInt:t=>Math.floor(Math.random()*t),randomInt2:(t,n)=>t+Math.floor(Math.random()*(n-t)),randomFloat:t=>Math.random()*t,randomFloat2:(t,n)=>t+Math.random()*(n-t),randomCentered:t=>util.randomFloat2(-t/2,t/2),randomNormal(t = 0,n = 1){let[e,r]=[1-Math.random(),Math.random()],o=Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*r);return o*n+t},isPowerOf2:t=>(t&t-1)===0,nextPowerOf2:t=>Math.pow(2,Math.ceil(Math.log2(t))),mod:(t,n)=>(t%n+n)%n,wrap:(t,n,e)=>n+util.mod(t-n,e-n),clamp(t,n,e){if(t<n)return n;if(t>e)return e;return t},between:(t,n,e)=>n<=t&&t<=e,lerp:(t,n,e)=>t<=n?t+(n-t)*e:t-(t-n)*e,lerpScale:(t,n,e)=>(t-n)/(e-n),radians:t=>t*Math.PI/180,degrees:t=>t*180/Math.PI,heading(t){let n=this.degrees(t);return this.mod((90-n),360)},angle(t){let n=this.mod(360-t,360);return this.radians(n)},subtractRadians(t,n){let e=this.mod(t-n,2*Math.PI);e>Math.PI&&(e-=2*Math.PI);return e},subtractHeadings(t,n){let e=this.mod(t-n,360);e>180&&(e-=360);return e},radiansToward:(t,n,e,r)=>Math.atan2(r-n,e-t),headingToward(t,n,e,r){return this.heading(this.radiansToward(t,n,e,r))},distance:(t,n,e,r)=>Math.sqrt(util.sqDistance(t,n,e,r)),sqDistance:(t,n,e,r)=>(t-e)*(t-e)+(n-r)*(n-r),inCone(t,n,e,r,o,i,a){if(this.sqDistance(i,a,t,n)>e*e)return!1;let u=this.radiansToward(i,a,t,n);return r/2>=Math.abs(this.subtractRadians(o,u))},repeat(t,n,e = []){for(let r=0;r<t;r++)n(r,e);return e},step(t,n,e){for(let r=0;r<t;r+=n)e(r)},range(t){return this.repeat(t,(t,n)=>{n[t]=t})},arrayMax:t=>t.reduce((t,n)=>Math.max(t,n)),arrayMin:t=>t.reduce((t,n)=>Math.min(t,n)),arraySum:t=>t.reduce((t,n)=>t+n),arraysEqual(t,n){if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++){if(t[e]!==n[e])return!1}return!0},removeArrayItem(t,n){let e=t.indexOf(n);e!==-1?t.splice(e,1):this.warn(`removeArrayItem: ${n} not in array`);return t},forEach(t,n){if(t.slice)for(let e=0,r=t.length;e<r;e++)n(t[e],e,t);else Object.keys(t).forEach(e=>n(t[e],e,t));return t},clone(t){return t.slice(0)},concatArrays(t,n){let e=t.constructor;if(e===Array)return t.concat(this.convertArray(n,Array));let r=new e(t.length+n.length);r.set(t);r.set(n,t.length);return r},objectsEqual:(t,n)=>JSON.stringify(t)===JSON.stringify(n),histogram(t,n = 1,e = Math.floor(this.arrayMin(t))){let r=[],[o,i]=[Number.MAX_VALUE,Number.MIN_VALUE],[a,u]=[Number.MAX_VALUE,Number.MIN_VALUE];for(let c of t){let t=Math.floor(c/n)-e;r[t]=r[t]===void 0?1:r[t]+1;o=Math.min(o,t);i=Math.max(i,t);a=Math.min(a,c);u=Math.max(u,c)}for(let t in r)r[t]===void 0&&(r[t]=0);let c=i-o+1;return{bins:c,minBin:o,maxBin:i,minVal:a,maxVal:u,hist:r}},oneOf:t=>t[util.randomInt(t.length)],otherOneOf(t,n){if(t.length<2)throw Error('util.otherOneOf: array.length < 2');do{var e=this.oneOf(t)}while(n===e);return e},oneKeyOf:t=>util.oneOf(Object.keys(t)),oneValOf:t=>t[util.oneKeyOf(t)],sortNums(t,n = !0){return t.sort((t,e)=>n?t-e:e-t)},sortObjs(t,n,e = !0){typeof n==='string'&&(n=this.propFcn(n));let r=(t,e)=>n(t)-n(e);return t.sort((t,n)=>e?r(t,n):-r(t,n))},shuffle(t){for(let n=t.length-1;n>0;n--){let e=Math.floor(Math.random()*(n+1)),r=t[n];t[n]=t[e];t[e]=r}return t},uniq(t,n = this.identity){this.isString(n)&&(n=this.propFcn(n));return t.filter((t,e,r)=>e===0||n(t)!==n(r[e-1]))},aRamp(t,n,e){if(e<=1)throw Error('aRamp: numItems must be > 1');let r=[];for(let o=0;o<e;o++)r.push(t+(n-t)*(o/(e-1)));return r},aIntRamp(t,n,e = Math.abs(n-t)+1){return this.aRamp(t,n,e).map(t=>Math.round(t))},normalize(t,n = 0,e = 1){let[r,o]=[this.arrayMin(t),this.arrayMax(t)],i=1/(o-r);return t.map(t=>this.lerp(n,e,i*(t-r)))},normalize8(t){return new Uint8ClampedArray(this.normalize(t,-.5,255.5))},normalizeInt(t,n,e){return this.normalize(t,n,e).map(t=>Math.round(t))},imagePromise(t){return new Promise((n,e)=>{let r=new Image;r.crossOrigin='Anonymous';r.onload=()=>n(r);r.onerror=()=>e(Error(`Could not load image ${t}`));r.src=t})},xhrPromise(t,n = 'text',e = 'GET'){return new Promise((r,o)=>{let i=new XMLHttpRequest;i.open(e,t);i.responseType=n;i.onload=()=>r(i.response);i.onerror=()=>o(Error(`Could not load ${t}: ${i.status}`));i.send()})},timeoutPromise(t = 1e3){return new Promise(n=>{setTimeout(n,t)})},async timeoutLoop(t,n = -1,e = 0){while(n--!==0)t(),await this.timeoutPromise(e)},yieldLoop(t,n = -1){function*e(){while(n--!==0)yield t()}let r=e();while(!r.next().done);},rafPromise(){return new Promise(t=>requestAnimationFrame(t))},async rafLoop(t,n = -1){while(n--!==0)t(),await this.rafPromise()},waitPromise(t,n = 10){return new Promise(e=>{function r(){if(t())return e();else setTimeout(r,n)}r()})},createCanvas(t,n){let e=document.createElement('canvas');Object.assign(e,{width:t,height:n});return e},createCtx(t,n){let e=this.createCanvas(t,n);return e.getContext('2d')},cloneCtx(t){let n=this.createCtx(t.canvas.width,t.canvas.height);n.drawImage(t.canvas,0,0);return n},resizeCtx(t,n,e){let r=this.cloneCtx(t);t.canvas.width=n;t.canvas.height=e;t.drawImage(r.canvas,0,0)},setIdentity(t){t.save();t.setTransform(1,0,0,1,0,0)},setTextParams(t,n,e = 'center',r = 'middle'){Object.assign(t,{font:n,textAlign:e,textBaseline:r})},ctxImageData(t){return t.getImageData(0,0,t.canvas.width,t.canvas.height)},fillCtxWithImage(t,n){this.setIdentity(t);t.drawImage(n,0,0,t.canvas.width,t.canvas.height);t.restore()}};class AgentArray extends Array{static fromArray(t){Object.setPrototypeOf(t,AgentArray.prototype);return t}toArray(){Object.setPrototypeOf(this,Array.prototype);return this}isEmpty(){return this.length===0}first(){return this[0]}last(){return this[this.length-1]}props(t){return this.map(n=>n[t])}values(t){return this.map(n=>t(n))}uniq(t = util.identity){util.isString(t)&&(t=n=>n[t]);return this.filter((n,e,r)=>e===0||t(n)!==t(r[e-1]))}ask(t){for(let n=0;n<this.length;n++)t(this[n],n);return this}count(t){return this.reduce((n,e)=>n+(t(e)?1:0),0)}sum(t){return this.reduce((n,e)=>n+(t?e[t]:e),0)}avg(t){return this.sum(t)/this.length}min(t){return this.reduce((n,e)=>Math.min(n,t?e[t]:e),1/0)}max(t){return this.reduce((n,e)=>Math.max(n,t?e[t]:e),-1/0)}histogram(t,n = 10,e = this.min(t),r = this.max(t)){let o=(r-e)/n,i=new AgentArray(n);i.fill(0);this.ask(a=>{let u=t?a[t]:a;if(u<e||u>r)util.warn(`histogram bounds error: ${u}: ${e}-${r}`);else{let t=Math.floor((u-e)/o);t===n&&t--;i[t]++}});i.parameters={key:t,bins:n,min:e,max:r,binSize:o,arraySize:this.length};return i}clone(t = 0,n = this.length){return this.slice(t,n)}shuffle(){return util.shuffle(this)}sortBy(t,n = !0){util.sortObjs(this,t,n);return this}remove(t,n){let e=this.agentIndex(t,n);e!==-1?this.splice(e,1):util.warn(`remove: ${t} not in AgentArray`);return this}insert(t,n){let e=this.sortedIndex(t,n);if(this[e]===t)throw Error('insert: item already in AgentArray');this.splice(e,0,t)}sortedIndex(t,n = util.identity){util.isString(n)&&(n=util.propFcn(n));let e=n(t),r=0,o=this.length;while(r<o){let t=r+o>>>1;n(this[t])<e?(r=t+1):(o=t)}return r}agentIndex(t,n){if(!n)return this.indexOf(t);let e=this.sortedIndex(t,n);return this[e]===t?e:-1}contains(t,n){return this.agentIndex(t,n)>=0}oneOf(){return util.oneOf(this)}otherOneOf(t){return util.otherOneOf(this,t)}otherNOf(t,n){if(this.length<t)throw Error('AgentArray: otherNOf: length < N');return this.clone().remove(n).shuffle().slice(0,t)}minOrMaxOf(t,n){if(this.isEmpty())throw Error('min/max OneOf: empty array');typeof n==='string'&&(n=util.propFcn(n));let e=null,r=t?1/0:-1/0;for(let o=0;o<this.length;o++){let i=this[o],a=n(i);(t&&a<r||!t&&a>r)&&([e,r]=[i,a])}return e}minOneOf(t){return this.minOrMaxOf(!0,t)}maxOneOf(t){return this.minOrMaxOf(!1,t)}nOf(t){if(t>this.length)throw Error('nOf: n larger than AgentArray');if(t===this.length)return this;let n=new AgentArray;while(n.length<t){let t=this.oneOf();(t in n)||n.push(t)}return n}minOrMaxNOf(t,n,e){if(n>this.length)throw Error('min/max nOf: n larger than AgentArray');let r=this.clone().sortBy(e);return t?r.clone(0,n):r.clone(r.length-n)}minNOf(t,n){return this.minOrMaxNOf(!0,t,n)}maxNOf(t,n){return this.minOrMaxNOf(!1,t,n)}inRect(t,n,e = n,r = !1){let o=new AgentArray,i=t.x-n,a=t.x+n,u=t.y-e,c=t.y+e;this.ask(n=>{i<=n.x&&n.x<=a&&u<=n.y&&n.y<=c&&((r||t!==n)&&o.push(n))});return o}inRadius(t,n,e = !1){let r=new AgentArray,o=n*n,i=util.sqDistance;this.ask(n=>{i(t.x,t.y,n.x,n.y)<=o&&((e||t!==n)&&r.push(n))});return r}inCone(t,n,e,r,o = !1){let i=new AgentArray;this.ask(a=>{util.inCone(a.x,a.y,n,e,r,t.x,t.y)&&((o||t!==a)&&i.push(a))});return i}}class AgentSet extends AgentArray{static get[Symbol.species](){return AgentArray}constructor(t,n,e,r = null){super();r=r||this;Object.assign(this,{model:t,name:e,baseSet:r,AgentClass:n});this.isBaseSet()?(this.breeds={},this.ID=0):(Object.setPrototypeOf(this,Object.getPrototypeOf(r)),this.baseSet.breeds[e]=this);this.ownVariables=[];this.agentProto=new n(this);this.protoMixin(this.agentProto,n)}protoMixin(t,n){Object.assign(t,{agentSet:this,model:this.model});t[this.baseSet.name]=this.baseSet;n.prototype.setBreed||(Object.assign(n.prototype,{setBreed(t){t.setBreed(this)},getBreed(){return this.agentSet},isBreed(t){return this.agentSet===t}}),Object.defineProperty(n.prototype,'breed',{get:function(){return this.agentSet}}))}newBreed(t){return new AgentSet(this.model,this.AgentClass,t,this)}isBreedSet(){return this.baseSet!==this}isBaseSet(){return this.baseSet===this}withBreed(t){return this.filter(n=>n.agentSet===t)}create(){console.log(`AgentSet: Abstract method called: ${this}`)}addAgent(t){t=t||Object.create(this.agentProto);this.isBreedSet()?this.baseSet.addAgent(t):(t.id=this.ID++);this.push(t);return t}clear(){while(!this.isEmpty())this.last().die()}removeAgent(t){this.isBreedSet()&&this.baseSet.remove(t,'id');this.remove(t,'id');return this}setDefault(t,n){this.agentProto[t]=n}getDefault(t){return this.agentProto[t]}settingDefault(t){return t.id==null}own(t){for(let n of t.split(' '))this.setDefault(n,null),this.ownVariables.push(n)}setBreed(t){if(t.agentSet===this)return;t.agentSet.isBreedSet()&&t.agentSet.remove(t,'id');this.isBreedSet()&&this.insert(t,'id');let n=t.agentSet.ownVariables;for(let e of n)this.ownVariables.includes(e)||delete t[e];for(let e of this.ownVariables)n.includes(e)||(t[e]=0);return Object.setPrototypeOf(t,this.agentProto)}}class DataSet{static emptyDataSet(t,n,e){return new DataSet(t,n,new e(t*n))}constructor(t,n,e){if(e.length!==t*n)throw Error(`new DataSet length: ${e.length} !== ${t} * ${n}`);Object.assign(this,{width:t,height:n,data:e})}setName(t){this.name=t;return this}getName(){return this.name?this.name:this.makeName()}makeName(){let{width:t,height:n}=this,e=util.arraySum(this.data).toFixed(2);return`${this.dataType().name}-${t}-${n}-${e}`}checkXY(t,n){if(!this.inBounds(t,n))throw Error(`DataSet: x,y out of range: ${t}, ${n}`)}inBounds(t,n){return util.between(t,0,this.width-1)&&util.between(n,0,this.height-1)}dataType(){return this.data.constructor}type(){return this.constructor}toIndex(t,n){return t+n*this.width}toXY(t){return[t%this.width,Math.floor(t/this.width)]}getXY(t,n){return this.data[this.toIndex(t,n)]}setXY(t,n,e){this.data[this.toIndex(t,n)]=e}sample(t,n,e = !0){this.checkXY(t,n);return e?this.nearest(t,n):this.bilinear(t,n)}nearest(t,n){return this.getXY(Math.round(t),Math.round(n))}bilinear(t,n){let e=Math.floor(t),r=Math.floor(n),o=this.toIndex(e,r),i=this.width,a=t-e,u=n-r,c=1-a,s=1-u,d=this.data[o],f=this.data[o+1]||0,l=this.data[o+i]||0,h=this.data[o+1+i]||0;return d*c*s+f*a*s+l*c*u+h*a*u}copy(){return new DataSet(this.width,this.height,util.clone(this.data))}emptyDataSet(t,n,e = this.dataType()){return DataSet.emptyDataSet(t,n,e)}emptyArray(t){let n=this.type();return new n(t)}resample(t,n,e = !0,r = Array){if(t===this.width&&n===this.height)return this.copy();let o=DataSet.emptyDataSet(t,n,r),i=(this.width-1)/(t-1),a=(this.height-1)/(n-1);for(let r=0;r<n;r++)for(let n=0;n<t;n++)o.setXY(n,r,this.sample(n*i,r*a,e));return o}scale(t,n){let e=this.min(),r=this.max(),o=r-e,i=n-t,a=i/o,u=t-a*e;return this.map(t=>a*t+u)}subset(t,n,e,r){if(t+e>this.width||n+r>this.height)throw Error('DataSet.subSet: params out of range');let o=this.emptyDataSet(e,r);for(let i=0;i<e;i++)for(let e=0;e<r;e++)o.setXY(i,e,this.getXY(i+t,e+n));return o}map(t){return new DataSet(this.width,this.height,this.data.map(t))}col(t){let[n,e,r]=[this.width,this.height,this.data];if(t>=n)throw Error(`col: x out of range width: ${n} x: ${t}`);let o=this.emptyArray(e);for(let i=0;i<e;i++)o[i]=r[t+i*n];return o}row(t){let[n,e]=[this.width,this.height];if(t>=e)throw Error(`row: y out of range height: ${e} x: ${t}`);return this.data.slice(t*n,(t+1)*n)}convertType(t){this.data=util.convertArray(this.data,t)}concatEast(t){let[n,e]=[this.width,this.height],[r,o]=[t.width,t.height];if(e!==o)throw Error(`concatEast: heights not equal ${e}, ${o}`);let i=this.emptyDataSet((n+r),e);for(let t=0;t<e;t++)for(let e=0;e<n;e++)i.setXY(t,e,this.getXY(t,e));for(let e=0;e<o;e++)for(let o=0;o<r;o++)i.setXY(e+n,o,t.getXY(e,o));return i}concatSouth(t){let[n,e,r]=[this.width,this.height,this.data];if(n!==t.width)throw Error(`concatSouth: widths not equal ${n}, ${t.width}`);let o=util.concatArrays(r,t.data);return new DataSet(n,e+t.height,o)}transformCoords(t,n,e,r,o,i){let a=(t-e)*(this.width-1)/o,u=(r-n)*(this.height-1)/i;return[a,u]}coordSample(t,n,e,r,o,i,a = !0){let[u,c]=this.transformCoords(t,n,e,r,o,i);return this.sample(u,c,a)}neighborhood(t,n,e = []){e.length=0;let r=t===0||t===this.width-1||n===0||n===this.height-1;for(let o=-1;o<=1;o++){for(let i=-1;i<=1;i++){let a=t+i,u=n+o;r&&(a=util.clamp(a,0,this.width-1),u=util.clamp(u,0,this.height-1));e.push(this.data[this.toIndex(a,u)])}}return e}convolve(t,n = 1,e = !1){let[r,o,i,a]=e?[1,1,this.height-1,this.width-1]:[0,0,this.height,this.width],u=this.emptyDataSet(a,i),c=u.data,s=0;for(let e=o;e<i;e++){for(let o=r;o<a;o++){let r=this.neighborhood(o,e),i=0;for(let n=0;n<t.length;n++)i+=t[n]*r[n];c[s++]=i*n}}return u}dzdx(t = 2,n = .125){return this.convolve([-1,0,1,-t,0,t,-1,0,1],n)}dzdy(t = 2,n = .125){return this.convolve([1,t,1,0,0,0,-1,-t,-1],n)}laplace8(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])}laplace4(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])}blur(t = .0625){return this.convolve([1,2,1,2,4,2,1,2,1],t)}edge(){return this.convolve([1,1,1,1,-7,1,1,1,1])}slopeAndAspect(t = 1,n = !0){let e=this.dzdx(),r=this.dzdy(),[o,i]=[[],[]],[a,u]=[e.height,e.width];for(let c=0;c<a;c++){for(let a=0;a<u;a++){let[u,s]=[e.getXY(a,c),r.getXY(a,c)];i.push(Math.atan(util.distance(0,0,u,s))/t);let d=Math.atan2(-s,-u);n&&d<0&&(d+=2*Math.PI);o.push(d)}}i=new DataSet(u,a,i);o=new DataSet(u,a,o);return{slope:i,aspect:o,dzdx:e,dzdy:r}}max(){return util.arrayMax(this.data)}min(){return util.arrayMin(this.data)}equals(t){return this.width===t.width&&this.height===t.height&&util.arraysEqual(this.data,t.data)}}class Link{static defaultVariables(){return{end0:null,end1:null,width:1}}constructor(){Object.assign(this,Link.defaultVariables())}init(t,n){this.end0=t;this.end1=n;t.links.push(this);n.links.push(this)}die(){this.agentSet.removeAgent(this);util.removeArrayItem(this.end0.links,this);util.removeArrayItem(this.end1.links,this)}bothEnds(){return[this.end0,this.end1]}length(){return this.end0.distance(this.end1)}otherEnd(t){if(t===this.end0)return this.end1;if(t===this.end1)return this.end0;throw Error(`Link.otherEnd: turtle not a link turtle: ${t}`)}}class Links extends AgentSet{create(t,n,e = t=>{}){Array.isArray(n)||(n=[n]);return n.map(n=>{let r=this.addAgent();r.init(t,n);e(r);return r})}}class World{static defaultOptions(t = 16,n = t){return{minX:-t,maxX:t,minY:-n,maxY:n}}constructor(t = {}){Object.assign(this,World.defaultOptions());Object.assign(this,t);this.setWorld()}setWorld(){this.numX=this.maxX-this.minX+1;this.numY=this.maxY-this.minY+1;this.width=this.numX;this.height=this.numY;this.minXcor=this.minX-.5;this.maxXcor=this.maxX+.5;this.minYcor=this.minY-.5;this.maxYcor=this.maxY+.5;this.centerX=(this.minX+this.maxX)/2;this.centerY=(this.minY+this.maxY)/2}isOnWorld(t,n){return this.minXcor<=t&&t<=this.maxXcor&&this.minYcor<=n&&n<=this.maxYcor}setCtxTransform(t,n){t.canvas.width=this.width*n;t.canvas.height=this.height*n;t.save();t.scale(n,-n);t.translate(-(this.minXcor*n),-(this.maxYcor*n))}}class Patches extends AgentSet{constructor(t,n,e){super(t,n,e);if(this.isBreedSet())return;this.populate();this.labels=[]}populate(){util.repeat(this.model.world.numX*this.model.world.numY,t=>{this.addAgent()})}setDefault(t,n){t==='color'?(this.ask(t=>{t.setColor(n)}),util.logOnce("patches.setDefault(color, value): color default not supported. Clearing to value")):super.setDefault(t,n)}setLabel(t,n){n==null?delete this.labels[t.id]:(this.labels[t.id]=n)}getLabel(t){return this.labels[t.id]}neighborsOffsets(t,n){let{minX:e,maxX:r,minY:o,maxY:i,numX:a}=this.model.world;if(t===e){if(n===o)return[-a,-a+1,1];if(n===i)return[1,a+1,a];return[-a,-a+1,1,a+1,a]}if(t===r){if(n===o)return[-a-1,-a,-1];if(n===i)return[a,a-1,-1];return[-a-1,-a,a,a-1,-1]}if(n===o)return[-a-1,-a,-a+1,1,-1];if(n===i)return[1,a+1,a,a-1,-1];return[-a-1,-a,-a+1,1,a+1,a,a-1,-1]}neighbors4Offsets(t,n){let e=this.model.world.numX;return this.neighborsOffsets(t,n).filter(t=>Math.abs(t)===1||Math.abs(t)===e)}neighbors(t){let{id:n,x:e,y:r}=t,o=this.neighborsOffsets(e,r),i=new AgentArray(o.length);o.forEach((t,e)=>{i[e]=this[t+n]});return i}neighbors4(t){let{id:n,x:e,y:r}=t,o=this.neighbors4Offsets(e,r),i=new AgentArray(o.length);o.forEach((t,e)=>{i[e]=this[t+n]});return i}randomPt(){let{minX:t,maxX:n,minY:e,maxY:r}=this.model.world;return[util.randomInt2(t,n),util.randomInt2(e,r)]}importDataSet(t,n,e = !1){if(this.isBreedSet()){util.warn('Patches: exportDataSet called with breed, using patches');this.baseSet.importDataSet(t,n,e);return}let{numX:r,numY:o}=this.model.world,i=t.resample(r,o,e);this.ask(t=>{t[n]=i.data[t.id]})}exportDataSet(t,n = Array){if(this.isBreedSet()){util.warn('Patches: exportDataSet called with breed, using patches');return this.baseSet.exportDataSet(t,n)}let{numX:e,numY:r}=this.model.world,o=this.props(t);o=util.convertArray(o,n);return new DataSet(e,r,o)}patchIndex(t,n){let{minX:e,maxY:r,numX:o}=this.model.world;return t-e+o*(r-n)}patch(t,n){if(!this.model.world.isOnWorld(t,n))return void 0;let e=t===this.model.world.maxXcor?this.model.world.maxX:Math.round(t),r=n===this.model.world.maxYcor?this.model.world.maxY:Math.round(n);return this.patchXY(e,r)}patchXY(t,n){return this[this.patchIndex(t,n)]}patchRect(t,n,e = n,r = !0){if(t.rectCache){let o=this.cacheIndex(n,e,r),i=t.rectCache[o];if(i)return i}let o=new AgentArray,{minX:i,maxX:a,minY:u,maxY:c}=this.model.world;i=Math.max(i,t.x-n);a=Math.min(a,t.x+n);u=Math.max(u,t.y-e);c=Math.min(c,t.y+e);for(let n=u;n<=c;n++){for(let e=i;e<=a;e++){let i=this.patchXY(e,n);(t!==i||r)&&o.push(i)}}return o}cacheIndex(t,n = t,e = !0){return(2*t+1)*(2*n+1)+(e?0:-1)}cacheRect(t,n = t,e = !0,r = !0){let o=this.cacheIndex(t,n,e);this.ask(i=>{(!i.rectCache||r)&&(i.rectCache=[]);let a=this.inRect(i,t,n,e);i.rectCache[o]=a})}inRect(t,n,e = n,r = !0){let o=this.patchRect(t,n,e,r);if(this.isBaseSet())return o;return o.withBreed(this)}inRadius(t,n,e = !0){let r=this.inRect(t,n,n,e);return r.inRadius(t,n,e)}inCone(t,n,e,r,o = !0){let i=this.inRect(t,n,n,o);return i.inCone(t,n,e,r,o)}patchAtDirectionAndDistance(t,n,e){let{x:r,y:o}=t;r+=e*Math.cos(n);o+=e*Math.sin(n);return this.patch(r,o)}diffuse(t,n){this.diffuseN(8,t,n)}diffuse4(t,n){this.diffuseN(4,t,n)}diffuseN(t,n,e){if(this[0]._diffuseNext===void 0)for(let t=0;t<this.length;t++)this[t]._diffuseNext=0;for(let r=0;r<this.length;r++){let o=this[r],i=o[n]*e,a=i/t,u=t===8?o.neighbors:o.neighbors4,c=u.length;o._diffuseNext+=o[n]-i+(t-c)*a;for(let t=0;t<u.length;t++)u[t]._diffuseNext+=a}for(let t=0;t<this.length;t++){let e=this[t];e[n]=e._diffuseNext;e._diffuseNext=0}}}class Patch{static defaultVariables(){return{turtles:void 0}}constructor(){Object.assign(this,Patch.defaultVariables())}get x(){return this.id%this.model.world.numX+this.model.world.minX}get y(){return this.model.world.maxY-Math.floor(this.id/this.model.world.numX)}isOnEdge(){let{x:t,y:n,model:e}=this,{minX:r,maxX:o,minY:i,maxY:a}=e.world;return t===r||t===o||n===i||n===a}get neighbors(){let t=this.patches.neighbors(this);Object.defineProperty(this,'neighbors',{value:t,enumerable:!0});return t}get neighbors4(){let t=this.patches.neighbors4(this);Object.defineProperty(this,'neighbors4',{value:t,enumerable:!0});return t}turtlesHere(){this.turtles==null&&(this.patches.ask(t=>{t.turtles=[]}),this.model.turtles.ask(t=>{t.patch.turtles.push(t)}));return this.turtles}breedsHere(t){let n=this.turtlesHere();return n.withBreed(t)}distanceXY(t,n){return util.distance(this.x,this.y,t,n)}distance(t){return this.distanceXY(t.x,t.y)}towards(t){return this.towardsXY(t.x,t.y)}towardsXY(t,n){return util.radiansToward(this.x,this.y,t,n)}patchAt(t,n){return this.patches.patch(this.x+t,this.y+n)}patchAtDirectionAndDistance(t,n){return this.patches.patchAtDirectionAndDistance(this,t,n)}sprout(t = 1,n = this.model.turtles,e = t=>{}){return n.create(t,t=>{t.setxy(this.x,this.y),e(t)})}}class Turtles extends AgentSet{create(t = 1,n = t=>{}){return util.repeat(t,(t,e)=>{let r=this.addAgent();r.theta=util.randomFloat(Math.PI*2);n(r);e.push(r)})}randomPt(){let{minXcor:t,maxXcor:n,minYcor:e,maxYcor:r}=this.model.world;return[util.randomFloat2(t,n),util.randomFloat2(e,r)]}inPatches(t){let n=new AgentArray;for(let e of t)n.push(...e.turtlesHere());this.isBreedSet()&&(n=n.filter(t=>t.agentSet===this));return n}inPatchRect(t,n,e = n,r = !1){let o=this.model.patches.inRect(t.patch,n,e,!0),i=this.inPatches(o);r||util.removeArrayItem(i,t);return i}inRadius(t,n,e = !1){let r=this.inPatchRect(t,n,n,!0);return r.inRadius(t,n,e)}inCone(t,n,e,r = !1){let o=this.inPatchRect(t,n,n,!0);return o.inCone(t,n,e,t.theta,r)}layoutCircle(t,n = [0,0],e = Math.PI/2,r = -1){let o=2*Math.PI/this.length,[i,a]=n;this.ask((n,u)=>{n.setxy(i,a),n.theta=e+r*o*u,n.forward(t)})}}class Turtle{static defaultVariables(){return{x:0,y:0,z:0,theta:0,atEdge:'clamp'}}constructor(){Object.assign(this,Turtle.defaultVariables())}die(){this.agentSet.removeAgent(this);if(this.hasOwnProperty('links'))while(this.links.length>0)this.links[0].die();this.patch.turtles!=null&&util.removeArrayItem(this.patch.turtles,this)}hatch(t = 1,n = this.agentSet,e = t=>{}){return n.create(t,t=>{t.setxy(this.x,this.y);for(let e of n.ownVariables)t[e]==null&&(t[e]=this[e]);e(t)})}get links(){Object.defineProperty(this,'links',{value:new AgentArray(0),enumerable:!0});return this.links}get patch(){return this.model.patches.patch(this.x,this.y)}get heading(){return util.heading(this.theta)}set heading(t){this.theta=util.angle(t)}get direction(){return this.theta}set direction(t){this.theta=t}setxy(t,n,e = null){let r=this.patch;e!=null&&(this.z=e);this.model.world.isOnWorld(t,n)?(this.x=t,this.y=n):this.handleEdge(t,n);let o=this.patch;o.turtles!=null&&o!==r&&(util.removeArrayItem(r.turtles,this),o.turtles.push(this))}handleEdge(t,n){if(util.isString(this.atEdge)){let{minXcor:e,maxXcor:r,minYcor:o,maxYcor:i}=this.model.world;if(this.atEdge==='wrap')this.x=util.wrap(t,e,r),this.y=util.wrap(n,o,i);else if(this.atEdge==='clamp'||this.atEdge==='bounce')this.x=util.clamp(t,e,r),this.y=util.clamp(n,o,i),this.atEdge==='bounce'&&(this.x===e||this.x===r?(this.theta=Math.PI-this.theta):(this.theta=-this.theta));else{throw Error(`turtle.handleEdge: bad atEdge: ${this.atEdge}`)}}else this.atEdge(this)}moveTo(t){this.setxy(t.x,t.y)}forward(t){this.setxy(this.x+t*Math.cos(this.theta),this.y+t*Math.sin(this.theta))}rotate(t){this.theta=util.mod(this.theta+t,Math.PI*2)}right(t){this.rotate(-t)}left(t){this.rotate(t)}face(t){this.theta=this.towards(t)}faceXY(t,n){this.theta=this.towardsXY(t,n)}patchAhead(t){return this.patchAtDirectionAndDistance(this.theta,t)}canMove(t){return this.patchAhead(t)!=null}patchLeftAndAhead(t,n){return this.patchAtDirectionAndDistance(t+this.theta,n)}patchRightAndAhead(t,n){return this.patchAtDirectionAndDistance(t-this.theta,n)}distanceXY(t,n){return util.distance(this.x,this.y,t,n)}distance(t){return util.distance(this.x,this.y,t.x,t.y)}towards(t){return this.towardsXY(t.x,t.y)}towardsXY(t,n){return util.radiansToward(this.x,this.y,t,n)}patchAt(t,n){return this.model.patches.patch(this.x+t,this.y+n)}patchAtDirectionAndDistance(t,n){return this.model.patches.patchAtDirectionAndDistance(this,t,n)}otherEnd(t){return t.end0===this?t.end1:t.end0}linkNeighbors(){return this.links.map(t=>this.otherEnd(t))}}class Model{static defaultWorld(t = 16,n = t){return World.defaultOptions(t,n)}constructor(t = Model.defaultWorld()){this.worldOptions=t;this.resetModel()}initAgentSet(t,n,e){let r=new n(this,e,t);this[t]=r}resetModel(){this.world=new World(this.worldOptions);this.initAgentSet('patches',Patches,Patch);this.initAgentSet('turtles',Turtles,Turtle);this.initAgentSet('links',Links,Link)}reset(){this.resetModel()}setup(){}step(){}patchBreeds(t){for(let n of t.split(' '))this[n]=this.patches.newBreed(n)}turtleBreeds(t){for(let n of t.split(' '))this[n]=this.turtles.newBreed(n)}linkBreeds(t){for(let n of t.split(' '))this[n]=this.links.newBreed(n)}}class RGBDataSet extends DataSet{static scaleFromMinMax(t,n){return(n-t)/16777215}constructor(t,n = 0,e = 1,r = Float32Array){super(t.width,t.height,new r(t.width*t.height));let o=util.createCtx(t.width,t.height);util.fillCtxWithImage(o,t);let i=util.ctxImageData(o),a=this.data;for(var u=0;u<a.length;u++){let t=i.data[4*u],r=i.data[4*u+1],o=i.data[4*u+2];a[u]=n+(t*256*256+r*256+o)*e}}}export { AgentArray, AgentSet, DataSet, Link, Links, Model, Patch, Patches, RGBDataSet, Turtle, Turtles, World, util }
