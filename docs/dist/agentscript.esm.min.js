let util={typeOf:n=>({}.toString.call(n).match(/\s(\w+)/)[1].toLowerCase()),isOneOfTypes:(n,t)=>t.includes(util.typeOf(n)),isUintArray:n=>/^uint.*array$/.test(util.typeOf(n)),isIntArray:n=>/^int.*array$/.test(util.typeOf(n)),isFloatArray:n=>/^float.*array$/.test(util.typeOf(n)),isImage:n=>util.typeOf(n)==='image',isImageable:n=>util.isOneOfTypes(n,['image','htmlimageelement','htmlcanvaselement']),isTypedArray:n=>util.typeOf(n.buffer)==='arraybuffer',isInteger:Number.isInteger||(n=>Math.floor(n)===n),isString:n=>util.typeOf(n)==='string',isObject:n=>util.typeOf(n)==='object',typeName:n=>n.constructor.name,isLittleEndian(){let n=new Uint32Array([16909060]);return new Uint8ClampedArray(n.buffer)[0]===4},inNode:()=>typeof window==='undefined'&&typeof global!=='undefined',inBrowser:()=>!util.inNode(),globalObject:()=>util.inNode()?global:window,identity:n=>n,noop:()=>{},propFcn:n=>t=>t[n],convertArray(n,t){let e=n.constructor;if(e===t)return n;return t.from(n)},arrayToBuffer(n,t = Float64Array){n.constructor===Array&&(n=new t(n));return new Uint8Array(n.buffer)},bufferToArray(n,t,e = Float64Array){t===Array&&(t=e);return t===Array?Array.from(new e(n.buffer)):new t(n.buffer)},bufferToBase64(n){let t=Array.prototype.map.call(n,n=>String.fromCharCode(n)).join('');return btoa(t)},base64ToBuffer(n){let t=atob(n),e=new Uint8Array(t.length);Array.prototype.forEach.call(t,(n,t)=>{e[t]=n.charCodeAt(0)});return e},randomSeedSin(n = Math.PI/4){return()=>{let t=Math.sin(n++)*1e4;return t-Math.floor(t)}},randomSeedParkMiller(n = 123456){n%=2147483647;return()=>{n=n*16807%2147483647;return(n-1)/2147483646}},randomSeed(n,t = !0){Math.random=t?this.randomSeedParkMiller(n):this.randomSeedSin(n)},logOnce(n){this.logOnceMsgSet||(this.logOnceMsgSet=new Set);this.logOnceMsgSet.has(n)||(console.log(n),this.logOnceMsgSet.add(n))},warn(n){this.logOnce('Warning: '+n)},print(n,t = null){this.isObject(n)&&(n=JSON.stringify(n));!t&&this.inBrowser()&&(t=document.body);t?(t.style.fontFamily='monospace',t.innerHTML+=n+'<br />'):console.log(n)},timeit(n,t = 1e5,e = 'test'){console.time(e);for(let e=0;e<t;e++)n(e);console.timeEnd(e)},fps(){let n=performance.now(),t=0;return function e(){t++;let r=performance.now()-n,o=parseFloat((t/(r/1e3)).toFixed(2));Object.assign(e,{fps:o,ms:r,steps:t})}},pps(n,t = ''){t&&console.log(t);let e=1,r='';while(n){if(typeof n==='function')r=n.constructor.toString();else{let t=Object.keys(n);r=t.length>0?`[${t.join(', ')}]`:`[${n.constructor.name}]`}console.log(`[${e++}]: ${r}`);n=Object.getPrototypeOf(n)}},arraysToString:n=>n.map(n=>`[${n}]`).join(','),toWindow(n){Object.assign(this.globalObject(),n);console.log('toWindow:',Object.keys(n).join(', '))},objectToString(n){return JSON.stringify(n,null,'  ').replace(/ {2}"/g,'  ').replace(/": /g,': ')},objectToString1(n){return JSON.stringify(n).replace(/{"/g,'{').replace(/,"/g,',').replace(/":/g,':')},parseQueryString(){let n={},t=document.location.search.substring(1);t.split('&').forEach(t=>{let e=t.split('=');n[e[0]]=e.length===1?!0:e[1]});return n},setScript(n,t = {}){let e=document.createElement('script');e.src=n;Object.assign(e,t);document.querySelector('head').appendChild(e)},getEventXY(n,t){let e=n.getBoundingClientRect();return[t.clientX-e.left,t.clientY-e.top]},randomInt:n=>Math.floor(Math.random()*n),randomInt2:(n,t)=>n+Math.floor(Math.random()*(t-n)),randomFloat:n=>Math.random()*n,randomFloat2:(n,t)=>n+Math.random()*(t-n),randomCentered:n=>util.randomFloat2(-n/2,n/2),randomNormal(n = 0,t = 1){let[e,r]=[1-Math.random(),Math.random()],o=Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*r);return o*t+n},isPowerOf2:n=>(n&n-1)===0,nextPowerOf2:n=>Math.pow(2,Math.ceil(Math.log2(n))),mod:(n,t)=>(n%t+t)%t,wrap:(n,t,e)=>t+util.mod(n-t,e-t),clamp(n,t,e){if(n<t)return t;if(n>e)return e;return n},between:(n,t,e)=>t<=n&&n<=e,lerp:(n,t,e)=>n<=t?n+(t-n)*e:n-(n-t)*e,lerpScale:(n,t,e)=>(n-t)/(e-t),radians:n=>n*Math.PI/180,degrees:n=>n*180/Math.PI,heading(n){let t=this.degrees(n);return this.mod(90-t,360)},angle(n){let t=this.mod(360-n,360);return this.radians(t)},subtractRadians(n,t){let e=this.mod(n-t,2*Math.PI);e>Math.PI&&(e-=2*Math.PI);return e},subtractHeadings(n,t){let e=this.mod(n-t,360);e>180&&(e-=360);return e},radiansToward:(n,t,e,r)=>Math.atan2(r-t,e-n),headingToward(n,t,e,r){return this.heading(this.radiansToward(n,t,e,r))},distance:(n,t,e,r)=>Math.sqrt(util.sqDistance(n,t,e,r)),sqDistance:(n,t,e,r)=>(n-e)*(n-e)+(t-r)*(t-r),inCone(n,t,e,r,o,i,a){if(this.sqDistance(i,a,n,t)>e*e)return!1;let u=this.radiansToward(i,a,n,t);return r/2>=Math.abs(this.subtractRadians(o,u))},repeat(n,t,e = []){for(let r=0;r<n;r++)t(r,e);return e},step(n,t,e){for(let r=0;r<n;r+=t)e(r)},range(n){return this.repeat(n,(n,t)=>{t[n]=n})},arrayMax:n=>n.reduce((n,t)=>Math.max(n,t)),arrayMin:n=>n.reduce((n,t)=>Math.min(n,t)),arraySum:n=>n.reduce((n,t)=>n+t),arraysEqual(n,t){if(n.length!==t.length)return!1;for(let e=0;e<n.length;e++){if(n[e]!==t[e])return!1}return!0},removeArrayItem(n,t){let e=n.indexOf(t);e!==-1?n.splice(e,1):this.warn(`removeArrayItem: ${t} not in array`);return n},forEach(n,t){if(n.slice){for(let e=0,r=n.length;e<r;e++)t(n[e],e,n)}else Object.keys(n).forEach(e=>t(n[e],e,n));return n},clone(n){return n.slice(0)},concatArrays(n,t){let e=n.constructor;if(e===Array){return n.concat(this.convertArray(t,Array))}let r=new e(n.length+t.length);r.set(n);r.set(t,n.length);return r},objectsEqual:(n,t)=>JSON.stringify(n)===JSON.stringify(t),histogram(n,t = 1,e = Math.floor(this.arrayMin(n))){let r=[],[o,i]=[Number.MAX_VALUE,Number.MIN_VALUE],[a,u]=[Number.MAX_VALUE,Number.MIN_VALUE];for(let c of n){let n=Math.floor(c/t)-e;r[n]=r[n]===void 0?1:r[n]+1;o=Math.min(o,n);i=Math.max(i,n);a=Math.min(a,c);u=Math.max(u,c)}for(let n in r)r[n]===void 0&&(r[n]=0);let c=i-o+1;return{bins:c,minBin:o,maxBin:i,minVal:a,maxVal:u,hist:r}},oneOf:n=>n[util.randomInt(n.length)],otherOneOf(n,t){if(n.length<2)throw Error('util.otherOneOf: array.length < 2');do{var e=this.oneOf(n)}while(t===e);return e},oneKeyOf:n=>util.oneOf(Object.keys(n)),oneValOf:n=>n[util.oneKeyOf(n)],sortNums(n,t = !0){return n.sort((n,e)=>t?n-e:e-n)},sortObjs(n,t,e = !0){typeof t==='string'&&(t=this.propFcn(t));let r=(n,e)=>t(n)-t(e);return n.sort((n,t)=>e?r(n,t):-r(n,t))},shuffle(n){for(let t=n.length-1;t>0;t--){let e=Math.floor(Math.random()*(t+1)),r=n[t];n[t]=n[e];n[e]=r}return n},uniq(n,t = this.identity){this.isString(t)&&(t=this.propFcn(t));return n.filter((n,e,r)=>e===0||t(n)!==t(r[e-1]))},aRamp(n,t,e){if(e<=1)throw Error('aRamp: numItems must be > 1');let r=[];for(let o=0;o<e;o++)r.push(n+(t-n)*(o/(e-1)));return r},aIntRamp(n,t,e = Math.abs(t-n)+1){return this.aRamp(n,t,e).map(n=>Math.round(n))},normalize(n,t = 0,e = 1){let[r,o]=[this.arrayMin(n),this.arrayMax(n)],i=1/(o-r);return n.map(n=>this.lerp(t,e,i*(n-r)))},normalize8(n){return new Uint8ClampedArray(this.normalize(n,-.5,255.5))},normalizeInt(n,t,e){return this.normalize(n,t,e).map(n=>Math.round(n))},imagePromise(n){return new Promise((t,e)=>{let r=new Image;r.crossOrigin='Anonymous';r.onload=()=>t(r);r.onerror=()=>e(Error(`Could not load image ${n}`));r.src=n})},xhrPromise(n,t = 'text',e = 'GET'){return new Promise((r,o)=>{let i=new XMLHttpRequest;i.open(e,n);i.responseType=t;i.onload=()=>r(i.response);i.onerror=()=>o(Error(`Could not load ${n}: ${i.status}`));i.send()})},timeoutPromise(n = 1e3){return new Promise(t=>{setTimeout(t,n)})},async timeoutLoop(n,t = -1,e = 0){let r=0;while(r++!==t)n(r),await this.timeoutPromise(e)},yieldLoop(n,t = -1){let e=0;function*r(){while(e++!==t)yield n(e)}let o=r();while(!o.next().done);},rafPromise(){return new Promise(n=>requestAnimationFrame(n))},async rafLoop(n,t = -1){let e=0;while(e++!==t)n(e),await this.rafPromise()},waitPromise(n,t = 10){return new Promise(e=>{function r(){if(n())return e();else setTimeout(r,t)}r()})},createCanvas(n,t){let e=document.createElement('canvas');Object.assign(e,{width:n,height:t});return e},createCtx(n,t){let e=this.createCanvas(n,t);return e.getContext('2d')},cloneCtx(n){let t=this.createCtx(n.canvas.width,n.canvas.height);t.drawImage(n.canvas,0,0);return t},resizeCtx(n,t,e){let r=this.cloneCtx(n);n.canvas.width=t;n.canvas.height=e;n.drawImage(r.canvas,0,0)},setIdentity(n){n.save();n.setTransform(1,0,0,1,0,0)},setTextParams(n,t,e = 'center',r = 'middle'){Object.assign(n,{font:t,textAlign:e,textBaseline:r})},ctxImageData(n){return n.getImageData(0,0,n.canvas.width,n.canvas.height)},fillCtxWithImage(n,t){this.setIdentity(n);n.drawImage(t,0,0,n.canvas.width,n.canvas.height);n.restore()}};class AgentArray extends Array{static fromArray(n){Object.setPrototypeOf(n,AgentArray.prototype);return n}toArray(){Object.setPrototypeOf(this,Array.prototype);return this}isEmpty(){return this.length===0}first(){return this[0]}last(){return this[this.length-1]}props(n){let t=new AgentArray(this.length);for(let e=0;e<this.length;e++)t[e]=this[e][n];return t}values(n){let t=new AgentArray(this.length);for(let e=0;e<this.length;e++)t[e]=n(this[e]);return t}uniq(n = util.identity){util.isString(n)&&(n=t=>t[n]);return this.filter((t,e,r)=>e===0||n(t)!==n(r[e-1]))}each(n){for(let t=0,e=this.length;t<e;t++)n(this[t],t,this)}ask(n){let t=this.length;for(let e=0;e<Math.min(t,this.length);e++){n(this[e],e,this);if(t!=this.length){let n=this.name||this.constructor.name,e=this.length<t?'decreasing':'increasing';util.warn(`AgentArray.ask array mutation: ${n}: ${e}`)}}}count(n){return this.reduce((t,e)=>t+(n(e)?1:0),0)}sum(n){return this.reduce((t,e)=>t+(n?e[n]:e),0)}avg(n){return this.sum(n)/this.length}min(n){return this.reduce((t,e)=>Math.min(t,n?e[n]:e),1/0)}max(n){return this.reduce((t,e)=>Math.max(t,n?e[n]:e),-1/0)}histogram(n,t = 10,e = this.min(n),r = this.max(n)){let o=(r-e)/t,i=new AgentArray(t);i.fill(0);this.ask(a=>{let u=n?a[n]:a;if(u<e||u>r)util.warn(`histogram bounds error: ${u}: ${e}-${r}`);else{let n=Math.floor((u-e)/o);n===t&&n--;i[n]++}});i.parameters={key:n,bins:t,min:e,max:r,binSize:o,arraySize:this.length};return i}clone(n = 0,t = this.length){return this.slice(n,t)}shuffle(){return util.shuffle(this)}sortBy(n,t = !0){util.sortObjs(this,n,t);return this}remove(n,t){let e=this.agentIndex(n,t);e!==-1?this.splice(e,1):util.warn(`remove: ${n} not in AgentArray`);return this}insert(n,t){let e=this.sortedIndex(n,t);if(this[e]===n)throw Error('insert: item already in AgentArray');this.splice(e,0,n)}sortedIndex(n,t = util.identity){util.isString(t)&&(t=util.propFcn(t));let e=t(n),r=0,o=this.length;while(r<o){let n=r+o>>>1;t(this[n])<e?(r=n+1):(o=n)}return r}agentIndex(n,t){if(!t)return this.indexOf(n);let e=this.sortedIndex(n,t);return this[e]===n?e:-1}contains(n,t){return this.agentIndex(n,t)>=0}oneOf(){return util.oneOf(this)}otherOneOf(n){return util.otherOneOf(this,n)}otherNOf(n,t){if(this.length<n)throw Error('AgentArray: otherNOf: length < N');return this.clone().remove(t).shuffle().slice(0,n)}minOrMaxOf(n,t,e = !1){if(this.isEmpty())throw Error('min/max OneOf: empty array');typeof t==='string'&&(t=util.propFcn(t));let r=null,o=n?1/0:-1/0;for(let e=0;e<this.length;e++){let i=this[e],a=t(i);(n&&a<o||!n&&a>o)&&([r,o]=[i,a])}return e?[r,o]:r}minOneOf(n){return this.minOrMaxOf(!0,n)}maxOneOf(n){return this.minOrMaxOf(!1,n)}minValOf(n){return this.minOrMaxOf(!0,n,!0)}maxValOf(n){return this.minOrMaxOf(!1,n,!0)}nOf(n){if(n>this.length)throw Error('nOf: n larger than AgentArray');if(n===this.length)return this;let t=new AgentArray;while(t.length<n){let n=this.oneOf();(n in t)||t.push(n)}return t}minOrMaxNOf(n,t,e){if(t>this.length){throw Error('min/max nOf: n larger than AgentArray')}let r=this.clone().sortBy(e);return n?r.clone(0,t):r.clone(r.length-t)}minNOf(n,t){return this.minOrMaxNOf(!0,n,t)}maxNOf(n,t){return this.minOrMaxNOf(!1,n,t)}inRect(n,t,e = t,r = !1){let o=new AgentArray,i=n.x-t,a=n.x+t,u=n.y-e,c=n.y+e;this.ask(t=>{i<=t.x&&t.x<=a&&u<=t.y&&t.y<=c&&((r||n!==t)&&o.push(t))});return o}inRadius(n,t,e = !1){let r=new AgentArray,o=t*t,i=util.sqDistance;this.ask(t=>{i(n.x,n.y,t.x,t.y)<=o&&((e||n!==t)&&r.push(t))});return r}inCone(n,t,e,r,o = !1){let i=new AgentArray;this.ask(a=>{util.inCone(a.x,a.y,t,e,r,n.x,n.y)&&((o||n!==a)&&i.push(a))});return i}}class AgentSet extends AgentArray{static get[Symbol.species](){return AgentArray}constructor(n,t,e,r = null){super();r=r||this;Object.assign(this,{model:n,name:e,baseSet:r,AgentClass:t});this.isBaseSet()?(this.breeds={},this.ID=0):(Object.setPrototypeOf(this,Object.getPrototypeOf(r)),this.baseSet.breeds[e]=this);this.ownVariables=[];this.agentProto=new t(this);this.protoMixin(this.agentProto,t)}protoMixin(n,t){Object.assign(n,{agentSet:this,model:this.model});n[this.baseSet.name]=this.baseSet;t.prototype.setBreed||(Object.assign(t.prototype,{setBreed(n){n.setBreed(this)},getBreed(){return this.agentSet},isBreed(n){return this.agentSet===n}}),Object.defineProperty(t.prototype,'breed',{get:function(){return this.agentSet}}))}newBreed(n){return new AgentSet(this.model,this.AgentClass,n,this)}isBreedSet(){return this.baseSet!==this}isBaseSet(){return this.baseSet===this}withBreed(n){return this.filter(t=>t.agentSet===n)}create(){console.log(`AgentSet: Abstract method called: ${this}`)}addAgent(n){n=n||Object.create(this.agentProto);this.isBreedSet()?this.baseSet.addAgent(n):(n.id=this.ID++);this.push(n);return n}clear(){while(!this.isEmpty())this.last().die()}removeAgent(n){this.isBreedSet()&&this.baseSet.remove(n,'id');this.remove(n,'id');return this}setDefault(n,t){this.agentProto[n]=t;return this}getDefault(n){return this.agentProto[n]}settingDefault(n){return n.id==null}own(n){for(let t of n.split(' '))this.setDefault(t,null),this.ownVariables.push(t)}setBreed(n){if(n.agentSet===this)return;n.agentSet.isBreedSet()&&n.agentSet.remove(n,'id');this.isBreedSet()&&this.insert(n,'id');let t=n.agentSet.ownVariables;for(let e of t)this.ownVariables.includes(e)||delete n[e];for(let e of this.ownVariables)t.includes(e)||(n[e]=0);return Object.setPrototypeOf(n,this.agentProto)}ask(n){if(this.length===0)return;let t=this.last().id;for(let e=0;e<this.length&&this[e].id<=t;e++)n(this[e],e,this)}askSet(n){if(this.length===0)return;this.name==='patches'&&super.ask(n);this.isBaseSet()&&this.baseSetAsk(n);this.isBreedSet()&&this.cloneAsk(n)}baseSetAsk(n){if(this.length===0)return;let t=this.last().id;for(let e=0;e<this.length&&this[e].id<=t;e++){let t=this[e].id;n(this[e],e,this);while(e<this.length&&e>=0&&this[e].id>t)e--}}cloneAsk(n){let t=this.clone();for(let e=0;e<t.length;e++){let r=t[e];r.breed==this&&r.id>0&&n(r,e,t)}}}class DataSet{static emptyDataSet(n,t,e){return new DataSet(n,t,new e(n*t))}constructor(n,t,e){if(e.length!==n*t){throw Error(`new DataSet length: ${e.length} !== ${n} * ${t}`)}Object.assign(this,{width:n,height:t,data:e})}setName(n){this.name=n;return this}getName(){return this.name?this.name:this.makeName()}makeName(){let{width:n,height:t}=this,e=util.arraySum(this.data).toFixed(2);return`${this.dataType().name}-${n}-${t}-${e}`}checkXY(n,t){if(!this.inBounds(n,t)){throw Error(`DataSet: x,y out of range: ${n}, ${t}`)}}inBounds(n,t){return util.between(n,0,this.width-1)&&util.between(t,0,this.height-1)}dataType(){return this.data.constructor}type(){return this.constructor}toIndex(n,t){return n+t*this.width}toXY(n){return[n%this.width,Math.floor(n/this.width)]}getXY(n,t){return this.data[this.toIndex(n,t)]}setXY(n,t,e){this.data[this.toIndex(n,t)]=e}sample(n,t,e = !0){this.checkXY(n,t);return e?this.nearest(n,t):this.bilinear(n,t)}nearest(n,t){return this.getXY(Math.round(n),Math.round(t))}bilinear(n,t){let e=Math.floor(n),r=Math.floor(t),o=this.toIndex(e,r),i=this.width,a=n-e,u=t-r,c=1-a,s=1-u,f=this.data[o],d=this.data[o+1]||0,l=this.data[o+i]||0,h=this.data[o+1+i]||0;return f*c*s+d*a*s+l*c*u+h*a*u}copy(){return new DataSet(this.width,this.height,util.clone(this.data))}emptyDataSet(n,t,e = this.dataType()){return DataSet.emptyDataSet(n,t,e)}emptyArray(n){let t=this.type();return new t(n)}resample(n,t,e = !0,r = Array){if(n===this.width&&t===this.height)return this.copy();let o=DataSet.emptyDataSet(n,t,r),i=(this.width-1)/(n-1),a=(this.height-1)/(t-1);for(let r=0;r<t;r++){for(let t=0;t<n;t++)o.setXY(t,r,this.sample(t*i,r*a,e))}return o}scale(n,t){let e=this.min(),r=this.max(),o=r-e,i=t-n,a=i/o,u=n-a*e;return this.map(n=>a*n+u)}subset(n,t,e,r){if(n+e>this.width||t+r>this.height){throw Error('DataSet.subSet: params out of range')}let o=this.emptyDataSet(e,r);for(let i=0;i<e;i++){for(let e=0;e<r;e++)o.setXY(i,e,this.getXY(i+n,e+t))}return o}map(n){return new DataSet(this.width,this.height,this.data.map(n))}col(n){let[t,e,r]=[this.width,this.height,this.data];if(n>=t)throw Error(`col: x out of range width: ${t} x: ${n}`);let o=this.emptyArray(e);for(let i=0;i<e;i++)o[i]=r[n+i*t];return o}row(n){let[t,e]=[this.width,this.height];if(n>=e)throw Error(`row: y out of range height: ${e} x: ${n}`);return this.data.slice(n*t,(n+1)*t)}convertType(n){this.data=util.convertArray(this.data,n)}concatEast(n){let[t,e]=[this.width,this.height],[r,o]=[n.width,n.height];if(e!==o)throw Error(`concatEast: heights not equal ${e}, ${o}`);let i=this.emptyDataSet(t+r,e);for(let n=0;n<e;n++){for(let e=0;e<t;e++)i.setXY(n,e,this.getXY(n,e))}for(let e=0;e<o;e++){for(let o=0;o<r;o++)i.setXY(e+t,o,n.getXY(e,o))}return i}concatSouth(n){let[t,e,r]=[this.width,this.height,this.data];if(t!==n.width){throw Error(`concatSouth: widths not equal ${t}, ${n.width}`)}let o=util.concatArrays(r,n.data);return new DataSet(t,e+n.height,o)}transformCoords(n,t,e,r,o,i){let a=(n-e)*(this.width-1)/o,u=(r-t)*(this.height-1)/i;return[a,u]}coordSample(n,t,e,r,o,i,a = !0){let[u,c]=this.transformCoords(n,t,e,r,o,i);return this.sample(u,c,a)}neighborhood(n,t,e = []){e.length=0;let r=n===0||n===this.width-1||t===0||t===this.height-1;for(let o=-1;o<=1;o++){for(let i=-1;i<=1;i++){let a=n+i,u=t+o;r&&(a=util.clamp(a,0,this.width-1),u=util.clamp(u,0,this.height-1));e.push(this.data[this.toIndex(a,u)])}}return e}convolve(n,t = 1,e = !1){let[r,o,i,a]=e?[1,1,this.height-1,this.width-1]:[0,0,this.height,this.width],u=this.emptyDataSet(a,i),c=u.data,s=0;for(let e=o;e<i;e++){for(let o=r;o<a;o++){let r=this.neighborhood(o,e),i=0;for(let t=0;t<n.length;t++)i+=n[t]*r[t];c[s++]=i*t}}return u}dzdx(n = 2,t = .125){return this.convolve([-1,0,1,-n,0,n,-1,0,1],t)}dzdy(n = 2,t = .125){return this.convolve([1,n,1,0,0,0,-1,-n,-1],t)}laplace8(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])}laplace4(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])}blur(n = .0625){return this.convolve([1,2,1,2,4,2,1,2,1],n)}edge(){return this.convolve([1,1,1,1,-7,1,1,1,1])}slopeAndAspect(n = 1,t = !0){let e=this.dzdx(),r=this.dzdy(),[o,i]=[[],[]],[a,u]=[e.height,e.width];for(let c=0;c<a;c++){for(let a=0;a<u;a++){let[u,s]=[e.getXY(a,c),r.getXY(a,c)];i.push(Math.atan(util.distance(0,0,u,s))/n);let f=Math.atan2(-s,-u);t&&f<0&&(f+=2*Math.PI);o.push(f)}}i=new DataSet(u,a,i);o=new DataSet(u,a,o);return{slope:i,aspect:o,dzdx:e,dzdy:r}}max(){return util.arrayMax(this.data)}min(){return util.arrayMin(this.data)}equals(n){return this.width===n.width&&this.height===n.height&&util.arraysEqual(this.data,n.data)}}class Link{static defaultVariables(){return{end0:null,end1:null,width:1}}constructor(){Object.assign(this,Link.defaultVariables())}init(n,t){this.end0=n;this.end1=t;n.links.push(this);t.links.push(this)}die(){this.agentSet.removeAgent(this);util.removeArrayItem(this.end0.links,this);util.removeArrayItem(this.end1.links,this);this.id=-1}bothEnds(){return[this.end0,this.end1]}length(){return this.end0.distance(this.end1)}otherEnd(n){if(n===this.end0)return this.end1;if(n===this.end1)return this.end0;throw Error(`Link.otherEnd: turtle not a link turtle: ${n}`)}}class Links extends AgentSet{create(n,t,e = n=>{}){Array.isArray(t)||(t=[t]);return t.map(t=>{let r=this.addAgent();r.init(n,t);e(r);return r})}}class World{static defaultOptions(n = 16,t = n){return{minX:-n,maxX:n,minY:-t,maxY:t}}constructor(n = {}){Object.assign(this,World.defaultOptions());Object.assign(this,n);this.setWorld()}setWorld(){this.numX=this.maxX-this.minX+1;this.numY=this.maxY-this.minY+1;this.width=this.numX;this.height=this.numY;this.minXcor=this.minX-.5;this.maxXcor=this.maxX+.5;this.minYcor=this.minY-.5;this.maxYcor=this.maxY+.5;this.centerX=(this.minX+this.maxX)/2;this.centerY=(this.minY+this.maxY)/2}isOnWorld(n,t){return this.minXcor<=n&&n<=this.maxXcor&&this.minYcor<=t&&t<=this.maxYcor}setCtxTransform(n,t){n.canvas.width=this.width*t;n.canvas.height=this.height*t;n.save();n.scale(t,-t);n.translate(-(this.minXcor*t),-(this.maxYcor*t))}}class Patches extends AgentSet{constructor(n,t,e){super(n,t,e);if(this.isBreedSet())return;this.populate();this.labels=[]}populate(){util.repeat(this.model.world.numX*this.model.world.numY,n=>{this.addAgent()})}setDefault(n,t){n==='color'?(this.ask(n=>{n.setColor(t)}),util.logOnce('patches.setDefault(color, value): color default not supported. Clearing to value')):super.setDefault(n,t)}setLabel(n,t){t==null?delete this.labels[n.id]:(this.labels[n.id]=t)}getLabel(n){return this.labels[n.id]}neighborsOffsets(n,t){let{minX:e,maxX:r,minY:o,maxY:i,numX:a}=this.model.world;if(n===e){if(t===o)return[-a,-a+1,1];if(t===i)return[1,a+1,a];return[-a,-a+1,1,a+1,a]}if(n===r){if(t===o)return[-a-1,-a,-1];if(t===i)return[a,a-1,-1];return[-a-1,-a,a,a-1,-1]}if(t===o)return[-a-1,-a,-a+1,1,-1];if(t===i)return[1,a+1,a,a-1,-1];return[-a-1,-a,-a+1,1,a+1,a,a-1,-1]}neighbors4Offsets(n,t){let e=this.model.world.numX;return this.neighborsOffsets(n,t).filter(n=>Math.abs(n)===1||Math.abs(n)===e)}neighbors(n){let{id:t,x:e,y:r}=n,o=this.neighborsOffsets(e,r),i=new AgentArray(o.length);o.forEach((n,e)=>{i[e]=this[n+t]});return i}neighbors4(n){let{id:t,x:e,y:r}=n,o=this.neighbors4Offsets(e,r),i=new AgentArray(o.length);o.forEach((n,e)=>{i[e]=this[n+t]});return i}randomPt(){let{minX:n,maxX:t,minY:e,maxY:r}=this.model.world;return[util.randomInt2(n,t),util.randomInt2(e,r)]}importDataSet(n,t,e = !1){if(this.isBreedSet()){util.warn('Patches: exportDataSet called with breed, using patches');this.baseSet.importDataSet(n,t,e);return}let{numX:r,numY:o}=this.model.world,i=n.resample(r,o,e);this.ask(n=>{n[t]=i.data[n.id]})}exportDataSet(n,t = Array){if(this.isBreedSet()){util.warn('Patches: exportDataSet called with breed, using patches');return this.baseSet.exportDataSet(n,t)}let{numX:e,numY:r}=this.model.world,o=this.props(n);o=util.convertArray(o,t);return new DataSet(e,r,o)}patchIndex(n,t){let{minX:e,maxY:r,numX:o}=this.model.world;return n-e+o*(r-t)}patch(n,t){if(!this.model.world.isOnWorld(n,t))return void 0;let e=n===this.model.world.maxXcor?this.model.world.maxX:Math.round(n),r=t===this.model.world.maxYcor?this.model.world.maxY:Math.round(t);return this.patchXY(e,r)}patchXY(n,t){return this[this.patchIndex(n,t)]}patchRect(n,t,e = t,r = !0){if(n.rectCache){let o=this.cacheIndex(t,e,r),i=n.rectCache[o];if(i)return i}let o=new AgentArray,{minX:i,maxX:a,minY:u,maxY:c}=this.model.world;i=Math.max(i,n.x-t);a=Math.min(a,n.x+t);u=Math.max(u,n.y-e);c=Math.min(c,n.y+e);for(let t=u;t<=c;t++){for(let e=i;e<=a;e++){let i=this.patchXY(e,t);(n!==i||r)&&o.push(i)}}return o}patchRectXY(n,t,e,r = e,o = !0){return this.patchRect(this.patch(n,t),e,r,o)}cacheIndex(n,t = n,e = !0){return(2*n+1)*(2*t+1)+(e?0:-1)}cacheRect(n,t = n,e = !0,r = !0){let o=this.cacheIndex(n,t,e);this.ask(i=>{(!i.rectCache||r)&&(i.rectCache=[]);let a=this.inRect(i,n,t,e);i.rectCache[o]=a})}inRect(n,t,e = t,r = !0){let o=this.patchRect(n,t,e,r);if(this.isBaseSet())return o;return o.withBreed(this)}inRadius(n,t,e = !0){let r=Math.ceil(t),o=this.inRect(n,r,r,e);return o.inRadius(n,t,e)}inCone(n,t,e,r,o = !0){let i=Math.ceil(t),a=this.inRect(n,i,i,o);return a.inCone(n,t,e,r,o)}patchAtAngleAndDistance(n,t,e){let{x:r,y:o}=n;r+=e*Math.cos(t);o+=e*Math.sin(t);return this.patch(r,o)}isOnEdge(n){let{x:t,y:e}=n,{minX:r,maxX:o,minY:i,maxY:a}=this.model.world;return t===r||t===o||e===i||e===a}edgePatches(){return this.filter(n=>this.isOnEdge(n))}diffuse(n,t){this.diffuseN(8,n,t)}diffuse4(n,t){this.diffuseN(4,n,t)}diffuseN(n,t,e){if(this[0]._diffuseNext===void 0){for(let n=0;n<this.length;n++)this[n]._diffuseNext=0}for(let r=0;r<this.length;r++){let o=this[r],i=o[t]*e,a=i/n,u=n===8?o.neighbors:o.neighbors4,c=u.length;o._diffuseNext+=o[t]-i+(n-c)*a;for(let n=0;n<u.length;n++)u[n]._diffuseNext+=a}for(let n=0;n<this.length;n++){let e=this[n];e[t]=e._diffuseNext;e._diffuseNext=0}}}class Patch{static defaultVariables(){return{turtles:void 0}}constructor(){Object.assign(this,Patch.defaultVariables())}get x(){return this.id%this.model.world.numX+this.model.world.minX}get y(){return this.model.world.maxY-Math.floor(this.id/this.model.world.numX)}isOnEdge(){return this.patches.isOnEdge(this)}get neighbors(){let n=this.patches.neighbors(this);Object.defineProperty(this,'neighbors',{value:n,enumerable:!0});return n}get neighbors4(){let n=this.patches.neighbors4(this);Object.defineProperty(this,'neighbors4',{value:n,enumerable:!0});return n}turtlesHere(){this.turtles==null&&(this.patches.ask(n=>{n.turtles=[]}),this.model.turtles.ask(n=>{n.patch.turtles.push(n)}));return this.turtles}breedsHere(n){let t=this.turtlesHere();return t.withBreed(n)}distanceXY(n,t){return util.distance(this.x,this.y,n,t)}distance(n){return this.distanceXY(n.x,n.y)}towards(n){return this.towardsXY(n.x,n.y)}towardsXY(n,t){return util.radiansToward(this.x,this.y,n,t)}patchAt(n,t){return this.patches.patch(this.x+n,this.y+t)}patchAtAngleAndDistance(n,t){return this.patches.patchAtAngleAndDistance(this,n,t)}sprout(n = 1,t = this.model.turtles,e = n=>{}){return t.create(n,n=>{n.setxy(this.x,this.y),e(n)})}}class Turtles extends AgentSet{create(n = 1,t = n=>{}){return util.repeat(n,(n,e)=>{let r=this.addAgent();r.theta=util.randomFloat(Math.PI*2);t(r);e.push(r)})}randomPt(){let{minXcor:n,maxXcor:t,minYcor:e,maxYcor:r}=this.model.world;return[util.randomFloat2(n,t),util.randomFloat2(e,r)]}inPatches(n){let t=new AgentArray;for(let e of n)t.push(...e.turtlesHere());this.isBreedSet()&&(t=t.filter(n=>n.agentSet===this));return t}inPatchRect(n,t,e = t,r = !1){let o=this.model.patches.inRect(n.patch,t,e,!0),i=this.inPatches(o);r||util.removeArrayItem(i,n);return i}inRadius(n,t,e = !1){let r=this.inPatchRect(n,t,t,!0);return r.inRadius(n,t,e)}inCone(n,t,e,r = !1){let o=this.inPatchRect(n,t,t,!0);return o.inCone(n,t,e,n.theta,r)}layoutCircle(n,t = [0,0],e = Math.PI/2,r = -1){let o=2*Math.PI/this.length,[i,a]=t;this.ask((t,u)=>{t.setxy(i,a),t.theta=e+r*o*u,t.forward(n)})}}class Turtle{static defaultVariables(){return{x:0,y:0,z:0,theta:0,atEdge:'clamp'}}constructor(){Object.assign(this,Turtle.defaultVariables())}die(){this.agentSet.removeAgent(this);if(this.hasOwnProperty('links')){while(this.links.length>0)this.links[0].die()}this.patch.turtles!=null&&util.removeArrayItem(this.patch.turtles,this);this.id=-1}hatch(n = 1,t = this.agentSet,e = n=>{}){return t.create(n,n=>{n.setxy(this.x,this.y);for(let e of t.ownVariables)n[e]==null&&(n[e]=this[e]);e(n)})}get links(){Object.defineProperty(this,'links',{value:new AgentArray(0),enumerable:!0});return this.links}get patch(){return this.model.patches.patch(this.x,this.y)}get heading(){return util.heading(this.theta)}set heading(n){this.theta=util.angle(n)}get direction(){return this.theta}set direction(n){this.theta=n}setxy(n,t,e = null){let r=this.patch;e!=null&&(this.z=e);this.model.world.isOnWorld(n,t)?(this.x=n,this.y=t):this.handleEdge(n,t);let o=this.patch;o.turtles!=null&&o!==r&&(util.removeArrayItem(r.turtles,this),o.turtles.push(this))}handleEdge(n,t){if(util.isString(this.atEdge)){let{minXcor:e,maxXcor:r,minYcor:o,maxYcor:i}=this.model.world;if(this.atEdge==='wrap')this.x=util.wrap(n,e,r),this.y=util.wrap(t,o,i);else if(this.atEdge==='clamp'||this.atEdge==='bounce')this.x=util.clamp(n,e,r),this.y=util.clamp(t,o,i),this.atEdge==='bounce'&&(this.x===e||this.x===r?(this.theta=Math.PI-this.theta):(this.theta=-this.theta));else{throw Error(`turtle.handleEdge: bad atEdge: ${this.atEdge}`)}}else this.atEdge(this)}moveTo(n){this.setxy(n.x,n.y)}forward(n){this.setxy(this.x+n*Math.cos(this.theta),this.y+n*Math.sin(this.theta))}rotate(n){this.theta=util.mod(this.theta+n,Math.PI*2)}right(n){this.rotate(-n)}left(n){this.rotate(n)}face(n){this.theta=this.towards(n)}faceXY(n,t){this.theta=this.towardsXY(n,t)}patchAhead(n){return this.patchAtAngleAndDistance(this.theta,n)}canMove(n){return this.patchAhead(n)!=null}patchLeftAndAhead(n,t){return this.patchAtAngleAndDistance(n+this.theta,t)}patchRightAndAhead(n,t){return this.patchAtAngleAndDistance(n-this.theta,t)}distanceXY(n,t){return util.distance(this.x,this.y,n,t)}distance(n){return util.distance(this.x,this.y,n.x,n.y)}towards(n){return this.towardsXY(n.x,n.y)}towardsXY(n,t){return util.radiansToward(this.x,this.y,n,t)}patchAt(n,t){return this.model.patches.patch(this.x+n,this.y+t)}patchAtAngleAndDistance(n,t){return this.model.patches.patchAtAngleAndDistance(this,n,t)}otherEnd(n){return n.end0===this?n.end1:n.end0}linkNeighbors(){return this.links.map(n=>this.otherEnd(n))}}class Model{static defaultWorld(n = 16,t = n){return World.defaultOptions(n,t)}constructor(n = Model.defaultWorld()){this.worldOptions=n;this.resetModel()}initAgentSet(n,t,e){let r=new t(this,e,n);this[n]=r}resetModel(){this.ticks=0;this.world=new World(this.worldOptions);this.initAgentSet('patches',Patches,Patch);this.initAgentSet('turtles',Turtles,Turtle);this.initAgentSet('links',Links,Link)}reset(){this.resetModel()}tick(){this.ticks++}setup(){}step(){}patchBreeds(n){for(let t of n.split(' '))this[t]=this.patches.newBreed(t)}turtleBreeds(n){for(let t of n.split(' '))this[t]=this.turtles.newBreed(t)}linkBreeds(n){for(let t of n.split(' '))this[t]=this.links.newBreed(t)}}class RGBDataSet extends DataSet{static scaleFromMinMax(n,t){return(t-n)/16777215}constructor(n,t = 0,e = 1,r = Float32Array){super(n.width,n.height,new r(n.width*n.height));let o=util.createCtx(n.width,n.height);util.fillCtxWithImage(o,n);let i=util.ctxImageData(o),a=this.data;for(var u=0;u<a.length;u++){let n=i.data[4*u],r=i.data[4*u+1],o=i.data[4*u+2];a[u]=t+(n*256*256+r*256+o)*e}}}function type(n){return n===null?'Null':n===void 0?'Undefined':Object.prototype.toString.call(n).slice(8,-1)}function toJSON(n,t = 0,e = !0){let r=e,o=['rectCache'],i=JSON.stringify(n,(n,t)=>{if(o.includes(n))return void 0;let e=Array.isArray(t)&&t.length>0&&Number.isInteger(t[0].id);if(e&&!r){return t.map(n=>n.id)}r=!1;return t},t);return i}function sampleObj(n){let t={model:Object.keys(n),patches:n.patches.length,patch:n.patches.oneOf(),turtles:n.turtles.length,turtle:n.turtles.oneOf(),links:n.links.length,link:n.links.oneOf()},e=toJSON(t);return JSON.parse(e)}function sampleJSON(n,t = 0){return toJSON(sampleObj(n),t)}function printToPage(n,t = document.body){type(n)==='Object'&&(n=JSON.stringify(n,null,2),n='<pre>'+n+'</pre>');t.style.fontFamily='monospace';t.innerHTML+=n+'<br />'}var modelIO=Object.freeze({toJSON:toJSON,sampleObj:sampleObj,sampleJSON:sampleJSON,printToPage:printToPage});export { AgentArray, AgentSet, DataSet, Link, Links, Model, Patch, Patches, RGBDataSet, Turtle, Turtles, World, modelIO, util }
