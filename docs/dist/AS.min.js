var AS=(function(n){"use strict";let t={typeOf:n=>({}).toString.call(n).match(/\s(\w+)/)[1].toLowerCase(),isOneOfTypes:(n,e)=>e.includes(t.typeOf(n)),isUintArray:n=>/^uint.*array$/.test(t.typeOf(n)),isIntArray:n=>/^int.*array$/.test(t.typeOf(n)),isFloatArray:n=>/^float.*array$/.test(t.typeOf(n)),isImage:n=>t.typeOf(n)==='image',isImageable:n=>t.isOneOfTypes(n,['image','htmlimageelement','htmlcanvaselement']),isTypedArray:n=>t.typeOf(n.buffer)==='arraybuffer',isInteger:Number.isInteger||(n=>Math.floor(n)===n),isString:n=>t.typeOf(n)==='string',isObject:n=>t.typeOf(n)==='object',arrayType(n){return n.constructor},isLittleEndian(){let n=new Uint32Array([16909060]);return(new Uint8ClampedArray(n.buffer))[0]===4},identity:n=>n,noop:()=>{},propFcn:n=>t=>t[n],convertArray(n,t){let e=n.constructor;if(e===t)return n;return t.from(n)},arrayToBuffer(n,t = Float64Array){n.constructor===Array&&(n=new t(n));return new Uint8Array(n.buffer)},bufferToArray(n,t,e = Float64Array){t===Array&&(t=e);return t===Array?Array.from(new e(n.buffer)):new t(n.buffer)},bufferToBase64(n){let t=Array.prototype.map.call(n,n=>String.fromCharCode(n)).join('');return btoa(t)},base64ToBuffer(n){let t=atob(n),e=new Uint8Array(t.length);Array.prototype.forEach.call(t,(n,t)=>{e[t]=n.charCodeAt(0)});return e},logOnce(n){this.logOnceMsgSet||(this.logOnceMsgSet=new Set);this.logOnceMsgSet.has(n)||(console.log(n),this.logOnceMsgSet.add(n))},warn(n){this.logOnce('Warning: '+n)},log(n,t = document.body){t.style.fontFamily='monospace';t.innerHTML+=this.isObject(n)?JSON.stringify(n)+'<br />':n+'<br />'},timeit(n,t = 1e5,e = 'test'){console.time(e);for(let e=0;e<t;e++)n(e);console.timeEnd(e)},pps(n,t = ''){t&&console.log(t);let e=1,r='';while(n){if(typeof n==='function')r=n.constructor.toString();else{let t=Object.keys(n);r=t.length>0?`[${t.join(', ')}]`:`[${n.constructor.name}]`}console.log(`[${e++}]: ${r}`);n=Object.getPrototypeOf(n)}},arraysToString:n=>n.map(n=>`[${n}]`).join(','),toWindow(n){Object.assign(window,n);console.log('toWindow:',Object.keys(n).join(', '))},objectToString(n){return JSON.stringify(n,null,'  ').replace(/ {2}"/g,'  ').replace(/": /g,': ')},objectToString1(n){return JSON.stringify(n).replace(/{"/g,'{').replace(/,"/g,',').replace(/":/g,':')},parseQueryString(){let n={},t=document.location.search.substring(1);t.split('&').forEach(t=>{let e=t.split('=');n[e[0]]=e.length===1?!0:e[1]});return n},setScript(n,t = {}){let e=document.createElement('script');e.src=n;Object.assign(e,t);document.querySelector('head').appendChild(e)},getEventXY(n,t){let e=n.getBoundingClientRect();return[t.clientX-e.left,t.clientY-e.top]},randomInt:n=>Math.floor(Math.random()*n),randomInt2:(n,t)=>n+Math.floor(Math.random()*(t-n)),randomFloat:n=>Math.random()*n,randomFloat2:(n,t)=>n+Math.random()*(t-n),randomCentered:n=>t.randomFloat2(-n/2,n/2),randomNormal(n = 0,t = 1){let[e,r]=[1-Math.random(),Math.random()],o=Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*r);return o*t+n},isPowerOf2:n=>(n&n-1)===0,nextPowerOf2:n=>Math.pow(2,Math.ceil(Math.log2(n))),mod:(n,t)=>(n%t+t)%t,wrap:(n,e,r)=>e+t.mod(n-e,r-e),clamp(n,t,e){if(n<t)return t;if(n>e)return e;return n},between:(n,t,e)=>t<=n&&n<=e,lerp:(n,t,e)=>n<=t?n+(t-n)*e:n-(n-t)*e,lerpScale:(n,t,e)=>(n-t)/(e-t),radians:n=>n*Math.PI/180,degrees:n=>n*180/Math.PI,heading(n){let t=this.degrees(n);return this.mod((90-t),360)},angle(n){let t=this.mod(360-n,360);return this.radians(t)},subtractRadians(n,t){let e=this.mod(n-t,2*Math.PI);e>Math.PI&&(e-=2*Math.PI);return e},subtractHeadings(n,t){let e=this.mod(n-t,360);e>180&&(e-=360);return e},radiansToward:(n,t,e,r)=>Math.atan2(r-t,e-n),headingToward(n,t,e,r){return this.heading(this.radiansToward(n,t,e,r))},distance:(n,e,r,o)=>Math.sqrt(t.sqDistance(n,e,r,o)),sqDistance:(n,t,e,r)=>(n-e)*(n-e)+(t-r)*(t-r),inCone(n,t,e,r,o,a,i){if(this.sqDistance(a,i,n,t)>e*e)return!1;let u=this.radiansToward(a,i,n,t);return r/2>=Math.abs(this.subtractRadians(o,u))},repeat(n,t,e = []){for(let r=0;r<n;r++)t(r,e);return e},step(n,t,e){for(let r=0;r<n;r+=t)e(r)},range(n){return this.repeat(n,(n,t)=>{t[n]=n})},arrayMax:n=>n.reduce((n,t)=>Math.max(n,t)),arrayMin:n=>n.reduce((n,t)=>Math.min(n,t)),arraySum:n=>n.reduce((n,t)=>n+t),arraysEqual(n,t){if(n.length!==t.length)return!1;for(let e=0;e<n.length;e++){if(n[e]!==t[e])return!1}return!0},removeArrayItem(n,t){let e=n.indexOf(t);e!==-1?n.splice(e,1):this.warn(`removeArrayItem: ${t} not in array`);return n},forEach(n,t){if(n.slice)for(let e=0,r=n.length;e<r;e++)t(n[e],e,n);else Object.keys(n).forEach(e=>t(n[e],e,n));return n},clone(n){return n.slice(0)},concatArrays(n,t){let e=n.constructor;if(e===Array)return n.concat(this.convertArray(t,Array));let r=new e(n.length+t.length);r.set(n);r.set(t,n.length);return r},objectsEqual:(n,t)=>JSON.stringify(n)===JSON.stringify(t),histogram(n,t = 1,e = Math.floor(this.arrayMin(n))){let r=[],[o,a]=[Number.MAX_VALUE,Number.MIN_VALUE],[i,u]=[Number.MAX_VALUE,Number.MIN_VALUE];for(let c of n){let n=Math.floor(c/t)-e;r[n]=r[n]===void 0?1:r[n]+1;o=Math.min(o,n);a=Math.max(a,n);i=Math.min(i,c);u=Math.max(u,c)}for(let n in r)r[n]===void 0&&(r[n]=0);let c=a-o+1;return{bins:c,minBin:o,maxBin:a,minVal:i,maxVal:u,hist:r}},oneOf:n=>n[t.randomInt(n.length)],otherOneOf(n,t){if(n.length<2)throw Error('util.otherOneOf: array.length < 2');do{var e=this.oneOf(n)}while(t===e);return e},oneKeyOf:n=>t.oneOf(Object.keys(n)),oneValOf:n=>n[t.oneKeyOf(n)],sortNums(n,t = !0){return n.sort((n,e)=>t?n-e:e-n)},sortObjs(n,t,e = !0){typeof t==='string'&&(t=this.propFcn(t));let r=(n,e)=>t(n)-t(e);return n.sort((n,t)=>e?r(n,t):-r(n,t))},shuffle(n){for(let t=n.length-1;t>0;t--){let e=Math.floor(Math.random()*(t+1)),r=n[t];n[t]=n[e];n[e]=r}return n},uniq(n,t = this.identity){this.isString(t)&&(t=this.propFcn(t));return n.filter((n,e,r)=>e===0||t(n)!==t(r[e-1]))},aRamp(n,t,e){if(e<=1)throw Error('aRamp: numItems must be > 1');let r=[];for(let o=0;o<e;o++)r.push(n+(t-n)*(o/(e-1)));return r},aIntRamp(n,t,e = Math.abs(t-n)+1){return this.aRamp(n,t,e).map(n=>Math.round(n))},normalize(n,t = 0,e = 1){let[r,o]=[this.arrayMin(n),this.arrayMax(n)],a=1/(o-r);return n.map(n=>this.lerp(t,e,a*(n-r)))},normalize8(n){return new Uint8ClampedArray(this.normalize(n,-.5,255.5))},normalizeInt(n,t,e){return this.normalize(n,t,e).map(n=>Math.round(n))},imagePromise(n){return new Promise((t,e)=>{let r=new Image;r.crossOrigin='Anonymous';r.onload=()=>t(r);r.onerror=()=>e(Error(`Could not load image ${n}`));r.src=n})},xhrPromise(n,t = 'text',e = 'GET'){return new Promise((r,o)=>{let a=new XMLHttpRequest;a.open(e,n);a.responseType=t;a.onload=()=>r(a.response);a.onerror=()=>o(Error(`Could not load ${n}: ${a.status}`));a.send()})},timeoutPromise(n = 1e3){return new Promise((t,e)=>{setTimeout(()=>t(),n)})},scriptPromise(n,t,e = ()=>window[t],r = {}){window[t]==null&&this.setScript(n,r);return this.waitPromise(()=>window[t]!=null,e)},waitPromise(n,t = this.noop,e = 10){return new Promise((r,o)=>{this.waitOn(n,()=>r(t()),e)})},waitOn(n,t,e = 10){n()?t():setTimeout(()=>{this.waitOn(n,t,e)},e)},createCanvas(n,t){let e=document.createElement('canvas');Object.assign(e,{width:n,height:t});return e},createCtx(n,t){let e=this.createCanvas(n,t);return e.getContext('2d')},cloneCtx(n){let t=this.createCtx(n.canvas.width,n.canvas.height);t.drawImage(n.canvas,0,0);return t},resizeCtx(n,t,e){let r=this.cloneCtx(n);n.canvas.width=t;n.canvas.height=e;n.drawImage(r.canvas,0,0)},setIdentity(n){n.save();n.setTransform(1,0,0,1,0,0)},setTextParams(n,t,e = 'center',r = 'middle'){Object.assign(n,{font:t,textAlign:e,textBaseline:r})},ctxImageData(n){return n.getImageData(0,0,n.canvas.width,n.canvas.height)},fillCtxWithImage(n,t){this.setIdentity(n);n.drawImage(t,0,0,n.canvas.width,n.canvas.height);n.restore()}};class e extends Array{static fromArray(n){Object.setPrototypeOf(n,e.prototype);return n}toArray(){Object.setPrototypeOf(this,Array.prototype);return this}empty(){return this.length===0}any(){return this.length!==0}first(){return this[0]}last(){return this[this.length-1]}all(n){return this.every(n)}props(n){return this.map(t=>t[n])}with(n){return this.filter(n)}ask(n){for(let t=0;t<this.length;t++)n(this[t],t);return this}count(n){return this.reduce((t,e)=>t+(n(e)?1:0),0)}clone(n = 0,t = this.length){return this.slice(n,t)}shuffle(){return t.shuffle(this)}sortBy(n,e = !0){t.sortObjs(this,n,e);return this}remove(n,e){let r=this.agentIndex(n,e);r!==-1?this.splice(r,1):t.warn(`remove: ${n} not in AgentArray`);return this}insert(n,t){let e=this.sortedIndex(n,t);if(this[e]===n)throw Error('insert: item already in AgentArray');this.splice(e,0,n)}sortedIndex(n,e = t.identity){t.isString(e)&&(e=t.propFcn(e));let r=e(n),o=0,a=this.length;while(o<a){let n=o+a>>>1;e(this[n])<r?(o=n+1):(a=n)}return o}agentIndex(n,t){if(!t)return this.indexOf(n);let e=this.sortedIndex(n,t);return this[e]===n?e:-1}contains(n,t){return this.agentIndex(n,t)>=0}oneOf(){return t.oneOf(this)}otherOneOf(n){return t.otherOneOf(this,n)}otherNOf(n,t){if(this.length<n)throw Error('AgentArray: otherNOf: length < N');return this.clone().remove(t).shuffle().slice(0,n)}minOrMaxOf(n,e){if(this.empty())throw Error('min/max OneOf: empty array');typeof e==='string'&&(e=t.propFcn(e));let r=null,o=n?1/0:-1/0;for(let t=0;t<this.length;t++){let a=this[t],i=e(a);(n&&i<o||!n&&i>o)&&([r,o]=[a,i])}return r}minOneOf(n){return this.minOrMaxOf(!0,n)}maxOneOf(n){return this.minOrMaxOf(!1,n)}nOf(n){if(n>this.length)throw Error('nOf: n larger than AgentArray');if(n===this.length)return this;let t=new e;while(t.length<n){let n=this.oneOf();(n in t)||t.push(n)}return t}minOrMaxNOf(n,t,e){if(t>this.length)throw Error('min/max nOf: n larger than AgentArray');let r=this.clone().sortBy(e);return n?r.clone(0,t):r.clone(r.length-t)}minNOf(n,t){return this.minOrMaxNOf(!0,n,t)}maxNOf(n,t){return this.minOrMaxNOf(!1,n,t)}inRect(n,t,r = t,o = !1){let a=new e,i=n.x-t,u=n.x+t,c=n.y-r,s=n.y+r;this.ask(t=>{i<=t.x&&t.x<=u&&c<=t.y&&t.y<=s&&((o||n!==t)&&a.push(t))});return a}inRadius(n,r,o = !1){let a=new e,i=r*r,u=t.sqDistance;this.ask(t=>{u(n.x,n.y,t.x,t.y)<=i&&((o||n!==t)&&a.push(t))});return a}inCone(n,r,o,a,i = !1){let u=new e;this.ask(e=>{t.inCone(e.x,e.y,r,o,a,n.x,n.y)&&((i||n!==e)&&u.push(e))});return u}}class r extends e{static get[Symbol.species](){return e}constructor(n,t,e,r = null){super();r=r||this;Object.assign(this,{model:n,name:e,baseSet:r,AgentClass:t});this.isBaseSet()?(this.breeds={},this.ID=0):(Object.setPrototypeOf(this,Object.getPrototypeOf(r)),this.baseSet.breeds[e]=this);this.ownVariables=[];this.agentProto=new t(this);this.protoMixin(this.agentProto,t)}protoMixin(n,t){Object.assign(n,{agentSet:this,model:this.model});n[this.baseSet.name]=this.baseSet;t.prototype.setBreed||(Object.assign(t.prototype,{setBreed(n){n.setBreed(this)},getBreed(){return this.agentSet},isBreed(n){return this.agentSet===n}}),Object.defineProperty(t.prototype,'breed',{get:function(){return this.agentSet}}))}newBreed(n){return new r(this.model,this.AgentClass,n,this)}isBreedSet(){return this.baseSet!==this}isBaseSet(){return this.baseSet===this}withBreed(n){return this.with(t=>t.agentSet===n)}create(){console.log(`AgentSet: Abstract method called: ${this}`)}addAgent(n){n=n||Object.create(this.agentProto);this.isBreedSet()?this.baseSet.addAgent(n):(n.id=this.ID++);this.push(n);return n}clear(){while(this.any())this.last().die()}removeAgent(n){this.isBreedSet()&&this.baseSet.remove(n,'id');this.remove(n,'id');return this}setDefault(n,t){this.agentProto[n]=t}getDefault(n){return this.agentProto[n]}settingDefault(n){return n.id==null}own(n){for(let t of n.split(' '))this.setDefault(t,null),this.ownVariables.push(t)}setBreed(n){if(n.agentSet===this)return;n.agentSet.isBreedSet()&&n.agentSet.remove(n,'id');this.isBreedSet()&&this.insert(n,'id');let t=n.agentSet.ownVariables;for(let e of t)this.ownVariables.includes(e)||delete n[e];for(let e of this.ownVariables)t.includes(e)||(n[e]=0);return Object.setPrototypeOf(n,this.agentProto)}}class o{static emptyDataSet(n,t,e){return new o(n,t,new e(n*t))}constructor(n,t,e){if(e.length!==n*t)throw Error(`new DataSet length: ${e.length} !== ${n} * ${t}`);Object.assign(this,{width:n,height:t,data:e})}setName(n){this.name=n;return this}getName(){return this.name?this.name:this.makeName()}makeName(){let{width:n,height:e}=this,r=t.arraySum(this.data).toFixed(2);return`${this.dataType().name}-${n}-${e}-${r}`}checkXY(n,t){if(!this.inBounds(n,t))throw Error(`DataSet: x,y out of range: ${n}, ${t}`)}inBounds(n,e){return t.between(n,0,this.width-1)&&t.between(e,0,this.height-1)}dataType(){return this.data.constructor}type(){return this.constructor}toIndex(n,t){return n+t*this.width}toXY(n){return[n%this.width,Math.floor(n/this.width)]}getXY(n,t){return this.data[this.toIndex(n,t)]}setXY(n,t,e){this.data[this.toIndex(n,t)]=e}sample(n,t,e = !0){this.checkXY(n,t);return e?this.nearest(n,t):this.bilinear(n,t)}nearest(n,t){return this.getXY(Math.round(n),Math.round(t))}bilinear(n,t){let e=Math.floor(n),r=Math.floor(t),o=this.toIndex(e,r),a=this.width,i=n-e,u=t-r,c=1-i,s=1-u,f=this.data[o],d=this.data[o+1]||0,l=this.data[o+a]||0,h=this.data[o+1+a]||0;return f*c*s+d*i*s+l*c*u+h*i*u}copy(){return new o(this.width,this.height,t.clone(this.data))}emptyDataSet(n,t,e = this.dataType()){return o.emptyDataSet(n,t,e)}emptyArray(n){let t=this.type();return new t(n)}resample(n,t,e = !0,r = Array){if(n===this.width&&t===this.height)return this.copy();let a=o.emptyDataSet(n,t,r),i=(this.width-1)/(n-1),u=(this.height-1)/(t-1);for(let r=0;r<t;r++)for(let t=0;t<n;t++)a.setXY(t,r,this.sample(t*i,r*u,e));return a}subset(n,t,e,r){if(n+e>this.width||t+r>this.height)throw Error('DataSet.subSet: params out of range');let o=this.emptyDataSet(e,r);for(let a=0;a<e;a++)for(let e=0;e<r;e++)o.setXY(a,e,this.getXY(a+n,e+t));return o}map(n){return new o(this.width,this.height,this.data.map(n))}col(n){let[t,e,r]=[this.width,this.height,this.data];if(n>=t)throw Error(`col: x out of range width: ${t} x: ${n}`);let o=this.emptyArray(e);for(let a=0;a<e;a++)o[a]=r[n+a*t];return o}row(n){let[t,e]=[this.width,this.height];if(n>=e)throw Error(`row: y out of range height: ${e} x: ${n}`);return this.data.slice(n*t,(n+1)*t)}convertType(n){this.data=t.convertArray(this.data,n)}concatEast(n){let[t,e]=[this.width,this.height],[r,o]=[n.width,n.height];if(e!==o)throw Error(`concatEast: heights not equal ${e}, ${o}`);let a=this.emptyDataSet((t+r),e);for(let n=0;n<e;n++)for(let e=0;e<t;e++)a.setXY(n,e,this.getXY(n,e));for(let e=0;e<o;e++)for(let o=0;o<r;o++)a.setXY(e+t,o,n.getXY(e,o));return a}concatSouth(n){let[e,r,a]=[this.width,this.height,this.data];if(e!==n.width)throw Error(`concatSouth: widths not equal ${e}, ${n.width}`);let i=t.concatArrays(a,n.data);return new o(e,r+n.height,i)}transformCoords(n,t,e,r,o,a){let i=(n-e)*(this.width-1)/o,u=(r-t)*(this.height-1)/a;return[i,u]}coordSample(n,t,e,r,o,a,i = !0){let[u,c]=this.transformCoords(n,t,e,r,o,a);return this.sample(u,c,i)}neighborhood(n,e,r = []){r.length=0;let o=n===0||n===this.width-1||e===0||e===this.height-1;for(let a=-1;a<=1;a++){for(let i=-1;i<=1;i++){let u=n+i,c=e+a;o&&(u=t.clamp(u,0,this.width-1),c=t.clamp(c,0,this.height-1));r.push(this.data[this.toIndex(u,c)])}}return r}convolve(n,t = 1,e = !1){let[r,o,a,i]=e?[1,1,this.height-1,this.width-1]:[0,0,this.height,this.width],u=this.emptyDataSet(i,a),c=u.data,s=0;for(let e=o;e<a;e++){for(let o=r;o<i;o++){let r=this.neighborhood(o,e),a=0;for(let t=0;t<n.length;t++)a+=n[t]*r[t];c[s++]=a*t}}return u}dzdx(n = 2,t = .125){return this.convolve([-1,0,1,-n,0,n,-1,0,1],t)}dzdy(n = 2,t = .125){return this.convolve([1,n,1,0,0,0,-1,-n,-1],t)}laplace8(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])}laplace4(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])}blur(n = .0625){return this.convolve([1,2,1,2,4,2,1,2,1],n)}edge(){return this.convolve([1,1,1,1,-7,1,1,1,1])}slopeAndAspect(n = 1,e = !0,r = !0){let a=this.dzdx(),i=this.dzdy(),[u,c]=[[],[]],[s,f]=[a.height,a.width];for(let o=0;o<s;o++){for(let s=0;s<f;s++){let[f,d]=[a.getXY(s,o),i.getXY(s,o)];c.push(Math.atan(t.distance(f,d))/n);if(e)while(f===d)f+=t.randomNormal(0,1e-4),d+=t.randomNormal(0,1e-4);let l=f===d&&d===0?NaN:Math.atan2(-d,-f);r&&l<0&&(l+=2*Math.PI);u.push(l)}}c=new o(f,s,c);u=new o(f,s,u);return{slope:c,aspect:u,dzdx:a,dzdy:i}}max(){return t.arrayMax(this.data)}min(){return t.arrayMin(this.data)}equals(n){return this.width===n.width&&this.height===n.height&&t.arraysEqual(this.data,n.data)}}class a{static defaultVariables(){return{end0:null,end1:null,width:1}}constructor(){Object.assign(this,a.defaultVariables())}init(n,t){this.end0=n;this.end1=t;n.links.push(this);t.links.push(this)}die(){this.agentSet.removeAgent(this);t.removeArrayItem(this.end0.links,this);t.removeArrayItem(this.end1.links,this)}bothEnds(){return[this.end0,this.end1]}length(){return this.end0.distance(this.end1)}otherEnd(n){if(n===this.end0)return this.end1;if(n===this.end1)return this.end0;throw Error(`Link.otherEnd: turtle not a link turtle: ${n}`)}}class i extends r{create(n,t,e = n=>{}){Array.isArray(t)||(t=[t]);return t.map(t=>{let r=this.addAgent();r.init(n,t);e(r);return r})}}class u{static defaultOptions(n = 16,t = n){return{minX:-n,maxX:n,minY:-t,maxY:t}}constructor(n = {}){Object.assign(this,u.defaultOptions());Object.assign(this,n);this.setWorld()}setWorld(){this.numX=this.maxX-this.minX+1;this.numY=this.maxY-this.minY+1;this.width=this.numX;this.height=this.numY;this.minXcor=this.minX-.5;this.maxXcor=this.maxX+.5;this.minYcor=this.minY-.5;this.maxYcor=this.maxY+.5;this.centerX=(this.minX+this.maxX)/2;this.centerY=(this.minY+this.maxY)/2}isOnWorld(n,t){return this.minXcor<=n&&n<=this.maxXcor&&this.minYcor<=t&&t<=this.maxYcor}setCtxTransform(n,t){n.canvas.width=this.width*t;n.canvas.height=this.height*t;n.save();n.scale(t,-t);n.translate(-(this.minXcor*t),-(this.maxYcor*t))}}class c extends r{constructor(n,t,e){super(n,t,e);if(this.isBreedSet())return;this.populate();this.labels=[]}populate(){t.repeat(this.model.world.numX*this.model.world.numY,n=>{this.addAgent()})}setDefault(n,e){n==='color'?(this.ask(n=>{n.setColor(e)}),t.logOnce("patches.setDefault(color, value): color default not supported. Clearing to value")):super.setDefault(n,e)}setLabel(n,t){t==null?delete this.labels[n.id]:(this.labels[n.id]=t)}getLabel(n){return this.labels[n.id]}neighborsOffsets(n,t){let{minX:e,maxX:r,minY:o,maxY:a,numX:i}=this.model.world;if(n===e){if(t===o)return[-i,-i+1,1];if(t===a)return[1,i+1,i];return[-i,-i+1,1,i+1,i]}if(n===r){if(t===o)return[-i-1,-i,-1];if(t===a)return[i,i-1,-1];return[-i-1,-i,i,i-1,-1]}if(t===o)return[-i-1,-i,-i+1,1,-1];if(t===a)return[1,i+1,i,i-1,-1];return[-i-1,-i,-i+1,1,i+1,i,i-1,-1]}neighbors4Offsets(n,t){let e=this.model.world.numX;return this.neighborsOffsets(n,t).filter(n=>Math.abs(n)===1||Math.abs(n)===e)}neighbors(n){let{id:t,x:r,y:o}=n,a=this.neighborsOffsets(r,o),i=new e(a.length);a.forEach((n,e)=>{i[e]=this[n+t]});return i}neighbors4(n){let{id:t,x:r,y:o}=n,a=this.neighbors4Offsets(r,o),i=new e(a.length);a.forEach((n,e)=>{i[e]=this[n+t]});return i}randomPt(){let{minX:n,maxX:e,minY:r,maxY:o}=this.model.world;return[t.randomInt2(n,e),t.randomInt2(r,o)]}importDataSet(n,e,r = !1){this.isBreedSet()&&(t.warn('Patches: exportDataSet called with breed, using patches'),this.baseSet.importDataSet(n,e,r));let{numX:o,numY:a}=this.model.world,i=n.resample(o,a,r);this.ask(n=>{n[e]=i.data[n.id]})}exportDataSet(n,e = Array){this.isBreedSet()&&(t.warn('Patches: exportDataSet called with breed, using patches'),this.baseSet.exportDataSet(n,e));let{numX:r,numY:a}=this.model.world,i=this.props(this,n);i=t.convertArray(i,e);return new o(r,a,i)}patchIndex(n,t){let{minX:e,maxY:r,numX:o}=this.model.world;return n-e+o*(r-t)}patch(n,t){if(!this.model.world.isOnWorld(n,t))return void 0;let e=n===this.model.world.maxXcor?this.model.world.maxX:Math.round(n),r=t===this.model.world.maxYcor?this.model.world.maxY:Math.round(t);return this.patchXY(e,r)}patchXY(n,t){return this[this.patchIndex(n,t)]}patchRect(n,t,r = t,o = !0){if(n.rectCache){let e=this.cacheIndex(t,r,o),a=n.rectCache[e];if(a)return a}let a=new e,{minX:i,maxX:u,minY:c,maxY:s}=this.model.world;i=Math.max(i,n.x-t);u=Math.min(u,n.x+t);c=Math.max(c,n.y-r);s=Math.min(s,n.y+r);for(let t=c;t<=s;t++){for(let e=i;e<=u;e++){let r=this.patchXY(e,t);(n!==r||o)&&a.push(r)}}return a}cacheIndex(n,t = n,e = !0){return(2*n+1)*(2*t+1)+(e?0:-1)}cacheRect(n,t = n,e = !0,r = !0){let o=this.cacheIndex(n,t,e);this.ask(a=>{(!a.rectCache||r)&&(a.rectCache=[]);let i=this.inRect(a,n,t,e);a.rectCache[o]=i})}inRect(n,t,e = t,r = !0){let o=this.patchRect(n,t,e,r);if(this.isBaseSet())return o;return o.withBreed(this)}inRadius(n,t,e = !0){let r=this.inRect(n,t,t,e);return r.inRadius(n,t,e)}inCone(n,t,e,r,o = !0){let a=this.inRect(n,t,t,o);return a.inCone(n,t,e,r,o)}patchAtDirectionAndDistance(n,t,e){let{x:r,y:o}=n;r+=e*Math.cos(t);o+=e*Math.sin(t);return this.patch(r,o)}diffuse(n,t){this.diffuseN(8,n,t)}diffuse4(n,t){this.diffuseN(4,n,t)}diffuseN(n,t,e){if(this[0]._diffuseNext===void 0)for(let n=0;n<this.length;n++)this[n]._diffuseNext=0;for(let r=0;r<this.length;r++){let o=this[r],a=o[t]*e,i=a/n,u=n===8?o.neighbors:o.neighbors4,c=u.length;o._diffuseNext+=o[t]-a+(n-c)*i;for(let n=0;n<u.length;n++)u[n]._diffuseNext+=i}for(let n=0;n<this.length;n++){let e=this[n];e[t]=e._diffuseNext;e._diffuseNext=0}}}class s{static defaultVariables(){return{turtles:void 0}}constructor(){Object.assign(this,s.defaultVariables())}get x(){return this.id%this.model.world.numX+this.model.world.minX}get y(){return this.model.world.maxY-Math.floor(this.id/this.model.world.numX)}isOnEdge(){let{x:n,y:t,model:e}=this,{minX:r,maxX:o,minY:a,maxY:i}=e.world;return n===r||n===o||t===a||t===i}get neighbors(){let n=this.patches.neighbors(this);Object.defineProperty(this,'neighbors',{value:n,enumerable:!0});return n}get neighbors4(){let n=this.patches.neighbors4(this);Object.defineProperty(this,'neighbors4',{value:n,enumerable:!0});return n}turtlesHere(){this.turtles==null&&(this.patches.ask(n=>{n.turtles=[]}),this.model.turtles.ask(n=>{n.patch.turtles.push(n)}));return this.turtles}breedsHere(n){let t=this.turtlesHere();return t.withBreed(n)}distanceXY(n,e){return t.distance(this.x,this.y,n,e)}distance(n){return this.distanceXY(n.x,n.y)}towards(n){return this.towardsXY(n.x,n.y)}towardsXY(n,e){return t.radiansToward(this.x,this.y,n,e)}patchAt(n,t){return this.patches.patch(this.x+n,this.y+t)}patchAtDirectionAndDistance(n,t){return this.patches.patchAtDirectionAndDistance(this,n,t)}sprout(n = 1,t = this.model.turtles,e = n=>{}){return t.create(n,n=>{n.setxy(this.x,this.y),e(n)})}}class f extends r{create(n = 1,e = n=>{}){return t.repeat(n,(n,r)=>{let o=this.addAgent();o.theta=t.randomFloat(Math.PI*2);e(o);r.push(o)})}randomPt(){let{minXcor:n,maxXcor:e,minYcor:r,maxYcor:o}=this.model.world;return[t.randomFloat2(n,e),t.randomFloat2(r,o)]}inPatches(n){let t=new e;for(let e of n)t.push(...e.turtlesHere());this.isBreedSet()&&(t=t.filter(n=>n.agentSet===this));return t}inPatchRect(n,e,r = e,o = !1){let a=this.model.patches.inRect(n.patch,e,r,!0),i=this.inPatches(a);o||t.removeArrayItem(i,n);return i}inRadius(n,t,e = !1){let r=this.inPatchRect(n,t,t,!0);return r.inRadius(n,t,e)}inCone(n,t,e,r = !1){let o=this.inPatchRect(n,t,t,!0);return o.inCone(n,t,e,n.theta,r)}layoutCircle(n,t = [0,0],e = Math.PI/2,r = -1){let o=2*Math.PI/this.length,[a,i]=t;this.ask((t,u)=>{t.setxy(a,i),t.theta=e+r*o*u,t.forward(n)})}}class d{static defaultVariables(){return{x:0,y:0,z:0,theta:0,atEdge:'clamp'}}constructor(){Object.assign(this,d.defaultVariables())}die(){this.agentSet.removeAgent(this);if(this.hasOwnProperty('links'))while(this.links.length>0)this.links[0].die();this.patch.turtles!=null&&t.removeArrayItem(this.patch.turtles,this)}hatch(n = 1,t = this.agentSet,e = n=>{}){return t.create(n,n=>{n.setxy(this.x,this.y);for(let e of t.ownVariables)n[e]==null&&(n[e]=this[e]);e(n)})}get links(){Object.defineProperty(this,'links',{value:[],enumerable:!0});return this.links}get patch(){return this.model.patches.patch(this.x,this.y)}get heading(){return t.heading(this.theta)}set heading(n){this.theta=t.angle(n)}get direction(){return this.theta}set direction(n){this.theta=n}setxy(n,e,r = null){let o=this.patch;r!=null&&(this.z=r);this.model.world.isOnWorld(n,e)?(this.x=n,this.y=e):this.handleEdge(n,e);let a=this.patch;a.turtles!=null&&a!==o&&(t.removeArrayItem(o.turtles,this),a.turtles.push(this))}handleEdge(n,e){if(t.isString(this.atEdge)){let{minXcor:r,maxXcor:o,minYcor:a,maxYcor:i}=this.model.world;if(this.atEdge==='wrap')this.x=t.wrap(n,r,o),this.y=t.wrap(e,a,i);else if(this.atEdge==='clamp'||this.atEdge==='bounce')this.x=t.clamp(n,r,o),this.y=t.clamp(e,a,i),this.atEdge==='bounce'&&(this.x===r||this.x===o?(this.theta=Math.PI-this.theta):(this.theta=-this.theta));else{throw Error(`turtle.handleEdge: bad atEdge: ${this.atEdge}`)}}else this.atEdge(this)}moveTo(n){this.setxy(n.x,n.y)}forward(n){this.setxy(this.x+n*Math.cos(this.theta),this.y+n*Math.sin(this.theta))}rotate(n){this.theta=t.mod(this.theta+n,Math.PI*2)}right(n){this.rotate(-n)}left(n){this.rotate(n)}face(n){this.theta=this.towards(n)}faceXY(n,t){this.theta=this.towardsXY(n,t)}patchAhead(n){return this.patchAtDirectionAndDistance(this.theta,n)}canMove(n){return this.patchAhead(n)!=null}patchLeftAndAhead(n,t){return this.patchAtDirectionAndDistance(n+this.theta,t)}patchRightAndAhead(n,t){return this.patchAtDirectionAndDistance(n-this.theta,t)}distanceXY(n,e){return t.distance(this.x,this.y,n,e)}distance(n){return t.distance(this.x,this.y,n.x,n.y)}towards(n){return this.towardsXY(n.x,n.y)}towardsXY(n,e){return t.radiansToward(this.x,this.y,n,e)}patchAt(n,t){return this.model.patches.patch(this.x+n,this.y+t)}patchAtDirectionAndDistance(n,t){return this.model.patches.patchAtDirectionAndDistance(this,n,t)}otherEnd(n){return n.end0===this?n.end1:n.end0}linkNeighbors(){return this.links.map(n=>this.otherEnd(n))}}class l{static defaultWorld(n = 16,t = n){return u.defaultOptions(n,t)}constructor(n = l.defaultWorld()){this.worldOptions=n;this.resetModel()}initAgentSet(n,t,e){let r=new t(this,e,n);this[n]=r}resetModel(){this.world=new u(this.worldOptions);this.initAgentSet('patches',c,s);this.initAgentSet('turtles',f,d);this.initAgentSet('links',i,a)}reset(){this.resetModel()}setup(){}step(){}patchBreeds(n){for(let t of n.split(' '))this[t]=this.patches.newBreed(t)}turtleBreeds(n){for(let t of n.split(' '))this[t]=this.turtles.newBreed(t)}linkBreeds(n){for(let t of n.split(' '))this[t]=this.links.newBreed(t)}}class h extends o{static scaleFromMinMax(n,t){return(t-n)/16777215}constructor(n,e = 0,r = 1){super(n.width,n.height,new Float32Array(n.width*n.height));let o=t.createCtx(n.width,n.height);t.fillCtxWithImage(o,n);let a=t.ctxImageData(o),i=this.data;for(var u=0;u<i.length;u++){let n=a.data[4*u],t=a.data[4*u+1],o=a.data[4*u+2];i[u]=e+(n*256*256+t*256+o)*r}}}n.AgentArray=e;n.AgentSet=r;n.DataSet=o;n.Link=a;n.Links=i;n.Model=l;n.Patch=s;n.Patches=c;n.RGBDataSet=h;n.Turtle=d;n.Turtles=f;n.World=u;n.util=t;return n}({}))
