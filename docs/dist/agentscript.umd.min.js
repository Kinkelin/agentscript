!function(n,t){typeof exports==='object'&&typeof module!=='undefined'?t(exports):typeof define==='function'&&define.amd?define(['exports'],t):(t((n.AS={})))}(this,(function(n){"use strict";let t={typeOf:n=>({}).toString.call(n).match(/\s(\w+)/)[1].toLowerCase(),isOneOfTypes:(n,e)=>e.includes(t.typeOf(n)),isUintArray:n=>/^uint.*array$/.test(t.typeOf(n)),isIntArray:n=>/^int.*array$/.test(t.typeOf(n)),isFloatArray:n=>/^float.*array$/.test(t.typeOf(n)),isImage:n=>t.typeOf(n)==='image',isImageable:n=>t.isOneOfTypes(n,['image','htmlimageelement','htmlcanvaselement']),isTypedArray:n=>t.typeOf(n.buffer)==='arraybuffer',isInteger:Number.isInteger||(n=>Math.floor(n)===n),isString:n=>t.typeOf(n)==='string',isObject:n=>t.typeOf(n)==='object',typeName:n=>n.constructor.name,isLittleEndian(){let n=new Uint32Array([16909060]);return(new Uint8ClampedArray(n.buffer))[0]===4},inNode:()=>typeof window==='undefined'&&typeof global!=='undefined',inBrowser:()=>!t.inNode(),globalObject:()=>t.inNode()?global:window,identity:n=>n,noop:()=>{},propFcn:n=>t=>t[n],convertArray(n,t){let e=n.constructor;if(e===t)return n;return t.from(n)},arrayToBuffer(n,t = Float64Array){n.constructor===Array&&(n=new t(n));return new Uint8Array(n.buffer)},bufferToArray(n,t,e = Float64Array){t===Array&&(t=e);return t===Array?Array.from(new e(n.buffer)):new t(n.buffer)},bufferToBase64(n){let t=Array.prototype.map.call(n,n=>String.fromCharCode(n)).join('');return btoa(t)},base64ToBuffer(n){let t=atob(n),e=new Uint8Array(t.length);Array.prototype.forEach.call(t,(n,t)=>{e[t]=n.charCodeAt(0)});return e},randomSeedSin(n = Math.PI/4){return()=>{let t=Math.sin(n++)*1e4;return t-Math.floor(t)}},randomSeedParkMiller(n = 123456){n%=2147483647;return()=>{n=n*16807%2147483647;return(n-1)/2147483646}},randomSeed(n,t = !0){Math.random=t?this.randomSeedParkMiller(n):this.randomSeedSin(n)},logOnce(n){this.logOnceMsgSet||(this.logOnceMsgSet=new Set);this.logOnceMsgSet.has(n)||(console.log(n),this.logOnceMsgSet.add(n))},warn(n){this.logOnce('Warning: '+n)},print(n,t = null){this.isObject(n)&&(n=JSON.stringify(n));!t&&this.inBrowser()&&(t=document.body);t?(t.style.fontFamily='monospace',t.innerHTML+=n+'<br />'):console.log(n)},timeit(n,t = 1e5,e = 'test'){console.time(e);for(let e=0;e<t;e++)n(e);console.timeEnd(e)},pps(n,t = ''){t&&console.log(t);let e=1,r='';while(n){if(typeof n==='function')r=n.constructor.toString();else{let t=Object.keys(n);r=t.length>0?`[${t.join(', ')}]`:`[${n.constructor.name}]`}console.log(`[${e++}]: ${r}`);n=Object.getPrototypeOf(n)}},arraysToString:n=>n.map(n=>`[${n}]`).join(','),toWindow(n){Object.assign(this.globalObject(),n);console.log('toWindow:',Object.keys(n).join(', '))},objectToString(n){return JSON.stringify(n,null,'  ').replace(/ {2}"/g,'  ').replace(/": /g,': ')},objectToString1(n){return JSON.stringify(n).replace(/{"/g,'{').replace(/,"/g,',').replace(/":/g,':')},parseQueryString(){let n={},t=document.location.search.substring(1);t.split('&').forEach(t=>{let e=t.split('=');n[e[0]]=e.length===1?!0:e[1]});return n},setScript(n,t = {}){let e=document.createElement('script');e.src=n;Object.assign(e,t);document.querySelector('head').appendChild(e)},getEventXY(n,t){let e=n.getBoundingClientRect();return[t.clientX-e.left,t.clientY-e.top]},randomInt:n=>Math.floor(Math.random()*n),randomInt2:(n,t)=>n+Math.floor(Math.random()*(t-n)),randomFloat:n=>Math.random()*n,randomFloat2:(n,t)=>n+Math.random()*(t-n),randomCentered:n=>t.randomFloat2(-n/2,n/2),randomNormal(n = 0,t = 1){let[e,r]=[1-Math.random(),Math.random()],o=Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*r);return o*t+n},isPowerOf2:n=>(n&n-1)===0,nextPowerOf2:n=>Math.pow(2,Math.ceil(Math.log2(n))),mod:(n,t)=>(n%t+t)%t,wrap:(n,e,r)=>e+t.mod(n-e,r-e),clamp(n,t,e){if(n<t)return t;if(n>e)return e;return n},between:(n,t,e)=>t<=n&&n<=e,lerp:(n,t,e)=>n<=t?n+(t-n)*e:n-(n-t)*e,lerpScale:(n,t,e)=>(n-t)/(e-t),radians:n=>n*Math.PI/180,degrees:n=>n*180/Math.PI,heading(n){let t=this.degrees(n);return this.mod((90-t),360)},angle(n){let t=this.mod(360-n,360);return this.radians(t)},subtractRadians(n,t){let e=this.mod(n-t,2*Math.PI);e>Math.PI&&(e-=2*Math.PI);return e},subtractHeadings(n,t){let e=this.mod(n-t,360);e>180&&(e-=360);return e},radiansToward:(n,t,e,r)=>Math.atan2(r-t,e-n),headingToward(n,t,e,r){return this.heading(this.radiansToward(n,t,e,r))},distance:(n,e,r,o)=>Math.sqrt(t.sqDistance(n,e,r,o)),sqDistance:(n,t,e,r)=>(n-e)*(n-e)+(t-r)*(t-r),inCone(n,t,e,r,o,i,a){if(this.sqDistance(i,a,n,t)>e*e)return!1;let u=this.radiansToward(i,a,n,t);return r/2>=Math.abs(this.subtractRadians(o,u))},repeat(n,t,e = []){for(let r=0;r<n;r++)t(r,e);return e},step(n,t,e){for(let r=0;r<n;r+=t)e(r)},range(n){return this.repeat(n,(n,t)=>{t[n]=n})},arrayMax:n=>n.reduce((n,t)=>Math.max(n,t)),arrayMin:n=>n.reduce((n,t)=>Math.min(n,t)),arraySum:n=>n.reduce((n,t)=>n+t),arraysEqual(n,t){if(n.length!==t.length)return!1;for(let e=0;e<n.length;e++){if(n[e]!==t[e])return!1}return!0},removeArrayItem(n,t){let e=n.indexOf(t);e!==-1?n.splice(e,1):this.warn(`removeArrayItem: ${t} not in array`);return n},forEach(n,t){if(n.slice)for(let e=0,r=n.length;e<r;e++)t(n[e],e,n);else Object.keys(n).forEach(e=>t(n[e],e,n));return n},clone(n){return n.slice(0)},concatArrays(n,t){let e=n.constructor;if(e===Array)return n.concat(this.convertArray(t,Array));let r=new e(n.length+t.length);r.set(n);r.set(t,n.length);return r},objectsEqual:(n,t)=>JSON.stringify(n)===JSON.stringify(t),histogram(n,t = 1,e = Math.floor(this.arrayMin(n))){let r=[],[o,i]=[Number.MAX_VALUE,Number.MIN_VALUE],[a,u]=[Number.MAX_VALUE,Number.MIN_VALUE];for(let c of n){let n=Math.floor(c/t)-e;r[n]=r[n]===void 0?1:r[n]+1;o=Math.min(o,n);i=Math.max(i,n);a=Math.min(a,c);u=Math.max(u,c)}for(let n in r)r[n]===void 0&&(r[n]=0);let c=i-o+1;return{bins:c,minBin:o,maxBin:i,minVal:a,maxVal:u,hist:r}},oneOf:n=>n[t.randomInt(n.length)],otherOneOf(n,t){if(n.length<2)throw Error('util.otherOneOf: array.length < 2');do{var e=this.oneOf(n)}while(t===e);return e},oneKeyOf:n=>t.oneOf(Object.keys(n)),oneValOf:n=>n[t.oneKeyOf(n)],sortNums(n,t = !0){return n.sort((n,e)=>t?n-e:e-n)},sortObjs(n,t,e = !0){typeof t==='string'&&(t=this.propFcn(t));let r=(n,e)=>t(n)-t(e);return n.sort((n,t)=>e?r(n,t):-r(n,t))},shuffle(n){for(let t=n.length-1;t>0;t--){let e=Math.floor(Math.random()*(t+1)),r=n[t];n[t]=n[e];n[e]=r}return n},uniq(n,t = this.identity){this.isString(t)&&(t=this.propFcn(t));return n.filter((n,e,r)=>e===0||t(n)!==t(r[e-1]))},aRamp(n,t,e){if(e<=1)throw Error('aRamp: numItems must be > 1');let r=[];for(let o=0;o<e;o++)r.push(n+(t-n)*(o/(e-1)));return r},aIntRamp(n,t,e = Math.abs(t-n)+1){return this.aRamp(n,t,e).map(n=>Math.round(n))},normalize(n,t = 0,e = 1){let[r,o]=[this.arrayMin(n),this.arrayMax(n)],i=1/(o-r);return n.map(n=>this.lerp(t,e,i*(n-r)))},normalize8(n){return new Uint8ClampedArray(this.normalize(n,-.5,255.5))},normalizeInt(n,t,e){return this.normalize(n,t,e).map(n=>Math.round(n))},imagePromise(n){return new Promise((t,e)=>{let r=new Image;r.crossOrigin='Anonymous';r.onload=()=>t(r);r.onerror=()=>e(Error(`Could not load image ${n}`));r.src=n})},xhrPromise(n,t = 'text',e = 'GET'){return new Promise((r,o)=>{let i=new XMLHttpRequest;i.open(e,n);i.responseType=t;i.onload=()=>r(i.response);i.onerror=()=>o(Error(`Could not load ${n}: ${i.status}`));i.send()})},timeoutPromise(n = 1e3){return new Promise(t=>{setTimeout(t,n)})},async timeoutLoop(n,t = -1,e = 0){while(t--!==0)n(),await this.timeoutPromise(e)},yieldLoop(n,t = -1){function*e(){while(t--!==0)yield n()}let r=e();while(!r.next().done);},rafPromise(){return new Promise(n=>requestAnimationFrame(n))},async rafLoop(n,t = -1){while(t--!==0)n(),await this.rafPromise()},waitPromise(n,t = 10){return new Promise(e=>{function r(){if(n())return e();else setTimeout(r,t)}r()})},createCanvas(n,t){let e=document.createElement('canvas');Object.assign(e,{width:n,height:t});return e},createCtx(n,t){let e=this.createCanvas(n,t);return e.getContext('2d')},cloneCtx(n){let t=this.createCtx(n.canvas.width,n.canvas.height);t.drawImage(n.canvas,0,0);return t},resizeCtx(n,t,e){let r=this.cloneCtx(n);n.canvas.width=t;n.canvas.height=e;n.drawImage(r.canvas,0,0)},setIdentity(n){n.save();n.setTransform(1,0,0,1,0,0)},setTextParams(n,t,e = 'center',r = 'middle'){Object.assign(n,{font:t,textAlign:e,textBaseline:r})},ctxImageData(n){return n.getImageData(0,0,n.canvas.width,n.canvas.height)},fillCtxWithImage(n,t){this.setIdentity(n);n.drawImage(t,0,0,n.canvas.width,n.canvas.height);n.restore()}};class e extends Array{static fromArray(n){Object.setPrototypeOf(n,e.prototype);return n}toArray(){Object.setPrototypeOf(this,Array.prototype);return this}isEmpty(){return this.length===0}first(){return this[0]}last(){return this[this.length-1]}props(n){return this.map(t=>t[n])}values(n){return this.map(t=>n(t))}uniq(n = t.identity){t.isString(n)&&(n=t=>t[n]);return this.filter((t,e,r)=>e===0||n(t)!==n(r[e-1]))}ask(n){for(let t=0;t<this.length;t++)n(this[t],t);return this}count(n){return this.reduce((t,e)=>t+(n(e)?1:0),0)}sum(n){return this.reduce((t,e)=>t+(n?e[n]:e),0)}avg(n){return this.sum(n)/this.length}min(n){return this.reduce((t,e)=>Math.min(t,n?e[n]:e),1/0)}max(n){return this.reduce((t,e)=>Math.max(t,n?e[n]:e),-1/0)}histogram(n,r = 10,o = this.min(n),i = this.max(n)){let a=(i-o)/r,u=new e(r);u.fill(0);this.ask(e=>{let c=n?e[n]:e;if(c<o||c>i)t.warn(`histogram bounds error: ${c}: ${o}-${i}`);else{let n=Math.floor((c-o)/a);n===r&&n--;u[n]++}});u.parameters={key:n,bins:r,min:o,max:i,binSize:a,arraySize:this.length};return u}clone(n = 0,t = this.length){return this.slice(n,t)}shuffle(){return t.shuffle(this)}sortBy(n,e = !0){t.sortObjs(this,n,e);return this}remove(n,e){let r=this.agentIndex(n,e);r!==-1?this.splice(r,1):t.warn(`remove: ${n} not in AgentArray`);return this}insert(n,t){let e=this.sortedIndex(n,t);if(this[e]===n)throw Error('insert: item already in AgentArray');this.splice(e,0,n)}sortedIndex(n,e = t.identity){t.isString(e)&&(e=t.propFcn(e));let r=e(n),o=0,i=this.length;while(o<i){let n=o+i>>>1;e(this[n])<r?(o=n+1):(i=n)}return o}agentIndex(n,t){if(!t)return this.indexOf(n);let e=this.sortedIndex(n,t);return this[e]===n?e:-1}contains(n,t){return this.agentIndex(n,t)>=0}oneOf(){return t.oneOf(this)}otherOneOf(n){return t.otherOneOf(this,n)}otherNOf(n,t){if(this.length<n)throw Error('AgentArray: otherNOf: length < N');return this.clone().remove(t).shuffle().slice(0,n)}minOrMaxOf(n,e,r = !1){if(this.isEmpty())throw Error('min/max OneOf: empty array');typeof e==='string'&&(e=t.propFcn(e));let o=null,i=n?1/0:-1/0;for(let t=0;t<this.length;t++){let r=this[t],a=e(r);(n&&a<i||!n&&a>i)&&([o,i]=[r,a])}return r?[o,i]:o}minOneOf(n){return this.minOrMaxOf(!0,n)}maxOneOf(n){return this.minOrMaxOf(!1,n)}minValOf(n){return this.minOrMaxOf(!0,n,!0)}maxValOf(n){return this.minOrMaxOf(!1,n,!0)}nOf(n){if(n>this.length)throw Error('nOf: n larger than AgentArray');if(n===this.length)return this;let t=new e;while(t.length<n){let n=this.oneOf();(n in t)||t.push(n)}return t}minOrMaxNOf(n,t,e){if(t>this.length)throw Error('min/max nOf: n larger than AgentArray');let r=this.clone().sortBy(e);return n?r.clone(0,t):r.clone(r.length-t)}minNOf(n,t){return this.minOrMaxNOf(!0,n,t)}maxNOf(n,t){return this.minOrMaxNOf(!1,n,t)}inRect(n,t,r = t,o = !1){let i=new e,a=n.x-t,u=n.x+t,c=n.y-r,s=n.y+r;this.ask(t=>{a<=t.x&&t.x<=u&&c<=t.y&&t.y<=s&&((o||n!==t)&&i.push(t))});return i}inRadius(n,r,o = !1){let i=new e,a=r*r,u=t.sqDistance;this.ask(t=>{u(n.x,n.y,t.x,t.y)<=a&&((o||n!==t)&&i.push(t))});return i}inCone(n,r,o,i,a = !1){let u=new e;this.ask(e=>{t.inCone(e.x,e.y,r,o,i,n.x,n.y)&&((a||n!==e)&&u.push(e))});return u}}class r extends e{static get[Symbol.species](){return e}constructor(n,t,e,r = null){super();r=r||this;Object.assign(this,{model:n,name:e,baseSet:r,AgentClass:t});this.isBaseSet()?(this.breeds={},this.ID=0):(Object.setPrototypeOf(this,Object.getPrototypeOf(r)),this.baseSet.breeds[e]=this);this.ownVariables=[];this.agentProto=new t(this);this.protoMixin(this.agentProto,t)}protoMixin(n,t){Object.assign(n,{agentSet:this,model:this.model});n[this.baseSet.name]=this.baseSet;t.prototype.setBreed||(Object.assign(t.prototype,{setBreed(n){n.setBreed(this)},getBreed(){return this.agentSet},isBreed(n){return this.agentSet===n}}),Object.defineProperty(t.prototype,'breed',{get:function(){return this.agentSet}}))}newBreed(n){return new r(this.model,this.AgentClass,n,this)}isBreedSet(){return this.baseSet!==this}isBaseSet(){return this.baseSet===this}withBreed(n){return this.filter(t=>t.agentSet===n)}create(){console.log(`AgentSet: Abstract method called: ${this}`)}addAgent(n){n=n||Object.create(this.agentProto);this.isBreedSet()?this.baseSet.addAgent(n):(n.id=this.ID++);this.push(n);return n}clear(){while(!this.isEmpty())this.last().die()}removeAgent(n){this.isBreedSet()&&this.baseSet.remove(n,'id');this.remove(n,'id');return this}setDefault(n,t){this.agentProto[n]=t}getDefault(n){return this.agentProto[n]}settingDefault(n){return n.id==null}own(n){for(let t of n.split(' '))this.setDefault(t,null),this.ownVariables.push(t)}setBreed(n){if(n.agentSet===this)return;n.agentSet.isBreedSet()&&n.agentSet.remove(n,'id');this.isBreedSet()&&this.insert(n,'id');let t=n.agentSet.ownVariables;for(let e of t)this.ownVariables.includes(e)||delete n[e];for(let e of this.ownVariables)t.includes(e)||(n[e]=0);return Object.setPrototypeOf(n,this.agentProto)}}class o{static emptyDataSet(n,t,e){return new o(n,t,new e(n*t))}constructor(n,t,e){if(e.length!==n*t)throw Error(`new DataSet length: ${e.length} !== ${n} * ${t}`);Object.assign(this,{width:n,height:t,data:e})}setName(n){this.name=n;return this}getName(){return this.name?this.name:this.makeName()}makeName(){let{width:n,height:e}=this,r=t.arraySum(this.data).toFixed(2);return`${this.dataType().name}-${n}-${e}-${r}`}checkXY(n,t){if(!this.inBounds(n,t))throw Error(`DataSet: x,y out of range: ${n}, ${t}`)}inBounds(n,e){return t.between(n,0,this.width-1)&&t.between(e,0,this.height-1)}dataType(){return this.data.constructor}type(){return this.constructor}toIndex(n,t){return n+t*this.width}toXY(n){return[n%this.width,Math.floor(n/this.width)]}getXY(n,t){return this.data[this.toIndex(n,t)]}setXY(n,t,e){this.data[this.toIndex(n,t)]=e}sample(n,t,e = !0){this.checkXY(n,t);return e?this.nearest(n,t):this.bilinear(n,t)}nearest(n,t){return this.getXY(Math.round(n),Math.round(t))}bilinear(n,t){let e=Math.floor(n),r=Math.floor(t),o=this.toIndex(e,r),i=this.width,a=n-e,u=t-r,c=1-a,s=1-u,f=this.data[o],d=this.data[o+1]||0,l=this.data[o+i]||0,h=this.data[o+1+i]||0;return f*c*s+d*a*s+l*c*u+h*a*u}copy(){return new o(this.width,this.height,t.clone(this.data))}emptyDataSet(n,t,e = this.dataType()){return o.emptyDataSet(n,t,e)}emptyArray(n){let t=this.type();return new t(n)}resample(n,t,e = !0,r = Array){if(n===this.width&&t===this.height)return this.copy();let i=o.emptyDataSet(n,t,r),a=(this.width-1)/(n-1),u=(this.height-1)/(t-1);for(let r=0;r<t;r++)for(let t=0;t<n;t++)i.setXY(t,r,this.sample(t*a,r*u,e));return i}scale(n,t){let e=this.min(),r=this.max(),o=r-e,i=t-n,a=i/o,u=n-a*e;return this.map(n=>a*n+u)}subset(n,t,e,r){if(n+e>this.width||t+r>this.height)throw Error('DataSet.subSet: params out of range');let o=this.emptyDataSet(e,r);for(let i=0;i<e;i++)for(let e=0;e<r;e++)o.setXY(i,e,this.getXY(i+n,e+t));return o}map(n){return new o(this.width,this.height,this.data.map(n))}col(n){let[t,e,r]=[this.width,this.height,this.data];if(n>=t)throw Error(`col: x out of range width: ${t} x: ${n}`);let o=this.emptyArray(e);for(let i=0;i<e;i++)o[i]=r[n+i*t];return o}row(n){let[t,e]=[this.width,this.height];if(n>=e)throw Error(`row: y out of range height: ${e} x: ${n}`);return this.data.slice(n*t,(n+1)*t)}convertType(n){this.data=t.convertArray(this.data,n)}concatEast(n){let[t,e]=[this.width,this.height],[r,o]=[n.width,n.height];if(e!==o)throw Error(`concatEast: heights not equal ${e}, ${o}`);let i=this.emptyDataSet((t+r),e);for(let n=0;n<e;n++)for(let e=0;e<t;e++)i.setXY(n,e,this.getXY(n,e));for(let e=0;e<o;e++)for(let o=0;o<r;o++)i.setXY(e+t,o,n.getXY(e,o));return i}concatSouth(n){let[e,r,i]=[this.width,this.height,this.data];if(e!==n.width)throw Error(`concatSouth: widths not equal ${e}, ${n.width}`);let a=t.concatArrays(i,n.data);return new o(e,r+n.height,a)}transformCoords(n,t,e,r,o,i){let a=(n-e)*(this.width-1)/o,u=(r-t)*(this.height-1)/i;return[a,u]}coordSample(n,t,e,r,o,i,a = !0){let[u,c]=this.transformCoords(n,t,e,r,o,i);return this.sample(u,c,a)}neighborhood(n,e,r = []){r.length=0;let o=n===0||n===this.width-1||e===0||e===this.height-1;for(let i=-1;i<=1;i++){for(let a=-1;a<=1;a++){let u=n+a,c=e+i;o&&(u=t.clamp(u,0,this.width-1),c=t.clamp(c,0,this.height-1));r.push(this.data[this.toIndex(u,c)])}}return r}convolve(n,t = 1,e = !1){let[r,o,i,a]=e?[1,1,this.height-1,this.width-1]:[0,0,this.height,this.width],u=this.emptyDataSet(a,i),c=u.data,s=0;for(let e=o;e<i;e++){for(let o=r;o<a;o++){let r=this.neighborhood(o,e),i=0;for(let t=0;t<n.length;t++)i+=n[t]*r[t];c[s++]=i*t}}return u}dzdx(n = 2,t = .125){return this.convolve([-1,0,1,-n,0,n,-1,0,1],t)}dzdy(n = 2,t = .125){return this.convolve([1,n,1,0,0,0,-1,-n,-1],t)}laplace8(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])}laplace4(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])}blur(n = .0625){return this.convolve([1,2,1,2,4,2,1,2,1],n)}edge(){return this.convolve([1,1,1,1,-7,1,1,1,1])}slopeAndAspect(n = 1,e = !0){let r=this.dzdx(),i=this.dzdy(),[a,u]=[[],[]],[c,s]=[r.height,r.width];for(let o=0;o<c;o++){for(let c=0;c<s;c++){let[s,f]=[r.getXY(c,o),i.getXY(c,o)];u.push(Math.atan(t.distance(0,0,s,f))/n);let d=Math.atan2(-f,-s);e&&d<0&&(d+=2*Math.PI);a.push(d)}}u=new o(s,c,u);a=new o(s,c,a);return{slope:u,aspect:a,dzdx:r,dzdy:i}}max(){return t.arrayMax(this.data)}min(){return t.arrayMin(this.data)}equals(n){return this.width===n.width&&this.height===n.height&&t.arraysEqual(this.data,n.data)}}class i{static defaultVariables(){return{end0:null,end1:null,width:1}}constructor(){Object.assign(this,i.defaultVariables())}init(n,t){this.end0=n;this.end1=t;n.links.push(this);t.links.push(this)}die(){this.agentSet.removeAgent(this);t.removeArrayItem(this.end0.links,this);t.removeArrayItem(this.end1.links,this)}bothEnds(){return[this.end0,this.end1]}length(){return this.end0.distance(this.end1)}otherEnd(n){if(n===this.end0)return this.end1;if(n===this.end1)return this.end0;throw Error(`Link.otherEnd: turtle not a link turtle: ${n}`)}}class a extends r{create(n,t,e = n=>{}){Array.isArray(t)||(t=[t]);return t.map(t=>{let r=this.addAgent();r.init(n,t);e(r);return r})}}class u{static defaultOptions(n = 16,t = n){return{minX:-n,maxX:n,minY:-t,maxY:t}}constructor(n = {}){Object.assign(this,u.defaultOptions());Object.assign(this,n);this.setWorld()}setWorld(){this.numX=this.maxX-this.minX+1;this.numY=this.maxY-this.minY+1;this.width=this.numX;this.height=this.numY;this.minXcor=this.minX-.5;this.maxXcor=this.maxX+.5;this.minYcor=this.minY-.5;this.maxYcor=this.maxY+.5;this.centerX=(this.minX+this.maxX)/2;this.centerY=(this.minY+this.maxY)/2}isOnWorld(n,t){return this.minXcor<=n&&n<=this.maxXcor&&this.minYcor<=t&&t<=this.maxYcor}setCtxTransform(n,t){n.canvas.width=this.width*t;n.canvas.height=this.height*t;n.save();n.scale(t,-t);n.translate(-(this.minXcor*t),-(this.maxYcor*t))}}class c extends r{constructor(n,t,e){super(n,t,e);if(this.isBreedSet())return;this.populate();this.labels=[]}populate(){t.repeat(this.model.world.numX*this.model.world.numY,n=>{this.addAgent()})}setDefault(n,e){n==='color'?(this.ask(n=>{n.setColor(e)}),t.logOnce("patches.setDefault(color, value): color default not supported. Clearing to value")):super.setDefault(n,e)}setLabel(n,t){t==null?delete this.labels[n.id]:(this.labels[n.id]=t)}getLabel(n){return this.labels[n.id]}neighborsOffsets(n,t){let{minX:e,maxX:r,minY:o,maxY:i,numX:a}=this.model.world;if(n===e){if(t===o)return[-a,-a+1,1];if(t===i)return[1,a+1,a];return[-a,-a+1,1,a+1,a]}if(n===r){if(t===o)return[-a-1,-a,-1];if(t===i)return[a,a-1,-1];return[-a-1,-a,a,a-1,-1]}if(t===o)return[-a-1,-a,-a+1,1,-1];if(t===i)return[1,a+1,a,a-1,-1];return[-a-1,-a,-a+1,1,a+1,a,a-1,-1]}neighbors4Offsets(n,t){let e=this.model.world.numX;return this.neighborsOffsets(n,t).filter(n=>Math.abs(n)===1||Math.abs(n)===e)}neighbors(n){let{id:t,x:r,y:o}=n,i=this.neighborsOffsets(r,o),a=new e(i.length);i.forEach((n,e)=>{a[e]=this[n+t]});return a}neighbors4(n){let{id:t,x:r,y:o}=n,i=this.neighbors4Offsets(r,o),a=new e(i.length);i.forEach((n,e)=>{a[e]=this[n+t]});return a}randomPt(){let{minX:n,maxX:e,minY:r,maxY:o}=this.model.world;return[t.randomInt2(n,e),t.randomInt2(r,o)]}importDataSet(n,e,r = !1){if(this.isBreedSet()){t.warn('Patches: exportDataSet called with breed, using patches');this.baseSet.importDataSet(n,e,r);return}let{numX:o,numY:i}=this.model.world,a=n.resample(o,i,r);this.ask(n=>{n[e]=a.data[n.id]})}exportDataSet(n,e = Array){if(this.isBreedSet()){t.warn('Patches: exportDataSet called with breed, using patches');return this.baseSet.exportDataSet(n,e)}let{numX:r,numY:i}=this.model.world,a=this.props(n);a=t.convertArray(a,e);return new o(r,i,a)}patchIndex(n,t){let{minX:e,maxY:r,numX:o}=this.model.world;return n-e+o*(r-t)}patch(n,t){if(!this.model.world.isOnWorld(n,t))return void 0;let e=n===this.model.world.maxXcor?this.model.world.maxX:Math.round(n),r=t===this.model.world.maxYcor?this.model.world.maxY:Math.round(t);return this.patchXY(e,r)}patchXY(n,t){return this[this.patchIndex(n,t)]}patchRect(n,t,r = t,o = !0){if(n.rectCache){let e=this.cacheIndex(t,r,o),i=n.rectCache[e];if(i)return i}let i=new e,{minX:a,maxX:u,minY:c,maxY:s}=this.model.world;a=Math.max(a,n.x-t);u=Math.min(u,n.x+t);c=Math.max(c,n.y-r);s=Math.min(s,n.y+r);for(let t=c;t<=s;t++){for(let e=a;e<=u;e++){let r=this.patchXY(e,t);(n!==r||o)&&i.push(r)}}return i}patchRectXY(n,t,e,r = e,o = !0){return this.patchRect(this.patch(n,t),e,r,o)}cacheIndex(n,t = n,e = !0){return(2*n+1)*(2*t+1)+(e?0:-1)}cacheRect(n,t = n,e = !0,r = !0){let o=this.cacheIndex(n,t,e);this.ask(i=>{(!i.rectCache||r)&&(i.rectCache=[]);let a=this.inRect(i,n,t,e);i.rectCache[o]=a})}inRect(n,t,e = t,r = !0){let o=this.patchRect(n,t,e,r);if(this.isBaseSet())return o;return o.withBreed(this)}inRadius(n,t,e = !0){let r=this.inRect(n,t,t,e);return r.inRadius(n,t,e)}inCone(n,t,e,r,o = !0){let i=this.inRect(n,t,t,o);return i.inCone(n,t,e,r,o)}patchAtDirectionAndDistance(n,t,e){let{x:r,y:o}=n;r+=e*Math.cos(t);o+=e*Math.sin(t);return this.patch(r,o)}diffuse(n,t){this.diffuseN(8,n,t)}diffuse4(n,t){this.diffuseN(4,n,t)}diffuseN(n,t,e){if(this[0]._diffuseNext===void 0)for(let n=0;n<this.length;n++)this[n]._diffuseNext=0;for(let r=0;r<this.length;r++){let o=this[r],i=o[t]*e,a=i/n,u=n===8?o.neighbors:o.neighbors4,c=u.length;o._diffuseNext+=o[t]-i+(n-c)*a;for(let n=0;n<u.length;n++)u[n]._diffuseNext+=a}for(let n=0;n<this.length;n++){let e=this[n];e[t]=e._diffuseNext;e._diffuseNext=0}}}class s{static defaultVariables(){return{turtles:void 0}}constructor(){Object.assign(this,s.defaultVariables())}get x(){return this.id%this.model.world.numX+this.model.world.minX}get y(){return this.model.world.maxY-Math.floor(this.id/this.model.world.numX)}isOnEdge(){let{x:n,y:t,model:e}=this,{minX:r,maxX:o,minY:i,maxY:a}=e.world;return n===r||n===o||t===i||t===a}get neighbors(){let n=this.patches.neighbors(this);Object.defineProperty(this,'neighbors',{value:n,enumerable:!0});return n}get neighbors4(){let n=this.patches.neighbors4(this);Object.defineProperty(this,'neighbors4',{value:n,enumerable:!0});return n}turtlesHere(){this.turtles==null&&(this.patches.ask(n=>{n.turtles=[]}),this.model.turtles.ask(n=>{n.patch.turtles.push(n)}));return this.turtles}breedsHere(n){let t=this.turtlesHere();return t.withBreed(n)}distanceXY(n,e){return t.distance(this.x,this.y,n,e)}distance(n){return this.distanceXY(n.x,n.y)}towards(n){return this.towardsXY(n.x,n.y)}towardsXY(n,e){return t.radiansToward(this.x,this.y,n,e)}patchAt(n,t){return this.patches.patch(this.x+n,this.y+t)}patchAtDirectionAndDistance(n,t){return this.patches.patchAtDirectionAndDistance(this,n,t)}sprout(n = 1,t = this.model.turtles,e = n=>{}){return t.create(n,n=>{n.setxy(this.x,this.y),e(n)})}}class f extends r{create(n = 1,e = n=>{}){return t.repeat(n,(n,r)=>{let o=this.addAgent();o.theta=t.randomFloat(Math.PI*2);e(o);r.push(o)})}randomPt(){let{minXcor:n,maxXcor:e,minYcor:r,maxYcor:o}=this.model.world;return[t.randomFloat2(n,e),t.randomFloat2(r,o)]}inPatches(n){let t=new e;for(let e of n)t.push(...e.turtlesHere());this.isBreedSet()&&(t=t.filter(n=>n.agentSet===this));return t}inPatchRect(n,e,r = e,o = !1){let i=this.model.patches.inRect(n.patch,e,r,!0),a=this.inPatches(i);o||t.removeArrayItem(a,n);return a}inRadius(n,t,e = !1){let r=this.inPatchRect(n,t,t,!0);return r.inRadius(n,t,e)}inCone(n,t,e,r = !1){let o=this.inPatchRect(n,t,t,!0);return o.inCone(n,t,e,n.theta,r)}layoutCircle(n,t = [0,0],e = Math.PI/2,r = -1){let o=2*Math.PI/this.length,[i,a]=t;this.ask((t,u)=>{t.setxy(i,a),t.theta=e+r*o*u,t.forward(n)})}}class d{static defaultVariables(){return{x:0,y:0,z:0,theta:0,atEdge:'clamp'}}constructor(){Object.assign(this,d.defaultVariables())}die(){this.agentSet.removeAgent(this);if(this.hasOwnProperty('links'))while(this.links.length>0)this.links[0].die();this.patch.turtles!=null&&t.removeArrayItem(this.patch.turtles,this)}hatch(n = 1,t = this.agentSet,e = n=>{}){return t.create(n,n=>{n.setxy(this.x,this.y);for(let e of t.ownVariables)n[e]==null&&(n[e]=this[e]);e(n)})}get links(){Object.defineProperty(this,'links',{value:new e(0),enumerable:!0});return this.links}get patch(){return this.model.patches.patch(this.x,this.y)}get heading(){return t.heading(this.theta)}set heading(n){this.theta=t.angle(n)}get direction(){return this.theta}set direction(n){this.theta=n}setxy(n,e,r = null){let o=this.patch;r!=null&&(this.z=r);this.model.world.isOnWorld(n,e)?(this.x=n,this.y=e):this.handleEdge(n,e);let i=this.patch;i.turtles!=null&&i!==o&&(t.removeArrayItem(o.turtles,this),i.turtles.push(this))}handleEdge(n,e){if(t.isString(this.atEdge)){let{minXcor:r,maxXcor:o,minYcor:i,maxYcor:a}=this.model.world;if(this.atEdge==='wrap')this.x=t.wrap(n,r,o),this.y=t.wrap(e,i,a);else if(this.atEdge==='clamp'||this.atEdge==='bounce')this.x=t.clamp(n,r,o),this.y=t.clamp(e,i,a),this.atEdge==='bounce'&&(this.x===r||this.x===o?(this.theta=Math.PI-this.theta):(this.theta=-this.theta));else{throw Error(`turtle.handleEdge: bad atEdge: ${this.atEdge}`)}}else this.atEdge(this)}moveTo(n){this.setxy(n.x,n.y)}forward(n){this.setxy(this.x+n*Math.cos(this.theta),this.y+n*Math.sin(this.theta))}rotate(n){this.theta=t.mod(this.theta+n,Math.PI*2)}right(n){this.rotate(-n)}left(n){this.rotate(n)}face(n){this.theta=this.towards(n)}faceXY(n,t){this.theta=this.towardsXY(n,t)}patchAhead(n){return this.patchAtDirectionAndDistance(this.theta,n)}canMove(n){return this.patchAhead(n)!=null}patchLeftAndAhead(n,t){return this.patchAtDirectionAndDistance(n+this.theta,t)}patchRightAndAhead(n,t){return this.patchAtDirectionAndDistance(n-this.theta,t)}distanceXY(n,e){return t.distance(this.x,this.y,n,e)}distance(n){return t.distance(this.x,this.y,n.x,n.y)}towards(n){return this.towardsXY(n.x,n.y)}towardsXY(n,e){return t.radiansToward(this.x,this.y,n,e)}patchAt(n,t){return this.model.patches.patch(this.x+n,this.y+t)}patchAtDirectionAndDistance(n,t){return this.model.patches.patchAtDirectionAndDistance(this,n,t)}otherEnd(n){return n.end0===this?n.end1:n.end0}linkNeighbors(){return this.links.map(n=>this.otherEnd(n))}}class l{static defaultWorld(n = 16,t = n){return u.defaultOptions(n,t)}constructor(n = l.defaultWorld()){this.worldOptions=n;this.resetModel()}initAgentSet(n,t,e){let r=new t(this,e,n);this[n]=r}resetModel(){this.world=new u(this.worldOptions);this.initAgentSet('patches',c,s);this.initAgentSet('turtles',f,d);this.initAgentSet('links',a,i)}reset(){this.resetModel()}setup(){}step(){}patchBreeds(n){for(let t of n.split(' '))this[t]=this.patches.newBreed(t)}turtleBreeds(n){for(let t of n.split(' '))this[t]=this.turtles.newBreed(t)}linkBreeds(n){for(let t of n.split(' '))this[t]=this.links.newBreed(t)}}class h extends o{static scaleFromMinMax(n,t){return(t-n)/16777215}constructor(n,e = 0,r = 1,o = Float32Array){super(n.width,n.height,new o(n.width*n.height));let i=t.createCtx(n.width,n.height);t.fillCtxWithImage(i,n);let a=t.ctxImageData(i),u=this.data;for(var c=0;c<u.length;c++){let n=a.data[4*c],t=a.data[4*c+1],o=a.data[4*c+2];u[c]=e+(n*256*256+t*256+o)*r}}}n.AgentArray=e;n.AgentSet=r;n.DataSet=o;n.Link=i;n.Links=a;n.Model=l;n.Patch=s;n.Patches=c;n.RGBDataSet=h;n.Turtle=d;n.Turtles=f;n.World=u;n.util=t;Object.defineProperty(n,'__esModule',{value:!0})}))
