const{PI:t,atan:e,atan2:n,cos:r,floor:s,log:i,pow:a,sin:o,sinh:h,sqrt:c,tan:u}=Math,l=e=>e*t/180,d=e=>180*e/t;var f=Object.freeze({lon2x:function(t,e){return s((t+180)/360*a(2,e))},lat2y:function(e,n){const o=l(e);return s((1-i(u(o)+1/r(o))/t)*a(2,n-1))},lonlat2xy:function(t,e,n){return[this.lon2x(t,n),this.lat2y(e,n)]},x2lon:function(t,e){return t/a(2,e)*360-180},y2lat:function(n,r){const s=e(h(t-2*t*n/a(2,r)));return d(s)},xy2lonlat:function(t,e,n){return[this.x2lon(t,n),this.y2lat(e,n)]},xy2bbox:function(t,e,n){const[r,s]=this.xy2lonlat(t,e,n),[i,a]=this.xy2lonlat(t+1,e+1,n);return[r,a,i,s]},lonLat2bbox:function(t,e,n){const[r,s]=this.lonlat2xy(t,e,n);return this.xy2bbox(r,s,n)},bboxCenter:function(t){const[e,n,r,s]=t;return[(e+r)/2,(n+s)/2]},bboxCoords:function(t){const[e,n,r,s]=t;return[[e,s],[r,s],[r,n],[e,n]]},getOsmURL:function(t,e,n,r){return"https://overpass-api.de/api/interpreter?data="+encodeURIComponent(`[out:json][timeout:180][bbox:${t}${e}${n}${r}];\nway[highway];\n(._;>;);\nout;`)},lonLat2meters:function(t,e){const[s,i]=t.map(t=>l(t)),[a,h]=e.map(t=>l(t)),u=a-s,d=o((h-i)/2)**2+r(i)*r(h)*o(u/2)**2;return 2*n(c(d),c(1-d))*6378.137*1e3},cloneJson:function(t){return JSON.parse(JSON.stringify(t))},areEqual:function(t,e){return JSON.stringify(t)===JSON.stringify(e)},minify:function(t){return JSON.stringify(t).replace(/,{"type":"Feature"/g,'\n,\n{"type":"Feature"')}});function m(t,e="text",n="GET"){return new Promise((r,s)=>{const i=new XMLHttpRequest;i.open(n,t),i.responseType=e,i.onload=()=>r(i.response),i.onerror=()=>s(Error(`Could not load ${t}: ${i.status}`)),i.send()})}function g(t=1e3){return new Promise(e=>{setTimeout(e,t)})}async function p(t,e=-1,n=0){let r=0;for(;r++!==e;)t(r-1),await g(n)}function y(){return new Promise(t=>requestAnimationFrame(t))}var w=Object.freeze({imagePromise:function(t){return new Promise((e,n)=>{const r=new Image;r.crossOrigin="Anonymous",r.onload=()=>e(r),r.onerror=()=>n(`Could not load image ${t}`),r.src=t})},imageBitmapPromise:async function(t){const e=await m(t,"blob");return createImageBitmap(e)},canvasBlobPromise:function(t,e="image/png",n=.95){return new Promise((r,s)=>{t.toBlob(t=>r(t),e,n)})},xhrPromise:m,timeoutPromise:g,timeoutLoop:p,yieldLoop:function(t,e=-1){let n=0;const r=function*(){for(;n++!==e;)yield t(n-1)}();for(;!r.next().done;);},rafPromise:y,rafLoop:async function(t,e=-1){let n=0;for(;n++!==e;)t(n-1),await y()},waitPromise:function(t,e=10){return new Promise(n=>{!function r(){if(t())return n();setTimeout(r,e)}()})}});function x(){return window.location.search.substr(1)}function b(t=x()){const e={},n=new URLSearchParams(t);for(var r of n.entries()){let[t,n]=r;(n.match(/^[0-9.]+$/)||n.match(/^[0-9.]+e[0-9]+$/))&&(n=Number(n)),["true","t",""].includes(n)&&(n=!0),["false","f"].includes(n)&&(n=!1),e[t]=n}return e}function O(t,e={}){return new Promise((n,r)=>{const s=document.createElement("script");s.onload=()=>n(s),s.src=t,Object.assign(s,e),document.querySelector("head").appendChild(s)})}function A(){return!S()&&void 0===self.window}function S(){return"undefined"!=typeof global}var E=Object.freeze({getQueryString:x,parseQueryString:b,RESTapi:function(t){return Object.assign(t,b())},loadScript:O,inWorker:A,inNode:S,printToPage:function(t,e=document.body){"object"==typeof t&&(t=JSON.stringify(t,null,2)),t="<pre>"+t+"</pre>","string"==typeof e&&(e=document.getElementById(e)),e.style.fontFamily="monospace",e.innerHTML+=t+"<br />"},fcnToWorker:function(t){const e=document.location.href.replace(/\/[^\/]+$/,"/"),n=`(${t.toString(e)})("${e}")`,r=URL.createObjectURL(new Blob([n],{type:"text/javascript"})),s=new Worker(r);return s.onerror=function(t){console.log("Worker ERROR: Line ",t.lineno,": ",t.message)},s},workerScript:function(t,e){const n=new Blob([t],{type:"text/javascript"}),r=URL.createObjectURL(n);e.postMessage({cmd:"script",url:r})},getEventXY:function(t,e){const n=t.getBoundingClientRect();return[e.clientX-n.left,e.clientY-n.top]}});function M(){return A()}function v(t,e,n=M()){if(n)return new OffscreenCanvas(t,e);const r=document.createElement("canvas");return r.width=t,r.height=e,r}function X(t,e,n=M()){return v(t,e,n).getContext("2d")}function Y(t,e=M()){const n=X(t.width,t.height,e);return n.drawImage(t,0,0),n.canvas}function P(t,e,n){t.width===e&&t.height==n||(t.width=e,t.height=n)}function R(t){t.save(),t.setTransform(1,0,0,1,0,0)}function k(t,e){R(t),t.drawImage(e,0,0,t.canvas.width,t.canvas.height),t.restore()}const T=null;var I=Object.freeze({createCanvas:v,createCtx:X,cloneCanvas:Y,resizeCtx:function(t,e,n){const r=Y(t.canvas);t.canvas.width=e,t.canvas.height=n,t.drawImage(r,0,0)},setCanvasSize:P,setIdentity:R,setTextProperties:function(t,e,n="center",r="middle"){Object.assign(t,{font:e,textAlign:n,textBaseline:r})},drawText:function(t,e,n,r,s,i=!0){i&&R(t),t.fillStyle=s.css||s,t.fillText(e,n,r),i&&t.restore()},ctxImageData:function(t){return t.getImageData(0,0,t.canvas.width,t.canvas.height)},clearCtx:function(t,e){const{width:n,height:r}=t.canvas;R(t),e&&"transparent"!==e?(t.fillStyle=e,t.fillRect(0,0,n,r)):t.clearRect(0,0,n,r),t.restore()},fillCtxWithImage:k,setCtxImage:function(t,e){P(t.canvas,e.width,e.height),k(t,e)},imageToBytes:function(t,e=!1,n="RGBA"){if(!T){const t=v(0,0);T=t.getContext("webgl",{premultipliedAlpha:!1})}const{width:r,height:s}=t,i=T;Object.assign(i.canvas,{width:r,height:s});const a=i[n],o=i.createTexture();i.bindTexture(i.TEXTURE_2D,o),e&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,i.NONE),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i.texImage2D(i.TEXTURE_2D,0,a,a,i.UNSIGNED_BYTE,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST);const h=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,h),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,o,0);const c=i.checkFramebufferStatus(i.FRAMEBUFFER);if(c!==i.FRAMEBUFFER_COMPLETE)throw Error(`imageToBytes: status not FRAMEBUFFER_COMPLETE: ${c}`);const u=new Uint8Array(("RGB"===n?3:4)*r*s);return i.readPixels(0,0,r,s,a,i.UNSIGNED_BYTE,u),i.bindFramebuffer(i.FRAMEBUFFER,null),u}});let $;function j(t){$||($=new Set),$.has(t)||(console.log(t),$.add(t))}var B=Object.freeze({logOnce:j,warn:function(t){j("Warning: "+t)},timeit:function(t,e=1e5,n="test"){n=n+"-"+e,console.time(n);for(let n=0;n<e;n++)t(n);console.timeEnd(n)},fps:function(){const t="undefined"==typeof performance?Date:performance,e=t.now();let n=0;function r(){n++;const s=t.now()-e,i=parseFloat((n/(s/1e3)).toFixed(2));Object.assign(r,{fps:i,ms:s,start:e,steps:n})}return r.steps=0,r},pps:function(t,e=""){e&&console.log(e);let n=1,r="";for(;t;){if("function"==typeof t)r=t.constructor.toString();else{const e=Object.keys(t);r=e.length>0?`[${e.join(", ")}]`:`[${t.constructor.name}]`}console.log(`[${n++}]: ${r}`),t=Object.getPrototypeOf(t)}},toWindow:function(t,e=!1){Object.assign(window,t),console.log("toWindow:",Object.keys(t).join(", ")),e&&Object.keys(t).forEach(e=>console.log("  ",e,t[e]))},dump:function(t=window.model){let{patches:e,turtles:n,links:r}=t;Object.assign(window,{ps:e,ts:n,ls:r}),window.p=e.length>0?e.oneOf():{},window.t=n.length>0?n.oneOf():{},window.l=r.length>0?r.oneOf():{}}});const{PI:N}=Math,C=t=>Math.floor(Math.random()*t),D=(t,e)=>t+Math.random()*(e-t);function F(t=N/4){return()=>{const e=1e4*Math.sin(t++);return e-Math.floor(e)}}function z(t=123456){return t%=2147483647,()=>((t=16807*t%2147483647)-1)/2147483646}function L(t,e=!0){Math.random=e?z(t):F(t)}const U=(t,e)=>(t%e+e)%e;function _(t,e,n){return t<e?e:t>n?n:t}const W=180/N,q=N/180,V=t=>t*q,J=t=>t*W,H=t=>Array.isArray(t)?t.map(t=>H(t)):t*(Math.PI/180),Z=t=>Array.isArray(t)?t.map(t=>Z(t)):t*(180/Math.PI);function G(t){const e=J(t);return U(90-e,360)}function K(t){return U(t,360)}function Q(t){return U(t,2*N)}function tt(t,e){let n=Q(t-e);return n>N&&(n-=2*N),n}const et=(t,e,n,r)=>Math.atan2(r-e,n-t);const nt=(t,e,n,r)=>(t-n)*(t-n)+(e-r)*(e-r);var rt=Object.freeze({randomInt:C,randomInt2:(t,e)=>t+Math.floor(Math.random()*(e-t)),randomFloat:t=>Math.random()*t,randomFloat2:D,randomCentered:t=>D(-t/2,t/2),randomNormal:function(t=0,e=1){const[n,r]=[1-Math.random(),Math.random()];return Math.sqrt(-2*Math.log(n))*Math.cos(2*N*r)*e+t},randomSeedSin:F,randomSeedParkMiller:z,randomSeed:L,precision:function(t,e=4){if(Array.isArray(t))return t.map(t=>this.precision(t,e));const n=10**e;return Math.round(t*n)/n},isPowerOf2:t=>0==(t&t-1),nextPowerOf2:t=>Math.pow(2,Math.ceil(Math.log2(t))),mod:U,wrap:(t,e,n)=>e+U(t-e,n-e),clamp:_,between:(t,e,n)=>e<=t&&t<=n,lerp:(t,e,n)=>t<=e?t+(e-t)*n:t-(t-e)*n,lerpScale:function(t,e,n){if(e===n)throw Error("lerpScale: lo === hi");return((t=_(t,e,n))-e)/(n-e)},radians:V,degrees:J,degToRad:H,radToDeg:Z,heading:G,angle:function(t){const e=U(90-t,360);return V(e)},modHeading:K,modAngle:Q,headingsEqual:function(t,e){return K(t)===K(e)},anglesEqual:function(t,e){return Q(t)===Q(e)},subtractRadians:tt,subtractHeadings:function(t,e){let n=K(t-e);return n>180&&(n-=360),n},radiansToward:et,headingToward:function(t,e,n,r){return G(et(t,e,n,r))},distance:(t,e,n,r)=>Math.sqrt(nt(t,e,n,r)),sqDistance:nt,inCone:function(t,e,n,r,s,i,a){if(nt(i,a,t,e)>n*n)return!1;const o=et(i,a,t,e);return r/2>=Math.abs(tt(s,o))}});const st=t=>e=>e[t];const it=t=>t.reduce((t,e)=>Math.max(t,e)),at=t=>t.reduce((t,e)=>Math.min(t,e));function ot(t,e){if(t.slice)for(let n=0,r=t.length;n<r;n++)e(t[n],n,t);else Object.keys(t).forEach(n=>e(t[n],n,t))}function ht(t,e,n=[]){for(let r=0;r<t;r++)e(r,n);return n}const ct=t=>t[C(t.length)];const ut=t=>ct(Object.keys(t));function lt(t,e,n){if(n<=1)throw Error("floatRamp: numItems must be > 1");const r=[];for(let s=0;s<n;s++)r.push(t+s/(n-1)*(e-t));return r}function dt(t,e=0,n=1){const[r,s]=[at(t),it(t)],i=1/(s-r);return t.map(t=>lerp(e,n,i*(t-r)))}var ft=Object.freeze({identityFcn:t=>t,noopFcn:()=>{},propFcn:st,nestedProperty:function(t,e){switch("string"==typeof e&&(e=e.split(".")),e.length){case 1:return t[e[0]];case 2:return t[e[0]][e[1]];case 3:return t[e[0]][e[1]][e[2]];case 4:return t[e[0]][e[1]][e[2]][e[3]];default:return e.reduce((t,e)=>t[e],t)}},arrayFirst:t=>t[0],arrayLast:t=>t[t.length-1],arrayMax:it,arrayMin:at,arrayExtent:t=>[at(t),it(t)],arraySum:t=>t.reduce((t,e)=>t+e,0),arraysEqual:function(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0},removeArrayItem:function(t,e){const n=t.indexOf(e);return-1!==n?t.splice(n,1):console.log(`removeArrayItem: ${e} not in array`),t},arraysToString:t=>t.map(t=>`${t}`).join(","),forLoop:ot,repeat:ht,step:function(t,e,n){for(let r=0;r<t;r+=e)n(r)},range:function(t){return ht(t,(t,e)=>{e[t]=t})},clone:function(t){return t.slice?array.slice(0):Object.assign({},t)},assign:function(t,e,n){return"string"==typeof n&&(n=n.split(" ")),ot(n,n=>{t[n]=e[n]}),t},override:function(t,e){const n=t;return ot(t,(t,r)=>{e[r]&&(n[r]=e[r])}),n},concatArrays:function(t,e){const n=t.constructor;if(n===Array)return t.concat(convertArrayType(e,Array));const r=new n(t.length+e.length);return r.set(t),r.set(e,t.length),r},objectToString:function(t,e=2,n=!0){let r=JSON.stringify(t,null,e);return n&&(r=r.replace(/"([^"]+)":/gm,"$1:")),r},objectsEqual:(t,e)=>JSON.stringify(t)===JSON.stringify(e),histogram:function(t,e=10,n=at(t),r=it(t)){const s=(r-n)/e,i=new Array(e);return i.fill(0),ot(t,t=>{if(t<n||t>r)throw Error(`histogram bounds error: ${t}: ${n}-${r}`);{let r=Math.floor((t-n)/s);r===e&&r--,i[r]++}}),i.parameters={bins:e,min:n,max:r,binSize:s,arraySize:t.length},i},oneOf:ct,otherOneOf:function(t,e){if(t.length<2)throw Error("otherOneOf: array.length < 2");do{var n=ct(t)}while(e===n);return n},oneKeyOf:ut,oneValOf:t=>t[ut(t)],sortNums:function(t,e=!0){return t.sort((t,n)=>e?t-n:n-t)},sortObjs:function(t,e,n=!0){"string"==typeof e&&(e=st(e));const r=(t,n)=>e(t)-e(n);return t.sort((t,e)=>n?r(t,e):-r(t,e))},shuffle:function(t){for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1)),r=t[e];t[e]=t[n],t[n]=r}return t},uniq:t=>Array.from(new Set(t)),union:function(t,e){return Array.from(new Set(t.concat(e)))},intersection:function(t,e){const n=new Set(e);return t.filter(t=>n.has(t))},difference:function(t,e){const n=new Set(e);return t.filter(t=>!n.has(t))},floatRamp:lt,integerRamp:function(t,e,n=Math.abs(e-t)+1){return lt(t,e,n).map(t=>Math.round(t))},normalize:dt,normalize8:function(t){return new Uint8ClampedArray(dt(t,-.5,255.5))},normalizeInt:function(t,e,n){return dt(t,e,n).map(t=>Math.round(t))}});function mt(t){const e=function(t,e=0,n=!0){let r=n;const s=["rectCache"];return JSON.stringify(t,(t,e)=>{if(!s.includes(t))return Array.isArray(e)&&e.length>0&&Number.isInteger(e[0].id)&&!r?e.map(t=>t.id):(r=!1,e)},e)}({ticks:t.ticks,model:Object.keys(t),patches:t.patches.length,patch:t.patches.oneOf(),turtles:t.turtles.length,turtle:t.turtles.oneOf(),links:t.links.length,link:t.links.oneOf()});return JSON.parse(e)}var gt=Object.freeze({sampleModel:mt,runModel:async function(t){var e=A();const n=e?"worker ":"main ";console.log(n+"params",t),e?importScripts(t.classPath):await O(t.classPath),t.seed&&L();const r=new defaultModel;return console.log(n+"model",r),await r.startup(),r.setup(),e?ht(t.steps,()=>{r.step()}):await p(()=>{r.step()},t.steps),console.log(n+"done, model",r),mt(r)}});const pt=t=>({}).toString.call(t).match(/\s(\w+)/)[1].toLowerCase(),yt=(t,e)=>pt(t)===e,wt=(t,e)=>e.includes(pt(t)),xt=t=>yt(t,"object"),bt=t=>yt(t,"number"),Ot=t=>"arraybuffer"===pt(t.buffer);var At=Object.freeze({typeOf:pt,isType:yt,isOneOfTypes:wt,isString:t=>yt(t,"string"),isObject:xt,isArray:t=>Array.isArray(t),isNumber:bt,isFunction:t=>yt(t,"function"),isInteger:t=>Number.isInteger(t),isFloat:t=>bt(t)&&t%1!=0,isCanvas:t=>wt(t,["htmlcanvaselement","offscreencanvas"]),isImageable:t=>wt(t,["image","htmlimageelement","htmlcanvaselement","offscreencanvas","imagebitmap"]),isTypedArray:Ot,isUintArray:t=>/^uint.*array$/.test(pt(t)),isIntArray:t=>/^int.*array$/.test(pt(t)),isFloatArray:t=>/^float.*array$/.test(pt(t)),isLittleEndian:function(){const t=new Uint32Array([16909060]);return 4===new Uint8ClampedArray(t.buffer)[0]},convertArrayType:function(t,e){return t.constructor===e?t:e.from(t)}});function St(t,e,n){const r={};return n.forEach(n=>{r[n]=t[n][e]}),r}var Et=Object.freeze({isOofA:function(t){return!!xt(t)&&Object.values(t).every(t=>Ot(t))},toOofA:function(t,e){const n=t.length,r=Object.keys(e),s={};return r.forEach(t=>{s[t]=new e[t](n)}),ot(t,(t,e)=>{r.forEach(n=>s[n][e]=t[n])}),s},oofaObject:St,toAofO:function(t,e=Object.keys(t)){const n=t[e[0]].length,r=new Array(n);return ot(r,(n,s)=>{r[s]=St(t,s,e)}),r},oofaBuffers:function(t){const e=[];return ot(t,t=>ot(t,t=>e.push(t.buffer))),e}});const Mt={};Object.assign(Mt,w,I,B,E,rt,gt,ft,Et,At);class vt extends Array{static fromArray(t){return Object.setPrototypeOf(t,vt.prototype),t}toArray(){return Object.setPrototypeOf(this,Array.prototype),this}isEmpty(){return 0===this.length}first(){return this[0]}last(){return this[this.length-1]}all(t){return this.every(t)}props(t,e=vt){const n=new e(this.length);for(let e=0;e<this.length;e++)n[e]=this[e][t];return n}typedSample(t){const e={};return Mt.forLoop(t,(t,n)=>{e[n]=this.props(n,t)}),e}uniq(){return vt.from(new Set(this))}forLoop(t){for(let e=0,n=this.length;e<n;e++)t(this[e],e,this)}ask(t){const e=this.length;for(let n=0;n<Math.min(e,this.length);n++)t(this[n],n,this);if(e!=this.length){const t=this.name||this.constructor.name,n=this.length<e?"decreasing":"increasing";Mt.warn(`AgentArray.ask array mutation: ${t}: ${n}`)}}with(t){return this.filter(t)}other(t){return this.filter(e=>e!==t)}count(t){return this.reduce((e,n)=>e+(t(n)?1:0),0)}sum(t){return this.reduce((e,n)=>e+(t?n[t]:n),0)}avg(t){return this.sum(t)/this.length}min(t){return this.reduce((e,n)=>Math.min(e,t?n[t]:n),1/0)}max(t){return this.reduce((e,n)=>Math.max(e,t?n[t]:n),-1/0)}histogram(t,e=10,n=this.min(t),r=this.max(t)){const s=(r-n)/e,i=new vt(e);return i.fill(0),this.ask(a=>{const o=t?a[t]:a;if(o<n||o>r)Mt.warn(`histogram bounds error: ${o}: ${n}-${r}`);else{let t=Math.floor((o-n)/s);t===e&&t--,i[t]++}}),i.parameters={key:t,bins:e,min:n,max:r,binSize:s,arraySize:this.length},i}cloneRange(t=0,e=this.length){return this.slice(t,e)}clone(){return this.slice(0)}shuffle(){return Mt.shuffle(this)}sortBy(t,e=!0){return Mt.sortObjs(this,t,e),this}remove(t,e){const n=this.agentIndex(t,e);return-1!==n?this.splice(n,1):Mt.warn(`remove: ${t} not in AgentArray`),this}insert(t,e){const n=this.sortedIndex(t,e);if(this[n]===t)throw Error("insert: item already in AgentArray");this.splice(n,0,t)}sortedIndex(t,e=Mt.identityFcn){Mt.isString(e)&&(e=Mt.propFcn(e));const n=e(t);let r=0,s=this.length;for(;r<s;){const t=r+s>>>1;e(this[t])<n?r=t+1:s=t}return r}agentIndex(t,e){if(!e)return this.indexOf(t);const n=this.sortedIndex(t,e);return this[n]===t?n:-1}contains(t,e){return this.agentIndex(t,e)>=0}oneOf(){return Mt.oneOf(this)}otherOneOf(t){return Mt.otherOneOf(this,t)}otherNOf(t,e){if(this.length<t)throw Error("AgentArray: otherNOf: length < N");return this.clone().remove(e).shuffle().slice(0,t)}minOrMaxOf(t,e,n=!1){if(this.isEmpty())throw Error("min/max OneOf: empty array");"string"==typeof e&&(e=Mt.propFcn(e));let r=null,s=t?1/0:-1/0;for(let n=0;n<this.length;n++){const i=this[n],a=e(i);(t&&a<s||!t&&a>s)&&([r,s]=[i,a])}return n?[r,s]:r}minOneOf(t){return this.minOrMaxOf(!0,t)}maxOneOf(t){return this.minOrMaxOf(!1,t)}minValOf(t){return this.minOrMaxOf(!0,t,!0)}maxValOf(t){return this.minOrMaxOf(!1,t,!0)}nOf(t){if(t>this.length)throw Error("nOf: n larger than AgentArray");if(t===this.length)return this;const e=new vt;for(;e.length<t;){const t=this.oneOf();t in e||e.push(t)}return e}minOrMaxNOf(t,e,n){if(e>this.length)throw Error("min/max nOf: n larger than AgentArray");const r=this.clone().sortBy(n);return t?r.clone(0,e):r.clone(r.length-e)}minNOf(t,e){return this.minOrMaxNOf(!0,t,e)}maxNOf(t,e){return this.minOrMaxNOf(!1,t,e)}inRect(t,e,n=e,r=!1){const s=new vt,i=t.x-e,a=t.x+e,o=t.y-n,h=t.y+n;return this.ask(e=>{i<=e.x&&e.x<=a&&o<=e.y&&e.y<=h&&(r||t!==e)&&s.push(e)}),s}inRadius(t,e,n=!1){const r=new vt,s=e*e,i=Mt.sqDistance;return this.ask(e=>{i(t.x,t.y,e.x,e.y)<=s&&(n||t!==e)&&r.push(e)}),r}inCone(t,e,n,r,s=!1){const i=new vt;return this.ask(a=>{Mt.inCone(a.x,a.y,e,n,r,t.x,t.y)&&(s||t!==a)&&i.push(a)}),i}}class Xt extends vt{static get[Symbol.species](){return vt}constructor(t,e,n,r=null){super(),r=r||this,Object.assign(this,{model:t,name:n,baseSet:r,AgentClass:e}),this.isBaseSet()?(this.breeds={},this.ID=0):(Object.setPrototypeOf(this,Object.getPrototypeOf(r)),this.baseSet.breeds[n]=this),this.ownVariables=[],this.agentProto=new e(this),this.protoMixin(this.agentProto,e)}protoMixin(t,e){Object.assign(t,{agentSet:this,model:this.model}),t[this.baseSet.name]=this.baseSet,e.prototype.setBreed||(Object.assign(e.prototype,{setBreed(t){t.setBreed(this)},getBreed(){return this.agentSet},isBreed(t){return this.agentSet===t}}),Object.defineProperty(e.prototype,"breed",{get:function(){return this.agentSet}}))}newBreed(t){return new Xt(this.model,this.AgentClass,t,this)}isBreedSet(){return this.baseSet!==this}isBaseSet(){return this.baseSet===this}withBreed(t){return this.filter(e=>e.agentSet===t)}create(){console.log(`AgentSet: Abstract method called: ${this}`)}addAgent(t){return t=t||Object.create(this.agentProto),this.isBreedSet()?this.baseSet.addAgent(t):t.id=this.ID++,this.push(t),t}clear(){for(;!this.isEmpty();)this.last().die()}removeAgent(t){return this.isBreedSet()&&this.baseSet.remove(t,"id"),this.remove(t,"id"),this}setDefault(t,e){return this.agentProto[t]=e,this}getDefault(t){return this.agentProto[t]}settingDefault(t){return null==t.id}own(t){for(const e of t.split(" "))this.setDefault(e,null),this.ownVariables.push(e)}setBreed(t){if(t.agentSet===this)return;t.agentSet.isBreedSet()&&t.agentSet.remove(t,"id"),this.isBreedSet()&&this.insert(t,"id");const e=t.agentSet.ownVariables;for(const n of e)this.ownVariables.includes(n)||delete t[n];for(const n of this.ownVariables)e.includes(n)||(t[n]=0);return Object.setPrototypeOf(t,this.agentProto)}ask(t){if(0===this.length)return;const e=this.last().id;for(let n=0;n<this.length&&this[n].id<=e;n++)t(this[n],n,this)}askSet(t){0!==this.length&&("patches"===this.name?super.forLoop(t):this.isBaseSet()?this.baseSetAsk(t):this.isBreedSet()&&this.cloneAsk(t))}baseSetAsk(t){if(0===this.length)return;const e=this.last().id;for(let n=0;n<this.length;n++){const r=this[n],s=r.id;if(s>e)break;if(t(r,n,this),n>=this.length)break;if(this[n].id>s)for(;n>=0&&this[n].id>s;)n--}}cloneAsk(t){const e=this.clone();for(let n=0;n<e.length;n++){const r=e[n];r.breed==this&&r.id>0&&t(r,n,e)}}}class Yt{static emptyDataSet(t,e,n){return new Yt(t,e,new n(t*e))}constructor(t,e,n){if(n.length!==t*e)throw Error(`new DataSet length: ${n.length} !== ${t} * ${e}`);Object.assign(this,{width:t,height:e,data:n})}setName(t){return this.name=t,this}getName(){return this.name?this.name:this.makeName()}makeName(){const{width:t,height:e}=this,n=Mt.arraySum(this.data).toFixed(2);return`${this.dataType().name}-${t}-${e}-${n}`}checkXY(t,e){if(!this.inBounds(t,e))throw Error(`DataSet: x,y out of range: ${t}, ${e}`)}inBounds(t,e){return Mt.between(t,0,this.width-1)&&Mt.between(e,0,this.height-1)}dataType(){return this.data.constructor}type(){return this.constructor}toIndex(t,e){return t+e*this.width}toXY(t){return[t%this.width,Math.floor(t/this.width)]}getXY(t,e){return this.data[this.toIndex(t,e)]}setXY(t,e,n){this.data[this.toIndex(t,e)]=n}sample(t,e,n=!0){return this.checkXY(t,e),n?this.nearest(t,e):this.bilinear(t,e)}nearest(t,e){return this.getXY(Math.round(t),Math.round(e))}bilinear(t,e){const n=Math.floor(t),r=Math.floor(e),s=this.toIndex(n,r),i=this.width,a=t-n,o=e-r,h=1-a,c=1-o;return this.data[s]*h*c+(this.data[s+1]||0)*a*c+(this.data[s+i]||0)*h*o+(this.data[s+1+i]||0)*a*o}copy(){return new Yt(this.width,this.height,Mt.clone(this.data))}emptyDataSet(t,e,n=this.dataType()){return Yt.emptyDataSet(t,e,n)}emptyArray(t){return new(this.type())(t)}resample(t,e,n=!0,r=Array){if(t===this.width&&e===this.height)return this.copy();const s=Yt.emptyDataSet(t,e,r);for(let r=0;r<e;r++)for(let i=0;i<t;i++)s.setXY(i,r,this.sample(i*(this.width-1)/(t-1),r*(this.height-1)/(e-1),n));return s}scale(t,e){const n=this.min(),r=(e-t)/(this.max()-n),s=t-r*n;return this.map(t=>r*t+s)}subset(t,e,n,r){if(t+n>this.width||e+r>this.height)throw Error("DataSet.subSet: params out of range");const s=this.emptyDataSet(n,r);for(let i=0;i<n;i++)for(let n=0;n<r;n++)s.setXY(i,n,this.getXY(i+t,n+e));return s}map(t){return new Yt(this.width,this.height,this.data.map(t))}col(t){const[e,n,r]=[this.width,this.height,this.data];if(t>=e)throw Error(`col: x out of range width: ${e} x: ${t}`);const s=this.emptyArray(n);for(let i=0;i<n;i++)s[i]=r[t+i*e];return s}row(t){const[e,n]=[this.width,this.height];if(t>=n)throw Error(`row: y out of range height: ${n} x: ${t}`);return this.data.slice(t*e,(t+1)*e)}convertType(t){this.data=Mt.convertArrayType(this.data,t)}concatEast(t){const[e,n]=[this.width,this.height],[r,s]=[t.width,t.height];if(n!==s)throw Error(`concatEast: heights not equal ${n}, ${s}`);const i=this.emptyDataSet(e+r,n);for(let t=0;t<n;t++)for(let n=0;n<e;n++)i.setXY(t,n,this.getXY(t,n));for(let n=0;n<s;n++)for(let s=0;s<r;s++)i.setXY(n+e,s,t.getXY(n,s));return i}concatSouth(t){const[e,n,r]=[this.width,this.height,this.data];if(e!==t.width)throw Error(`concatSouth: widths not equal ${e}, ${t.width}`);const s=Mt.concatArrays(r,t.data);return new Yt(e,n+t.height,s)}transformCoords(t,e,n,r,s,i){return[(t-n)*(this.width-1)/s,(r-e)*(this.height-1)/i]}coordSample(t,e,n,r,s,i,a=!0){const[o,h]=this.transformCoords(t,e,n,r,s,i);return this.sample(o,h,a)}neighborhood(t,e,n=[]){n.length=0;const r=0===t||t===this.width-1||0===e||e===this.height-1;for(let s=-1;s<=1;s++)for(let i=-1;i<=1;i++){let a=t+i,o=e+s;r&&(a=Mt.clamp(a,0,this.width-1),o=Mt.clamp(o,0,this.height-1)),n.push(this.data[this.toIndex(a,o)])}return n}convolve(t,e=1,n=!1){const[r,s,i,a]=n?[1,1,this.height-1,this.width-1]:[0,0,this.height,this.width],o=this.emptyDataSet(a,i),h=o.data;let c=0;for(let n=s;n<i;n++)for(let s=r;s<a;s++){const r=this.neighborhood(s,n);let i=0;for(let e=0;e<t.length;e++)i+=t[e]*r[e];h[c++]=i*e}return o}dzdx(t=2,e=1/8){return this.convolve([-1,0,1,-t,0,t,-1,0,1],e)}dzdy(t=2,e=1/8){return this.convolve([1,t,1,0,0,0,-1,-t,-1],e)}laplace8(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])}laplace4(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])}blur(t=.0625){return this.convolve([1,2,1,2,4,2,1,2,1],t)}edge(){return this.convolve([1,1,1,1,-7,1,1,1,1])}slopeAndAspect(t=1,e=!0){const n=this.dzdx(),r=this.dzdy();let[s,i]=[[],[]];const[a,o]=[n.height,n.width];for(let h=0;h<a;h++)for(let a=0;a<o;a++){const[o,c]=[n.getXY(a,h),r.getXY(a,h)];i.push(Math.atan(Mt.distance(0,0,o,c))/t);let u=Math.atan2(-c,-o);e&&u<0&&(u+=2*Math.PI),s.push(u)}return{slope:i=new Yt(o,a,i),aspect:s=new Yt(o,a,s),dzdx:n,dzdy:r}}max(){return Mt.arrayMax(this.data)}min(){return Mt.arrayMin(this.data)}equals(t){return this.width===t.width&&this.height===t.height&&Mt.arraysEqual(this.data,t.data)}}class Pt{static defaultVariables(){return{end0:null,end1:null,width:1}}constructor(){Object.assign(this,Pt.defaultVariables())}init(t,e){this.end0=t,this.end1=e,t.links.push(this),e.links.push(this)}die(){this.agentSet.removeAgent(this),Mt.removeArrayItem(this.end0.links,this),Mt.removeArrayItem(this.end1.links,this),this.id=-1}bothEnds(){return vt.fromArray([this.end0,this.end1])}length(){return this.end0.distance(this.end1)}otherEnd(t){if(t===this.end0)return this.end1;if(t===this.end1)return this.end0;throw Error(`Link.otherEnd: turtle not a link turtle: ${t}`)}distanceXY(t,e){return this.bothEnds().map(n=>n.distanceXY(t,e)).sum()-this.length()}get x0(){return this.end0.x}get y0(){return this.end0.y}get z0(){return this.end0.z?this.end0.z:0}get x1(){return this.end1.x}get y1(){return this.end1.y}get z1(){return this.end1.z?this.end1.z:0}}class Rt extends Xt{createOne(t,e,n=(t=>{})){const r=this.addAgent();return r.init(t,e),n(r),r}create(t,e,n=(t=>{})){return Array.isArray(e)||(e=[e]),e.map(e=>this.createOne(t,e,n))}}const kt=(t,e)=>Math.max(t,e);class Tt{static defaultOptions(t=16,e=t,n=kt(t,e)){return{minX:-t,maxX:t,minY:-e,maxY:e,minZ:0,maxZ:n}}static defaultWorld(t=16,e=t,n=kt(t,e)){return new Tt(Tt.defaultOptions(t,e,n))}constructor(t=Tt.defaultOptions()){Object.assign(this,t),this.setWorld()}setWorld(){let{minX:t,maxX:e,minY:n,maxY:r,minZ:s,maxZ:i}=this;this.numX=this.width=e-t+1,this.numY=this.height=r-n+1,this.numZ=this.depth=i-s+1,this.minXcor=t-.5,this.maxXcor=e+.5,this.minYcor=n-.5,this.maxYcor=r+.5,this.minZcor=s-.5,this.maxZcor=i+.5,this.centerX=(t+e)/2,this.centerY=(n+r)/2,this.centerZ=(s+i)/2,this.numPatches=this.width*this.height}randomPoint(){return[Mt.randomFloat2(this.minXcor,this.maxXcor),Mt.randomFloat2(this.minYcor,this.maxYcor)]}random3DPoint(){const t=this.randomPoint();return t.push(Mt.randomFloat2(this.minZcor,this.maxZcor)),t}randomPatchPoint(){return[Mt.randomInt2(this.minX,this.maxX),Mt.randomInt2(this.minY,this.maxY)]}isOnWorld(t,e){return this.minXcor<=t&&t<=this.maxXcor&&this.minYcor<=e&&e<=this.maxYcor}bboxTransform(t,e,n,r){return new It(t,e,n,r,this)}getWorldSize(t=1){return[this.numX*t,this.numY*t]}setEuclideanTransform(t,e){this.setCanvasSize(t.canvas,e),t.restore(),t.save(),t.scale(e,-e),t.translate(-this.minXcor,-this.maxYcor)}patchSize(t){const{numX:e,numY:n}=this,{clientWidth:r,clientHeight:s}=t,i=r/e,a=s/n;if(i!==a)throw Error(`World patchSize: x/y sizes differ ${i}, ${a}`);return i}setCanvasSize(t,e){const[n,r]=this.getWorldSize(e);Mt.setCanvasSize(t,n,r)}pixelXYtoPatchXY(t,e,n){return[this.minXcor+t/n,this.maxYcor-e/n]}patchXYtoPixelXY(t,e,n){return[(t-this.minXcor)*n,(this.maxYcor-e)*n]}xyToPatchIndex(t,e){if(!this.isOnWorld(t,e))return;const{minX:n,maxY:r,numX:s,maxXcor:i,maxYcor:a}=this;return(t=t===i?maxX:Math.round(t))-n+s*(r-(e=e===a?r:Math.round(e)))}}class It{constructor(t,e,n,r,s){t<n&&console.log("flipX"),r<e&&console.log("flipY"),t<n&&([t,n]=[n,t]),r<e&&([r,e]=[e,r]);const{maxXcor:i,maxYcor:a,minXcor:o,minYcor:h}=s,c=(t-n)/(i-o),u=(r-e)/(a-h),l=(t+n-c*(i+o))/2,d=(r+e-u*(a+h))/2;Object.assign(this,{mx:c,my:u,bx:l,by:d})}toWorld(t){const{mx:e,my:n,bx:r,by:s}=this,[i,a]=t;return[(i-r)/e,(a-s)/n]}toBBox(t){const{mx:e,my:n,bx:r,by:s}=this,[i,a]=t;return[e*i+r,n*a+s]}}class $t extends Xt{constructor(t,e,n){super(t,e,n),this.isBreedSet()||(this.populate(),this.labels=[])}populate(){Mt.repeat(this.model.world.numX*this.model.world.numY,t=>{this.addAgent()})}setLabel(t,e){null==e?delete this.labels[t.id]:this.labels[t.id]=e}getLabel(t){return this.labels[t.id]}neighborsOffsets(t,e){const{minX:n,maxX:r,minY:s,maxY:i,numX:a}=this.model.world;return t===n?e===s?[-a,1-a,1]:e===i?[1,a+1,a]:[-a,1-a,1,a+1,a]:t===r?e===s?[-a-1,-a,-1]:e===i?[a,a-1,-1]:[-a-1,-a,a,a-1,-1]:e===s?[-a-1,-a,1-a,1,-1]:e===i?[1,a+1,a,a-1,-1]:[-a-1,-a,1-a,1,a+1,a,a-1,-1]}neighbors4Offsets(t,e){const n=this.model.world.numX;return this.neighborsOffsets(t,e).filter(t=>1===Math.abs(t)||Math.abs(t)===n)}neighbors(t){const{id:e,x:n,y:r}=t,s=this.neighborsOffsets(n,r),i=new vt(s.length);return s.forEach((t,n)=>{i[n]=this[t+e]}),i}neighbors4(t){const{id:e,x:n,y:r}=t,s=this.neighbors4Offsets(n,r),i=new vt(s.length);return s.forEach((t,n)=>{i[n]=this[t+e]}),i}importDataSet(t,e,n=!1){if(this.isBreedSet())return Mt.warn("Patches: exportDataSet called with breed, using patches"),void this.baseSet.importDataSet(t,e,n);const{numX:r,numY:s}=this.model.world,i=t.resample(r,s,n);this.ask(t=>{t[e]=i.data[t.id]})}exportDataSet(t,e=Array){if(this.isBreedSet())return Mt.warn("Patches: exportDataSet called with breed, using patches"),this.baseSet.exportDataSet(t,e);const{numX:n,numY:r}=this.model.world;let s=this.props(t);return s=Mt.convertArrayType(s,e),new Yt(n,r,s)}patchIndex(t,e){const{minX:n,maxY:r,numX:s}=this.model.world;return t-n+s*(r-e)}patch(t,e){if(!this.model.world.isOnWorld(t,e))return;const n=t===this.model.world.maxXcor?this.model.world.maxX:Math.round(t),r=e===this.model.world.maxYcor?this.model.world.maxY:Math.round(e);return this.patchXY(n,r)}patchXY(t,e){return this[this.patchIndex(t,e)]}patchRect(t,e,n=e,r=!0){if(t.rectCache){const s=this.cacheIndex(e,n,r),i=t.rectCache[s];if(i)return i}const s=new vt;let{minX:i,maxX:a,minY:o,maxY:h}=this.model.world;i=Math.max(i,t.x-e),a=Math.min(a,t.x+e),o=Math.max(o,t.y-n),h=Math.min(h,t.y+n);for(let e=o;e<=h;e++)for(let n=i;n<=a;n++){const i=this.patchXY(n,e);(t!==i||r)&&s.push(i)}return s}patchRectXY(t,e,n,r=n,s=!0){return this.patchRect(this.patch(t,e),n,r,s)}cacheIndex(t,e=t,n=!0){return(2*t+1)*(2*e+1)+(n?0:-1)}cacheRect(t,e=t,n=!0,r=!0){const s=this.cacheIndex(t,e,n);this.ask(i=>{i.rectCache&&!r||(i.rectCache=[]);const a=this.inRect(i,t,e,n);i.rectCache[s]=a})}inRect(t,e,n=e,r=!0){const s=this.patchRect(t,e,n,r);return this.isBaseSet()?s:s.withBreed(this)}inRadius(t,e,n=!0){const r=Math.ceil(e);return this.inRect(t,r,r,n).inRadius(t,e,n)}inCone(t,e,n,r,s=!0){const i=Math.ceil(e);return this.inRect(t,i,i,s).inCone(t,e,n,r,s)}patchAtAngleAndDistance(t,e,n){let{x:r,y:s}=t;return r+=n*Math.cos(e),s+=n*Math.sin(e),this.patch(r,s)}isOnEdge(t){const{x:e,y:n}=t,{minX:r,maxX:s,minY:i,maxY:a}=this.model.world;return e===r||e===s||n===i||n===a}edgePatches(){return this.filter(t=>this.isOnEdge(t))}diffuse(t,e){this.diffuseN(8,t,e)}diffuse4(t,e){this.diffuseN(4,t,e)}diffuseN(t,e,n){if(void 0===this[0]._diffuseNext)for(let t=0;t<this.length;t++)this[t]._diffuseNext=0;for(let r=0;r<this.length;r++){const s=this[r],i=s[e]*n,a=i/t,o=8===t?s.neighbors:s.neighbors4,h=o.length;s._diffuseNext+=s[e]-i+(t-h)*a;for(let t=0;t<o.length;t++)o[t]._diffuseNext+=a}for(let t=0;t<this.length;t++){const n=this[t];n[e]=n._diffuseNext,n._diffuseNext=0}}}class jt{static defaultVariables(){return{turtles:void 0}}constructor(){Object.assign(this,jt.defaultVariables())}get x(){return this.id%this.model.world.numX+this.model.world.minX}get y(){return this.model.world.maxY-Math.floor(this.id/this.model.world.numX)}isOnEdge(){return this.patches.isOnEdge(this)}get neighbors(){const t=this.patches.neighbors(this);return Object.defineProperty(this,"neighbors",{value:t,enumerable:!0}),t}get neighbors4(){const t=this.patches.neighbors4(this);return Object.defineProperty(this,"neighbors4",{value:t,enumerable:!0}),t}turtlesHere(){return null==this.turtles&&(this.patches.ask(t=>{t.turtles=new vt}),this.model.turtles.ask(t=>{t.patch.turtles.push(t)})),this.turtles}breedsHere(t){return this.turtlesHere().withBreed(t)}distanceXY(t,e){return Mt.distance(this.x,this.y,t,e)}distance(t){return this.distanceXY(t.x,t.y)}towards(t){return this.towardsXY(t.x,t.y)}towardsXY(t,e){return Mt.radiansToward(this.x,this.y,t,e)}patchAt(t,e){return this.patches.patch(this.x+t,this.y+e)}patchAtAngleAndDistance(t,e){return this.patches.patchAtAngleAndDistance(this,t,e)}sprout(t=1,e=this.model.turtles,n=(t=>{})){return e.create(t,t=>{t.setxy(this.x,this.y),n(t)})}}class Bt extends Xt{createOne(t=(t=>{})){const e=this.addAgent();return null==this.getDefault("theta")&&(e.theta=Mt.randomFloat(2*Math.PI)),t(e),e}create(t,e=(t=>{})){return Mt.repeat(t,(t,n)=>{n.push(this.createOne(e))})}closestTurtle(t,e,n){const r=this.inPatchRectXY(t,e,n);return 0===r.length?null:r.minOneOf(n=>n.distanceXY(t,e))}inPatches(t){let e=new vt;for(const n of t)e.push(...n.turtlesHere());return this.isBreedSet()&&(e=e.filter(t=>t.agentSet===this)),e}inPatchRect(t,e,n=e,r=!1){const s=this.inPatchRectXY(t.x,t.y,e,n);return r||Mt.removeArrayItem(s,t),s}inPatchRectXY(t,e,n,r=n){const s=this.model.patches.patchRectXY(t,e,n,r,!0);return this.inPatches(s)}inRadius(t,e,n=!1){return this.inPatchRect(t,e,e,!0).inRadius(t,e,n)}inCone(t,e,n,r=!1){return this.inPatchRect(t,e,e,!0).inCone(t,e,n,t.theta,r)}layoutCircle(t=.9*this.model.world.maxX,e=[0,0],n=Math.PI/2,r=-1){const s=2*Math.PI/this.length,[i,a]=e;this.ask((e,o)=>{e.setxy(i,a),e.theta=n+r*s*o,e.forward(t)})}}class Nt{static defaultVariables(){return{x:0,y:0,z:0,theta:null,atEdge:"clamp"}}constructor(){Object.assign(this,Nt.defaultVariables())}die(){if(this.agentSet.removeAgent(this),this.hasOwnProperty("links"))for(;this.links.length>0;)this.links[0].die();null!=this.patch.turtles&&Mt.removeArrayItem(this.patch.turtles,this),this.id=-1}hatch(t=1,e=this.agentSet,n=(t=>{})){return e.create(t,t=>{t.setxy(this.x,this.y);for(const n of e.ownVariables)null==t[n]&&(t[n]=this[n]);n(t)})}get links(){return Object.defineProperty(this,"links",{value:new vt(0),enumerable:!0}),this.links}get patch(){return this.model.patches.patch(this.x,this.y)}get heading(){return Mt.heading(this.theta)}set heading(t){this.theta=Mt.angle(t)}get direction(){return this.theta}set direction(t){this.theta=t}setxy(t,e,n=null){const r=this.patch;null!=n&&(this.z=n),this.model.world.isOnWorld(t,e)||"OK"===this.atEdge?(this.x=t,this.y=e):this.handleEdge(t,e);const s=this.patch;s&&null!=s.turtles&&s!==r&&(r&&Mt.removeArrayItem(r.turtles,this),s.turtles.push(this))}handleEdge(t,e){if(Mt.isString(this.atEdge)){const{minXcor:n,maxXcor:r,minYcor:s,maxYcor:i}=this.model.world;if("wrap"===this.atEdge)this.x=Mt.wrap(t,n,r),this.y=Mt.wrap(e,s,i);else{if("clamp"!==this.atEdge&&"bounce"!==this.atEdge)throw Error(`turtle.handleEdge: bad atEdge: ${this.atEdge}`);this.x=Mt.clamp(t,n,r),this.y=Mt.clamp(e,s,i),"bounce"===this.atEdge&&(this.x===n||this.x===r?this.theta=Math.PI-this.theta:this.theta=-this.theta)}}else this.atEdge(this)}moveTo(t){this.setxy(t.x,t.y)}forward(t){this.setxy(this.x+t*Math.cos(this.theta),this.y+t*Math.sin(this.theta))}rotate(t){this.theta=Mt.mod(this.theta+t,2*Math.PI)}right(t){this.rotate(-t)}left(t){this.rotate(t)}face(t){this.theta=this.towards(t)}faceXY(t,e){this.theta=this.towardsXY(t,e)}patchAhead(t){return this.patchAtAngleAndDistance(this.theta,t)}canMove(t){return null!=this.patchAhead(t)}patchLeftAndAhead(t,e){return this.patchAtAngleAndDistance(t+this.theta,e)}patchRightAndAhead(t,e){return this.patchAtAngleAndDistance(t-this.theta,e)}distanceXY(t,e){return Mt.distance(this.x,this.y,t,e)}distance(t){return Mt.distance(this.x,this.y,t.x,t.y)}sqDistance(t){return Mt.sqDistance(this.x,this.y,t.x,t.y)}towards(t){return this.towardsXY(t.x,t.y)}towardsXY(t,e){return Mt.radiansToward(this.x,this.y,t,e)}patchAt(t,e){return this.model.patches.patch(this.x+t,this.y+e)}patchAtAngleAndDistance(t,e){return this.model.patches.patchAtAngleAndDistance(this,t,e)}otherEnd(t){return t.end0===this?t.end1:t.end0}linkNeighbors(){return this.links.map(t=>this.otherEnd(t))}isLinkNeighbor(t){return t in this.linkNeighbors()}}class Ct{constructor(t=Tt.defaultOptions()){this.resetModel(t),this.autoTick()}initAgentSet(t,e,n){this[t]=new e(this,n,t)}resetModel(t){this.ticks=0,this.world=void 0===t.maxXcor?new Tt(t):t,this.initAgentSet("patches",$t,jt),this.initAgentSet("turtles",Bt,Nt),this.initAgentSet("links",Rt,Pt)}reset(t=this.world){this.resetModel(t)}tick(){this.ticks++}async startup(){}setup(){}step(){}stepAndTick(){this.step0(),this.tick()}autoTick(){this.step0=this.step,this.step=this.stepAndTick}patchBreeds(t){for(const e of t.split(" "))this[e]=this.patches.newBreed(e)}turtleBreeds(t){for(const e of t.split(" "))this[e]=this.turtles.newBreed(e)}linkBreeds(t){for(const e of t.split(" "))this[e]=this.links.newBreed(e)}}class Dt extends Yt{static newRgbDataFunction(t,e){return(n,r,s)=>t+(256*n*256+256*r+s)*e}static newMapzenElevation(){return this.newRgbDataFunction(-32768,1/256)}static mapzenUrl(t,e,n){return`https://s3.amazonaws.com/elevation-tiles-prod/terrarium/${t}/${e}/${n}.png`}static newMapboxElevation(){return this.newRgbDataFunction(-1e4,.1)}static mapboxUrl(t,e,n,r){return`https://api.mapbox.com/v4/mapbox.terrain-rgb/${t}/${e}/${n}.pngraw?access_token=${r}`}static redfishElevation(t,e,n){let r=1;return t>63&&(r=-1,t=0),r*(256*t*256+256*e+n)/10}static redfishUSAUrl(t,e,n){return`https://s3-us-west-2.amazonaws.com/simtable-elevation-tiles/${t}/${e}/${n}.png`}static redfishWorldUrl(t,e,n){return`https://s3-us-west-2.amazonaws.com/world-elevation-tiles/DEM_tiles/${t}/${e}/${n}.png`}static rgbToInt24(t,e,n){return 256*t*256+256*e+n}constructor(t,e=Dt.rgbToInt24,n=Float32Array){super(t.width,t.height,new n(t.width*t.height)),Array.isArray(e)&&(e=Dt.newRgbDataFunction(e));const r=Mt.createCtx(t.width,t.height);Mt.fillCtxWithImage(r,t);const s=Mt.ctxImageData(r),i=this.data;for(var a=0;a<i.length;a++){const t=s.data[4*a],n=s.data[4*a+1],r=s.data[4*a+2];i[a]=e(t,n,r)}}}export{vt as AgentArray,Xt as AgentSet,Yt as DataSet,Pt as Link,Rt as Links,Ct as Model,jt as Patch,$t as Patches,Dt as RGBDataSet,Nt as Turtle,Bt as Turtles,Tt as World,f as gis,Mt as util};
