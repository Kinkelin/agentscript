const{PI:t,atan:e,atan2:s,cos:i,floor:r,log:n,pow:h,sin:o,sinh:a,sqrt:c,tan:l}=Math,u=e=>e*t/180;var d=Object.freeze({__proto__:null,lon2x:function(t,e){return r((t+180)/360*h(2,e))},lat2y:function(e,s){const o=u(e);return r((1-n(l(o)+1/i(o))/t)*h(2,s-1))},lonlat2xy:function(t,e,s){return[this.lon2x(t,s),this.lat2y(e,s)]},x2lon:function(t,e){return t/h(2,e)*360-180},y2lat:function(s,i){return(e=>180*e/t)(e(a(t-2*t*s/h(2,i))))},xy2lonlat:function(t,e,s){return[this.x2lon(t,s),this.y2lat(e,s)]},xy2bbox:function(t,e,s){const[i,r]=this.xy2lonlat(t,e,s),[n,h]=this.xy2lonlat(t+1,e+1,s);return[i,h,n,r]},lonLat2bbox:function(t,e,s){const[i,r]=this.lonlat2xy(t,e,s);return this.xy2bbox(i,r,s)},bboxCenter:function(t){const[e,s,i,r]=t;return[(e+i)/2,(s+r)/2]},bboxCoords:function(t){const[e,s,i,r]=t;return[[e,r],[i,r],[i,s],[e,s]]},getOsmURL:function(t,e,s,i){return"https://overpass-api.de/api/interpreter?data="+encodeURIComponent(`[out:json][timeout:180][bbox:${t}${e}${s}${i}];\nway[highway];\n(._;>;);\nout;`)},lonLat2meters:function(t,e){const[r,n]=t.map(t=>u(t)),[h,a]=e.map(t=>u(t)),l=h-r,d=o((a-n)/2)**2+i(n)*i(a)*o(l/2)**2;return 1e3*(6378.137*(2*s(c(d),c(1-d))))},cloneJson:function(t){return JSON.parse(JSON.stringify(t))},areEqual:function(t,e){return JSON.stringify(t)===JSON.stringify(e)},minify:function(t){return JSON.stringify(t).replace(/,{"type":"Feature"/g,'\n,\n{"type":"Feature"')}});function m(t){return new Promise((e,s)=>{const i=new Image;i.crossOrigin="Anonymous",i.onload=()=>e(i),i.onerror=()=>s("Could not load image "+t),i.src=t})}function f(t,e="text",s="GET"){return new Promise((i,r)=>{const n=new XMLHttpRequest;n.open(s,t),n.responseType=e,n.onload=()=>i(n.response),n.onerror=()=>r(Error(`Could not load ${t}: ${n.status}`)),n.send()})}function y(t=1e3){return new Promise(e=>{setTimeout(e,t)})}function x(){return E()}function g(t,e,s=x()){if(s)return new OffscreenCanvas(t,e);const i=document.createElement("canvas");return i.width=t,i.height=e,i}function p(t,e,s=x()){return g(t,e,s).getContext("2d")}function w(t,e=x()){const s=p(t.width,t.height,e);return s.drawImage(t,0,0),s.canvas}function b(t,e,s){t.width===e&&t.height==s||(t.width=e,t.height=s)}function M(t){t.save(),t.setTransform(1,0,0,1,0,0)}function _(t){return t.getImageData(0,0,t.canvas.width,t.canvas.height)}function z(t,e){M(t),t.drawImage(e,0,0,t.canvas.width,t.canvas.height),t.restore()}const O=new Set;function A(t,e=!1){O.has(t)||(e?console.warn(t):console.log(t),O.add(t))}function v(t){A(t,!0)}function S(){return window.location.search.substr(1)}function k(t=S()){const e={},s=new URLSearchParams(t);for(var i of s.entries()){let[t,s]=i;(s.match(/^[0-9.]+$/)||s.match(/^[0-9.]+e[0-9]+$/))&&(s=Number(s)),["true","t",""].includes(s)&&(s=!0),["false","f"].includes(s)&&(s=!1),e[t]=s}return e}function E(){return!C()&&void 0===self.window}function C(){return"undefined"!=typeof global}const{PI:X}=Math,R=t=>Math.floor(Math.random()*t),Y=(t,e)=>t+Math.floor(Math.random()*(e-t)),j=t=>Math.random()*t,P=(t,e)=>t+Math.random()*(e-t);const T=(t,e)=>(t%e+e)%e,D=(t,e,s)=>e+T(t-e,s-e);function F(t,e,s){return t<e?e:t>s?s:t}const I=(t,e,s)=>e<=t&&t<=s,W=(t,e,s)=>t<=e?t+(e-t)*s:t-(t-e)*s;const Z=180/X,N=X/180,q=t=>$(t*N),B=t=>H(t*Z);function V(t){return H(90-t*Z)}function H(t){return T(t,360)}function $(t){return T(t,2*X)}function U(t,e){return H(t)===H(e)}const L=U;function Q(t,e){let s=$(t-e);return s>X&&(s-=2*X),s}function J(t,e){let s=H(t-e);return s>180&&(s-=360),s}const G=(t,e)=>-J(t,e);function K(t,e,s,i){return Math.atan2(i-e,s-t)}const tt=180/Math.PI,et=Math.PI/180,st={radians:{toRads:t=>t,fromRads:t=>t,toAngleRads:t=>t,fromAngleRads:t=>t,toCCW:t=>t},degrees:{toRads:t=>t*et,fromRads:t=>t*tt,toAngleRads:t=>t*et,fromAngleRads:t=>t*tt,toCCW:t=>t},heading:{toRads:t=>(90-t)*et,fromRads:t=>90-t*tt,toAngleRads:t=>t*et,fromAngleRads:t=>t*tt,toCCW:t=>-t}};const it=(t,e,s,i)=>(t-s)**2+(e-i)**2,rt=(t,e,s,i)=>Math.sqrt(it(t,e,s,i)),nt=(t,e,s,i,r,n)=>(t-i)**2+(e-r)**2+(s-n)**2,ht=(t,e,s,i,r,n)=>Math.sqrt(nt(t,e,s,i,r,n));function ot(t,e,s,i,r,n,h){if(it(n,h,t,e)>s*s)return!1;const o=K(n,h,t,e);return i/2>=Math.abs(Q(r,o))}const at=t=>t,ct=t=>e=>e[t];function lt(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!1;return!0}function ut(t,e){const s=t.indexOf(e);return-1!==s?t.splice(s,1):console.log(`removeArrayItem: ${e} not in array`),t}function dt(t,e){if(t.slice)for(let s=0,i=t.length;s<i;s++)e(t[s],s,t);else Object.keys(t).forEach(s=>e(t[s],s,t))}function mt(t,e,s=[]){for(let i=0;i<t;i++)e(i,s);return s}function ft(t,e){const s=t.constructor;if(s===Array)return t.concat(kt(e,Array));const i=new s(t.length+e.length);return i.set(t),i.set(e,t.length),i}const yt=t=>t[R(t.length)];function xt(t,e){if(t.length<2)throw Error("otherOneOf: array.length < 2");do{var s=yt(t)}while(e===s);return s}const gt=t=>yt(Object.keys(t));function pt(t,e,s=!0){"string"==typeof e&&(e=ct(e));const i=(t,s)=>e(t)-e(s);return t.sort((t,e)=>s?i(t,e):-i(t,e))}function wt(t){for(let e=t.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1)),i=t[e];t[e]=t[s],t[s]=i}return t}function bt(t,e,s){if(s<=1)throw Error("floatRamp: numItems must be > 1");const i=[];for(let r=0;r<s;r++)i.push(t+r/(s-1)*(e-t));return i}function Mt(t,e,s){const i={};return s.forEach(s=>{i[s]=t[s][e]}),i}const _t=t=>({}.toString.call(t).match(/\s(\w+)/)[1].toLowerCase()),zt=(t,e)=>_t(t)===e,Ot=(t,e)=>e.includes(_t(t)),At=t=>zt(t,"string"),vt=t=>zt(t,"object"),St=t=>"arraybuffer"===_t(t.buffer);function kt(t,e){return t.constructor===e?t:e.from(t)}var Et=Object.freeze({__proto__:null,imagePromise:m,imageBitmapPromise:async function(t){const e=await f(t,"blob");return createImageBitmap(e)},canvasBlobPromise:function(t,e="image/png",s=.95){return new Promise(i=>{t.toBlob(t=>i(t),e,s)})},canvasFilePromise:function(t,e="canvas.png"){return new Promise(s=>{t.toBlob(t=>{var i=new File([t],e,{type:"image/png"});s(i)})})},blobImagePromise:function(t){return m(URL.createObjectURL(t))},xhrPromise:f,timeoutPromise:y,timeoutLoop:async function(t,e=-1,s=0){let i=0;for(;i++!==e;)t(i-1),await y(s)},waitPromise:function(t,e=10){return new Promise(s=>{!function i(){if(t())return s();setTimeout(i,e)}()})},fetchType:async function(t,e="text"){const s=await fetch(t);if(!s.ok)throw Error("Not found: "+t);return await s[e]()},createCanvas:g,createCtx:p,cloneCanvas:w,resizeCtx:function(t,e,s){const i=w(t.canvas);t.canvas.width=e,t.canvas.height=s,t.drawImage(i,0,0)},resizeCanvas:function(t,e,s=e/t.width*t.height){const i=p(e,s);return i.drawImage(t,0,0,e,s),i.canvas},setCanvasSize:b,setIdentity:M,setTextProperties:function(t,e,s="center",i="middle"){Object.assign(t,{font:e,textAlign:s,textBaseline:i})},drawText:function(t,e,s,i,r,n=!0){n&&M(t),t.fillStyle=r.css||r,t.fillText(e,s,i),n&&t.restore()},ctxImageData:_,clearCtx:function(t,e){const{width:s,height:i}=t.canvas;M(t),e&&"transparent"!==e?(e=e.css||e,t.fillStyle=e,t.fillRect(0,0,s,i)):t.clearRect(0,0,s,i),t.restore()},fillCtxWithImage:z,setCtxImage:function(t,e){b(t.canvas,e.width,e.height),z(t,e)},logOnce:A,warn:v,timeit:function(t,e=1e5,s="test"){s=s+"-"+e,console.time(s);for(let s=0;s<e;s++)t(s);console.timeEnd(s)},fps:function(){const t="undefined"==typeof performance?Date:performance,e=t.now();let s=0;function i(){s++;const r=t.now()-e,n=parseFloat((s/(r/1e3)).toFixed(2));Object.assign(i,{fps:n,ms:r,start:e,steps:s})}return i.steps=0,i},pps:function(t,e=""){e&&console.log(e);let s=1,i="";for(;t;){if("function"==typeof t)i=t.constructor.toString();else{const e=Object.keys(t);i=e.length>0?`[${e.join(", ")}]`:`[${t.constructor.name}]`}console.log(`[${s++}]: ${i}`),t=Object.getPrototypeOf(t)}},toWindow:function(t,e=!1){Object.assign(window,t),console.log("toWindow:",Object.keys(t).join(", ")),e&&Object.keys(t).forEach(e=>console.log("  ",e,t[e]))},dump:function(t=window.model){let{patches:e,turtles:s,links:i}=t;Object.assign(window,{ps:e,ts:s,ls:i}),window.p=e.length>0?e.oneOf():{},window.t=s.length>0?s.oneOf():{},window.l=i.length>0?i.oneOf():{},console.log("debug: ps, ts, ls, p, t, l dumped to window")},setCssStyle:async function(t){const e=await fetch(t);if(!e.ok)throw Error("Not found: "+t);const s=await e.text();document.head.innerHTML+=`<style>${s}</style>`},getQueryString:S,parseQueryString:k,RESTapi:function(t){return Object.assign(t,k())},inWorker:E,inNode:C,inDeno:function(){return!!Deno},printToPage:function(t,e=document.body){"object"==typeof t&&(t=JSON.stringify(t,null,2)),t="<pre>"+t+"</pre>","string"==typeof e&&(e=document.getElementById(e)),e.style.fontFamily="monospace",e.innerHTML+=t},getEventXY:function(t,e){const s=t.getBoundingClientRect();return[e.clientX-s.left,e.clientY-s.top]},fcnToWorker:function(t){const e=document.location.href.replace(/\/[^\/]+$/,"/"),s=`(${t.toString(e)})("${e}")`,i=URL.createObjectURL(new Blob([s],{type:"text/javascript"})),r=new Worker(i);return r.onerror=function(t){console.log("Worker ERROR: Line ",t.lineno,": ",t.message)},r},randomInt:R,randomInt2:Y,randomFloat:j,randomFloat2:P,randomCentered:t=>P(-t/2,t/2),randomNormal:function(t=0,e=1){const[s,i]=[1-Math.random(),Math.random()];return Math.sqrt(-2*Math.log(s))*Math.cos(2*X*i)*e+t},randomSeed:function(t=123456){t%=2147483647,Math.random=()=>((t=16807*t%2147483647)-1)/2147483646},precision:function(t,e=4){if(Array.isArray(t))return t.map(t=>this.precision(t,e));const s=10**e;return Math.round(t*s)/s},isPowerOf2:t=>0==(t&t-1),nextPowerOf2:t=>Math.pow(2,Math.ceil(Math.log2(t))),mod:T,wrap:D,clamp:F,isBetween:I,lerp:W,lerpScale:function(t,e,s){if(e===s)throw Error("lerpScale: lo === hi");return((t=F(t,e,s))-e)/(s-e)},degToRad:q,radToDeg:B,radToHeading:V,headingToRad:function(t){return H(90-t)*N},radToHeadingAngle:function(t){return-B(t)},headingAngleToRad:function(t){return-q(t)},degToHeading:t=>H(90-t),headingToDeg:t=>H(90-t),mod360:H,mod2pi:$,modpipi:function(t){return T(t,2*X)-X},mod180180:function(t){return H(t)-180},degreesEqual:U,radsEqual:function(t,e){return $(t)===$(e)},headingsEq:L,subtractRadians:Q,subtractDegrees:J,subtractHeadings:G,radiansTowardXY:K,headingTowardXY:function(t,e,s,i){return V(K(t,e,s,i))},degreesTowardXY:function(t,e,s,i){return B(K(t,e,s,i))},setGeometry:function(t,e){const s=st[e];if(!s)throw Error(`util.setGeometry: ${e} geometry not defined`);Object.assign(t,s),t.geometry=e},sqDistance:it,distance:rt,sqDistance3:nt,distance3:ht,inCone:ot,sampleModel:function(t){const e=function(t,e=0,s=!0){let i=s;const r=["rectCache"];return JSON.stringify(t,(t,e)=>{if(r.includes(t))return;return Array.isArray(e)&&e.length>0&&Number.isInteger(e[0].id)&&!i?e.map(t=>t.id):(i=!1,e)},e)}({ticks:t.ticks,model:Object.keys(t),patches:t.patches.length,patch:t.patches.oneOf(),turtles:t.turtles.length,turtle:t.turtles.oneOf(),links:t.links.length,link:t.links.oneOf()});return JSON.parse(e)},identityFcn:at,noopFcn:()=>{},propFcn:ct,arraysEqual:lt,removeArrayItem:ut,arraysToString:t=>t.map(t=>""+t).join(","),forLoop:dt,repeat:mt,step:function(t,e,s){for(let i=0;i<t;i+=e)s(i)},range:function(t){return mt(t,(t,e)=>{e[t]=t})},override:function(t,e){const s=t;return dt(t,(t,i)=>{e[i]&&(s[i]=e[i])}),s},concatArrays:ft,objectToString:function(t,e=2,s=!0){let i=JSON.stringify(t,null,e);return s&&(i=i.replace(/"([^"]+)":/gm,"$1:")),i},objectsEqual:(t,e)=>JSON.stringify(t)===JSON.stringify(e),oneOf:yt,otherOneOf:xt,oneKeyOf:gt,oneValOf:t=>t[gt(t)],sortNums:function(t,e=!0){return t.sort((t,s)=>e?t-s:s-t)},sortObjs:pt,shuffle:wt,union:function(t,e){return Array.from(new Set(t.concat(e)))},intersection:function(t,e){const s=new Set(e);return t.filter(t=>s.has(t))},difference:function(t,e){const s=new Set(e);return t.filter(t=>!s.has(t))},floatRamp:bt,integerRamp:function(t,e,s=Math.abs(e-t)+1){return bt(t,e,s).map(t=>Math.round(t))},arrayLast:t=>t[t.length-1],isOofA:function(t){return!!vt(t)&&Object.values(t).every(t=>St(t))},toOofA:function(t,e){const s=t.length,i=Object.keys(e),r={};return i.forEach(t=>{r[t]=new e[t](s)}),dt(t,(t,e)=>{i.forEach(s=>r[s][e]=t[s])}),r},oofaObject:Mt,toAofO:function(t,e=Object.keys(t)){const s=t[e[0]].length,i=new Array(s);return dt(i,(s,r)=>{i[r]=Mt(t,r,e)}),i},oofaBuffers:function(t){const e=[];return dt(t,t=>dt(t,t=>e.push(t.buffer))),e},typeOf:_t,isType:zt,isOneOfTypes:Ot,isString:At,isObject:vt,isArray:t=>Array.isArray(t),isNumber:t=>zt(t,"number"),isInteger:t=>Number.isInteger(t),isFunction:t=>zt(t,"function"),isImage:t=>zt(t,"image"),isCanvas:t=>Ot(t,["htmlcanvaselement","offscreencanvas"]),isImageable:t=>Ot(t,["image","htmlimageelement","htmlcanvaselement","offscreencanvas","imagebitmap"]),isTypedArray:St,isUintArray:t=>/^uint.*array$/.test(_t(t)),isIntArray:t=>/^int.*array$/.test(_t(t)),isFloatArray:t=>/^float.*array$/.test(_t(t)),isLittleEndian:function(){const t=new Uint32Array([16909060]);return 4===new Uint8ClampedArray(t.buffer)[0]},convertArrayType:kt});class Ct extends Array{static get[Symbol.species](){return Ct}static fromArray(t){return Object.setPrototypeOf(t,Ct.prototype)}constructor(...t){super(...t)}toArray(){return Object.setPrototypeOf(this,Array.prototype),this}isEmpty(){return 0===this.length}first(){return this[0]}last(){return this[this.length-1]}atIndex(t){if(0===this.length)return;return this[T(t,this.length)]}all(t){return this.every(t)}props(t,e=Ct){const s=new e(this.length);for(let e=0;e<this.length;e++)s[e]=this[e][t];return s}typedSample(t){const e={};return dt(t,(t,s)=>{e[s]=this.props(s,t)}),e}uniq(){return Ct.from(new Set(this))}forLoop(t){for(let e=0,s=this.length;e<s;e++)t(this[e],e,this);return this}ask(t){const e=this.length;for(let s=0;s<Math.min(e,this.length);s++)t(this[s],s,this);if(e!=this.length){v(`AgentArray.ask array mutation: ${this.name||this.constructor.name}: ${this.length<e?"decreasing":"increasing"}`)}}with(t){return this.filter(t)}other(t){return this.filter(e=>e!==t)}count(t){return this.reduce((e,s)=>e+(t(s)?1:0),0)}sum(t){return this.reduce((e,s)=>e+(t?s[t]:s),0)}avg(t){return this.sum(t)/this.length}min(t){return this.reduce((e,s)=>Math.min(e,t?s[t]:s),1/0)}max(t){return this.reduce((e,s)=>Math.max(e,t?s[t]:s),-1/0)}extent(t){return[this.min(t),this.max(t)]}histogram(t,e=10,s=this.min(t),i=this.max(t)){const r=(i-s)/e,n=new Ct(e);return n.fill(0),this.ask(h=>{const o=t?h[t]:h;if(o<s||o>i)v(`histogram bounds error: ${o}: ${s}-${i}`);else{let t=Math.floor((o-s)/r);t===e&&t--,n[t]++}}),n.parameters={key:t,bins:e,min:s,max:i,binSize:r,arraySize:this.length},n}clone(){return this.slice(0)}shuffle(){return wt(this)}sortBy(t,e=!0){return pt(this,t,e),this}remove(t,e){const s=this.agentIndex(t,e);return-1!==s?this.splice(s,1):v(`remove: ${t} not in AgentArray`),this}insert(t,e){const s=this.sortedIndex(t,e);if(this[s]===t)throw Error("insert: item already in AgentArray");this.splice(s,0,t)}sortedIndex(t,e=at){At(e)&&(e=ct(e));const s=e(t);let i=0,r=this.length;for(;i<r;){const t=i+r>>>1;e(this[t])<s?i=t+1:r=t}return i}agentIndex(t,e){if(!e)return this.indexOf(t);const s=this.sortedIndex(t,e);return this[s]===t?s:-1}contains(t,e){return this.agentIndex(t,e)>=0}oneOf(){return yt(this)}otherOneOf(t){return xt(this,t)}otherNOf(t,e){if(this.length<t)throw Error("AgentArray: otherNOf: length < N");return this.clone().remove(e).shuffle().slice(0,t)}minOrMaxOf(t,e,s=!1){if(this.isEmpty())throw Error("min/max OneOf: empty array");"string"==typeof e&&(e=ct(e));let i=null,r=t?1/0:-1/0;for(let s=0;s<this.length;s++){const n=this[s],h=e(n);(t&&h<r||!t&&h>r)&&([i,r]=[n,h])}return s?[i,r]:i}minOneOf(t){return this.minOrMaxOf(!0,t)}maxOneOf(t){return this.minOrMaxOf(!1,t)}minValOf(t){return this.minOrMaxOf(!0,t,!0)}maxValOf(t){return this.minOrMaxOf(!1,t,!0)}nOf(t){if(t>this.length)throw Error("nOf: n larger than AgentArray");if(t===this.length)return this;const e=new Ct;for(;e.length<t;){const t=this.oneOf();t in e||e.push(t)}return e}minOrMaxNOf(t,e,s){if(e>this.length)throw Error("min/max nOf: n larger than AgentArray");const i=this.clone().sortBy(s);return t?i.clone(0,e):i.clone(i.length-e)}minNOf(t,e){return this.minOrMaxNOf(!0,t,e)}maxNOf(t,e){return this.minOrMaxNOf(!1,t,e)}}class Xt extends Ct{model;name;baseSet;AgentClass;static get[Symbol.species](){return Ct}constructor(t,e,s,i=null){super(),i=i||this,Object.assign(this,{model:t,name:s,baseSet:i,AgentClass:e}),this.isBaseSet()?(this.breeds={},this.ID=0):(Object.setPrototypeOf(this,Object.getPrototypeOf(i)),this.baseSet.breeds[s]=this),this.ownVariables=[],this.agentProto=new e(this),this.protoMixin(this.agentProto,e)}protoMixin(t,e){Object.assign(t,{agentSet:this,model:this.model}),t[this.baseSet.name]=this.baseSet,e.prototype.setBreed||(Object.assign(e.prototype,{setBreed(t){t.setBreed(this)},getBreed(){return this.agentSet},isBreed(t){return this.agentSet===t}}),Object.defineProperty(e.prototype,"breed",{get:function(){return this.agentSet}}))}newBreed(t){return new Xt(this.model,this.AgentClass,t,this)}isBreedSet(){return this.baseSet!==this}isBaseSet(){return this.baseSet===this}withBreed(t){return this.filter(e=>e.agentSet===t)}create(){console.log("AgentSet: Abstract method called: "+this)}addAgent(t){return t=t||Object.create(this.agentProto),this.isBreedSet()?this.baseSet.addAgent(t):(t.id=this.ID++,t.agentConstructor&&t.agentConstructor()),this.push(t),t}clear(){for(;!this.isEmpty();)this.last().die()}removeAgent(t){return this.isBreedSet()&&this.baseSet.remove(t,"id"),this.remove(t,"id"),this}setDefault(t,e){return this.agentProto[t]=e,this}getDefault(t){return this.agentProto[t]}setBreed(t){if(t.agentSet===this)return;t.agentSet.isBreedSet()&&t.agentSet.remove(t,"id"),this.isBreedSet()&&this.insert(t,"id");const e=t.agentSet.ownVariables;for(const s of e)this.ownVariables.includes(s)||delete t[s];for(const s of this.ownVariables)e.includes(s)||(t[s]=0);return Object.setPrototypeOf(t,this.agentProto)}ask(t){if(0===this.length)return;const e=this.last().id;for(let s=0;s<this.length&&this[s].id<=e;s++)t(this[s],s,this)}askSet(t){0!==this.length&&("patches"===this.name?super.forLoop(t):this.isBaseSet()?this.baseSetAsk(t):this.isBreedSet()&&this.cloneAsk(t))}baseSetAsk(t){if(0===this.length)return;const e=this.last().id;for(let s=0;s<this.length;s++){const i=this[s],r=i.id;if(r>e)break;if(t(i,s,this),s>=this.length)break;if(this[s].id>r)for(;s>=0&&this[s].id>r;)s--}}cloneAsk(t){const e=this.clone();for(let s=0;s<e.length;s++){const i=e[s];i.breed==this&&i.id>0&&t(i,s,e)}}}class Rt{static emptyDataSet(t,e,s){return new Rt(t,e,new s(t*e))}constructor(t,e,s){if(s.length!==t*e)throw Error(`new DataSet length: ${s.length} !== ${t} * ${e}`);Object.assign(this,{width:t,height:e,data:s})}checkXY(t,e){if(!this.inBounds(t,e))throw Error(`DataSet: x,y out of range: ${t}, ${e}`)}inBounds(t,e){return I(t,0,this.width-1)&&I(e,0,this.height-1)}dataType(){return this.data.constructor}type(){return this.constructor}toIndex(t,e){return t+e*this.width}toXY(t){return[t%this.width,Math.floor(t/this.width)]}getXY(t,e){return this.data[this.toIndex(t,e)]}setXY(t,e,s){this.data[this.toIndex(t,e)]=s}sample(t,e,s=!0){return this.checkXY(t,e),s?this.nearest(t,e):this.bilinear(t,e)}nearest(t,e){return this.getXY(Math.round(t),Math.round(e))}bilinear(t,e){const s=Math.floor(t),i=Math.floor(e),r=this.toIndex(s,i),n=this.width,h=t-s,o=e-i,a=1-h,c=1-o;return this.data[r]*a*c+(this.data[r+1]||0)*h*c+(this.data[r+n]||0)*a*o+(this.data[r+1+n]||0)*h*o}clone(){return new Rt(this.width,this.height,this.data.slice(0))}emptyDataSet(t,e,s=this.dataType()){return Rt.emptyDataSet(t,e,s)}emptyArray(t){return new(this.type())(t)}resample(t,e,s=!0,i=Array){if(t===this.width&&e===this.height)return this.copy();const r=Rt.emptyDataSet(t,e,i);for(let i=0;i<e;i++)for(let n=0;n<t;n++)r.setXY(n,i,this.sample(n*(this.width-1)/(t-1),i*(this.height-1)/(e-1),s));return r}scale(t,e){const s=this.min(),i=(e-t)/(this.max()-s),r=t-i*s;return this.map(t=>i*t+r)}subset(t,e,s,i){if(t+s>this.width||e+i>this.height)throw Error("DataSet.subSet: params out of range");const r=this.emptyDataSet(s,i);for(let n=0;n<s;n++)for(let s=0;s<i;s++)r.setXY(n,s,this.getXY(n+t,s+e));return r}map(t){return new Rt(this.width,this.height,this.data.map(t))}col(t){const[e,s,i]=[this.width,this.height,this.data];if(t>=e)throw Error(`col: x out of range width: ${e} x: ${t}`);const r=this.emptyArray(s);for(let n=0;n<s;n++)r[n]=i[t+n*e];return r}row(t){const[e,s]=[this.width,this.height];if(t>=s)throw Error(`row: y out of range height: ${s} x: ${t}`);return this.data.slice(t*e,(t+1)*e)}convertType(t){this.data=kt(this.data,t)}concatEast(t){const[e,s]=[this.width,this.height],[i,r]=[t.width,t.height];if(s!==r)throw Error(`concatEast: heights not equal ${s}, ${r}`);const n=this.emptyDataSet(e+i,s);for(let t=0;t<s;t++)for(let s=0;s<e;s++)n.setXY(t,s,this.getXY(t,s));for(let s=0;s<r;s++)for(let r=0;r<i;r++)n.setXY(s+e,r,t.getXY(s,r));return n}concatSouth(t){const[e,s,i]=[this.width,this.height,this.data];if(e!==t.width)throw Error(`concatSouth: widths not equal ${e}, ${t.width}`);const r=ft(i,t.data);return new Rt(e,s+t.height,r)}transformCoords(t,e,s,i,r,n){return[(t-s)*(this.width-1)/r,(i-e)*(this.height-1)/n]}coordSample(t,e,s,i,r,n,h=!0){const[o,a]=this.transformCoords(t,e,s,i,r,n);return this.sample(o,a,h)}neighborhood(t,e,s=[]){s.length=0;const i=0===t||t===this.width-1||0===e||e===this.height-1;for(let r=-1;r<=1;r++)for(let n=-1;n<=1;n++){let h=t+n,o=e+r;i&&(h=F(h,0,this.width-1),o=F(o,0,this.height-1)),s.push(this.data[this.toIndex(h,o)])}return s}convolve(t,e=1,s=!1){const[i,r,n,h]=s?[1,1,this.height-1,this.width-1]:[0,0,this.height,this.width],o=this.emptyDataSet(h,n),a=o.data;let c=0;for(let s=r;s<n;s++)for(let r=i;r<h;r++){const i=this.neighborhood(r,s);let n=0;for(let e=0;e<t.length;e++)n+=t[e]*i[e];a[c++]=n*e}return o}dzdx(t=2,e=1/8){return this.convolve([-1,0,1,-t,0,t,-1,0,1],e)}dzdy(t=2,e=1/8){return this.convolve([1,t,1,0,0,0,-1,-t,-1],e)}laplace8(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])}laplace4(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])}blur(t=.0625){return this.convolve([1,2,1,2,4,2,1,2,1],t)}edge(){return this.convolve([1,1,1,1,-7,1,1,1,1])}slopeAndAspect(t=1,e=!0){const s=this.dzdx(),i=this.dzdy();let[r,n]=[[],[]];const[h,o]=[s.height,s.width];for(let a=0;a<h;a++)for(let h=0;h<o;h++){const[o,c]=[s.getXY(h,a),i.getXY(h,a)];n.push(Math.atan(rt(0,0,o,c))/t);let l=Math.atan2(-c,-o);e&&l<0&&(l+=2*Math.PI),r.push(l)}return n=new Rt(o,h,n),r=new Rt(o,h,r),{slope:n,aspect:r,dzdx:s,dzdy:i}}max(){return this.data.reduce((t,e)=>Math.max(t,e))}min(){return this.data.reduce((t,e)=>Math.min(t,e))}extent(){return[this.min(),this.max()]}sum(){return this.data.reduce((t,e)=>t+e,0)}normalize(t=0,e=1){const[s,i]=this.extent(),r=1/(i-s),n=this.data.map(i=>W(t,e,r*(i-s)));return new Rt(this.width,this.height,n)}equals(t){return this.width===t.width&&this.height===t.height&&lt(this.data,t.data)}}class Yt{agentSet;model;name;static defaultVariables(){return{end0:null,end1:null,width:1}}constructor(){Object.assign(this,Yt.defaultVariables())}init(t,e){this.end0=t,this.end1=e,t.links.push(this),e.links.push(this)}die(){this.agentSet.removeAgent(this),ut(this.end0.links,this),ut(this.end1.links,this),this.id=-1}bothEnds(){return Ct.fromArray([this.end0,this.end1])}length(){return this.end0.distance(this.end1)}get heading(){const{x0:t,x1:e,y0:s,y1:i}=this,r=Math.atan2(i-s,e-t);return this.model.fromRads(r)}otherEnd(t){if(t===this.end0)return this.end1;if(t===this.end1)return this.end0;throw Error("Link.otherEnd: turtle not a link turtle: "+t)}distanceXY(t,e){return this.bothEnds().map(s=>s.distanceXY(t,e)).sum()-this.length()}get x0(){return this.end0.x}get y0(){return this.end0.y}get z0(){return this.end0.z?this.end0.z:0}get x1(){return this.end1.x}get y1(){return this.end1.y}get z1(){return this.end1.z?this.end1.z:0}}class jt extends Xt{createOne(t,e,s=(t=>{})){const i=this.addAgent();return i.init(t,e),s(i),i}create(t,e,s=(t=>{})){return Array.isArray(e)||(e=[e]),e.map(e=>this.createOne(t,e,s))}}class Pt{maxX=16;maxY=16;maxZ=16;minX=-16;minY=-16;minZ=-16;constructor(t={}){Object.assign(this,t),this.setWorld()}static defaultOptions(t=16,e=t,s=Math.max(t,e)){return{minX:-t,maxX:t,minY:-e,maxY:e,minZ:-s,maxZ:s}}static defaultWorld(t=16,e=t,s=t){return new Pt(Pt.defaultOptions(t,e,s))}setWorld(){let{minX:t,maxX:e,minY:s,maxY:i,minZ:r,maxZ:n}=this;dt({minX:t,maxX:e,minY:s,maxY:i,minZ:r,maxZ:n},(t,e)=>{if(!Number.isInteger(t))throw Error(`${e}:${t} must be an integer`)}),this.numX=this.width=e-t+1,this.numY=this.height=i-s+1,this.numZ=this.depth=n-r+1,this.minXcor=t-.5,this.maxXcor=e+.5,this.minYcor=s-.5,this.maxYcor=i+.5,this.minZcor=r-.5,this.maxZcor=n+.5,this.centerX=(t+e)/2,this.centerY=(s+i)/2,this.centerZ=(r+n)/2,this.numPatches=this.numX*this.numY}randomPoint(){return[P(this.minXcor,this.maxXcor),P(this.minYcor,this.maxYcor)]}random3DPoint(){return[P(this.minXcor,this.maxXcor),P(this.minYcor,this.maxYcor),P(this.minZcor,this.maxZcor)]}randomPatchPoint(){return[Y(this.minX,this.maxX),Y(this.minY,this.maxY)]}isOnWorld(t,e,s=this.centerZ){return this.minXcor<=t&&t<=this.maxXcor&&this.minYcor<=e&&e<=this.maxYcor&&this.minZcor<=s&&s<=this.maxZcor}bboxTransform(t,e,s,i){return new Tt(t,e,s,i,this)}getWorldSize(t=1){return[this.numX*t,this.numY*t]}setEuclideanTransform(t,e){this.setCanvasSize(t.canvas,e),t.restore(),t.save(),t.scale(e,-e),t.translate(-this.minXcor,-this.maxYcor)}patchSize(t){const{numX:e,numY:s}=this,{clientWidth:i,clientHeight:r}=t,n=i/e,h=r/s;if(n!==h)throw Error(`World patchSize: x/y sizes differ ${n}, ${h}`);return n}setCanvasSize(t,e){const[s,i]=this.getWorldSize(e);b(t,s,i)}pixelXYtoPatchXY(t,e,s){return[this.minXcor+t/s,this.maxYcor-e/s]}patchXYtoPixelXY(t,e,s){return[(t-this.minXcor)*s,(this.maxYcor-e)*s]}xyToPatchIndex(t,e){if(!this.isOnWorld(t,e))return;const{minX:s,maxX:i,maxY:r,numX:n,maxXcor:h,maxYcor:o}=this;return(t=t===h?i:Math.round(t))-s+n*(r-(e=e===o?r:Math.round(e)))}}class Tt{constructor(t,e,s,i,r){t<s&&console.log("flipX"),i<e&&console.log("flipY"),t<s&&([t,s]=[s,t]),i<e&&([i,e]=[e,i]);const{maxXcor:n,maxYcor:h,minXcor:o,minYcor:a}=r,c=(t-s)/(n-o),l=(i-e)/(h-a),u=(t+s-c*(n+o))/2,d=(i+e-l*(h+a))/2;this.setClassProperties({mx:c,my:l,bx:u,by:d})}setClassProperties(t){this.mx=t.mx,this.my=t.my,this.bx=t.bx,this.by=t.by}toWorld(t){const{mx:e,my:s,bx:i,by:r}=this,[n,h]=t;return[(n-i)/e,(h-r)/s]}toBBox(t){const{mx:e,my:s,bx:i,by:r}=this,[n,h]=t;return[e*n+i,s*h+r]}}class Dt extends Ct{constructor(t,...e){if(!t)throw Error("AgentList requires model");super(...e),this.model=t}inRect(t,e,s=e,i=!1){const r=new Dt(this.model),n=t.x-e,h=t.x+e,o=t.y-s,a=t.y+s;return this.ask(e=>{n<=e.x&&e.x<=h&&o<=e.y&&e.y<=a&&(i||t!==e)&&r.push(e)}),r}inRadius(t,e,s=!1){const i=new Dt(this.model),r=e*e,n=it;return this.ask(e=>{n(t.x,t.y,e.x,e.y)<=r&&(s||t!==e)&&i.push(e)}),i}inCone(t,e,s,i,r=!1){i=this.model.toRads(i),s=this.model.toAngleRads(s);const n=new Dt(this.model);return this.ask(h=>{ot(h.x,h.y,e,s,i,t.x,t.y)&&(r||t!==h)&&n.push(h)}),n}}class Ft extends Xt{constructor(t,e,s){super(t,e,s),this.isBreedSet()||(this.populate(),this.labels=[])}populate(){mt(this.model.world.numX*this.model.world.numY,t=>{this.addAgent()})}neighborsOffsets(t,e){const{minX:s,maxX:i,minY:r,maxY:n,numX:h}=this.model.world;return t===s?e===r?[-h,1-h,1]:e===n?[1,h+1,h]:[-h,1-h,1,h+1,h]:t===i?e===r?[-h-1,-h,-1]:e===n?[h,h-1,-1]:[-h-1,-h,h,h-1,-1]:e===r?[-h-1,-h,1-h,1,-1]:e===n?[1,h+1,h,h-1,-1]:[-h-1,-h,1-h,1,h+1,h,h-1,-1]}neighbors4Offsets(t,e){const s=this.model.world.numX;return this.neighborsOffsets(t,e).filter(t=>1===Math.abs(t)||Math.abs(t)===s)}neighbors(t){const{id:e,x:s,y:i}=t,r=this.neighborsOffsets(s,i),n=new Dt(this.model,r.length);return r.forEach((t,s)=>{n[s]=this[t+e]}),n}neighbors4(t){const{id:e,x:s,y:i}=t,r=this.neighbors4Offsets(s,i),n=new Dt(this.model,r.length);return r.forEach((t,s)=>{n[s]=this[t+e]}),n}importDataSet(t,e,s=!1){if(this.isBreedSet())return v("Patches: exportDataSet called with breed, using patches"),void this.baseSet.importDataSet(t,e,s);const{numX:i,numY:r}=this.model.world,n=t.resample(i,r,s);this.ask(t=>{t[e]=n.data[t.id]})}exportDataSet(t,e=Array){if(this.isBreedSet())return v("Patches: exportDataSet called with breed, using patches"),this.baseSet.exportDataSet(t,e);const{numX:s,numY:i}=this.model.world;let r=this.props(t);return r=kt(r,e),new Rt(s,i,r)}patchIndex(t,e){const{minX:s,maxY:i,numX:r}=this.model.world;return t-s+r*(i-e)}patch(t,e){if(!this.model.world.isOnWorld(t,e))return;const s=t===this.model.world.maxXcor?this.model.world.maxX:Math.round(t),i=e===this.model.world.maxYcor?this.model.world.maxY:Math.round(e);return this.patchXY(s,i)}patchXY(t,e){return this[this.patchIndex(t,e)]}patchRect(t,e,s=e,i=!0){if(t.rectCache){const r=this.cacheIndex(e,s,i),n=t.rectCache[r];if(n)return n}const r=new Dt(this.model);let{minX:n,maxX:h,minY:o,maxY:a}=this.model.world;n=Math.max(n,t.x-e),h=Math.min(h,t.x+e),o=Math.max(o,t.y-s),a=Math.min(a,t.y+s);for(let e=o;e<=a;e++)for(let s=n;s<=h;s++){const n=this.patchXY(s,e);(t!==n||i)&&r.push(n)}return r}patchRectXY(t,e,s,i=s,r=!0){return this.patchRect(this.patch(t,e),s,i,r)}cacheIndex(t,e=t,s=!0){return(2*t+1)*(2*e+1)+(s?0:-1)}cacheRect(t,e=t,s=!0,i=!0){const r=this.cacheIndex(t,e,s);this.ask(n=>{n.rectCache&&!i||(n.rectCache=[]);const h=this.inRect(n,t,e,s);n.rectCache[r]=h})}inRect(t,e,s=e,i=!0){const r=this.patchRect(t,e,s,i);return this.isBaseSet()?r:r.withBreed(this)}inRadius(t,e,s=!0){const i=Math.ceil(e);return this.inRect(t,i,i,s).inRadius(t,e,s)}inCone(t,e,s,i,r=!0){const n=Math.ceil(e);return this.inRect(t,n,n,r).inCone(t,e,s,i,r)}patchAtHeadingAndDistance(t,e,s){e=this.model.toRads(e);let{x:i,y:r}=t;return i+=s*Math.cos(e),r+=s*Math.sin(e),this.patch(i,r)}isOnEdge(t){const{x:e,y:s}=t,{minX:i,maxX:r,minY:n,maxY:h}=this.model.world;return e===i||e===r||s===n||s===h}edgePatches(){return this.filter(t=>this.isOnEdge(t))}diffuse(t,e){this.diffuseN(8,t,e)}diffuse4(t,e){this.diffuseN(4,t,e)}diffuseN(t,e,s){if(void 0===this[0]._diffuseNext)for(let t=0;t<this.length;t++)this[t]._diffuseNext=0;for(let i=0;i<this.length;i++){const r=this[i],n=r[e]*s,h=n/t,o=8===t?r.neighbors:r.neighbors4,a=o.length;r._diffuseNext+=r[e]-n+(t-a)*h;for(let t=0;t<o.length;t++)o[t]._diffuseNext+=h}for(let t=0;t<this.length;t++){const s=this[t];s[e]=s._diffuseNext,s._diffuseNext=0}}}class It{agentSet;model;name;static defaultVariables(){return{turtles:void 0,z:0}}constructor(){Object.assign(this,It.defaultVariables())}get x(){return this.id%this.model.world.width+this.model.world.minX}get y(){return this.model.world.maxY-Math.floor(this.id/this.model.world.width)}isOnEdge(){return this.patches.isOnEdge(this)}get neighbors(){const t=this.patches.neighbors(this);return Object.defineProperty(this,"neighbors",{value:t,enumerable:!0}),t}get neighbors4(){const t=this.patches.neighbors4(this);return Object.defineProperty(this,"neighbors4",{value:t,enumerable:!0}),t}turtlesHere(){return null==this.turtles&&(this.patches.ask(t=>{t.turtles=new Dt(this.model)}),this.model.turtles.ask(t=>{t.patch.turtles.push(t)})),this.turtles}breedsHere(t){return this.turtlesHere().withBreed(t)}distanceXY(t,e,s=null){return null!=s&&null!=this.z?ht(this.x,this.y,this.z,t,e,s):rt(this.x,this.y,t,e)}distance(t){const{x:e,y:s,z:i}=t;return this.distanceXY(e,s,i)}towards(t){return this.towardsXY(t.x,t.y)}towardsXY(t,e){let s=K(this.x,this.y,t,e);return this.model.fromRads(s)}patchAt(t,e){return this.patches.patch(this.x+t,this.y+e)}patchAtHeadingAndDistance(t,e){return this.patches.patchAtHeadingAndDistance(this,t,e)}sprout(t=1,e=this.model.turtles,s=(t=>{})){return e.create(t,t=>{t.setxy(this.x,this.y),s(t)})}}class Wt extends Xt{constructor(t,e,s,i=null){super(t,e,s,i)}createOne(t=(t=>{})){const e=this.addAgent();return e.heading=this.model.fromRads(j(2*Math.PI)),t(e),e}create(t,e=(t=>{})){return mt(t,(t,s)=>{s.push(this.createOne(e))})}closestTurtle(t,e,s){const i=this.inPatchRectXY(t,e,s);return 0===i.length?null:i.minOneOf(s=>s.distanceXY(t,e))}inPatches(t){let e=new Dt(this.model);for(const s of t)e.push(...s.turtlesHere());return this.isBreedSet()&&(e=e.filter(t=>t.agentSet===this)),e}inPatchRect(t,e,s=e,i=!1){const r=this.inPatchRectXY(t.x,t.y,e,s);return i||ut(r,t),r}inPatchRectXY(t,e,s,i=s){const r=this.model.patches.patchRectXY(t,e,s,i,!0);return this.inPatches(r)}inRadius(t,e,s=!1){return this.inPatchRect(t,e,e,!0).inRadius(t,e,s)}inCone(t,e,s,i=!1){return this.inPatchRect(t,e,e,!0).inCone(t,e,s,t.heading,i)}layoutCircle(t=.9*this.model.world.maxX,e=[0,0]){const s=Math.PI/2,i=2*Math.PI/this.length,[r,n]=e;this.ask((e,h)=>{e.setxy(r,n),e.theta=s+-1*i*h,e.forward(t)})}}class Zt{atEdge="wrap";agentSet;model;name;constructor(){}agentConstructor(){this.theta=null,this.x=0,this.y=0,this.agentSet.setDefault("z",null)}die(){if(this.agentSet.removeAgent(this),this.hasOwnProperty("links"))for(;this.links.length>0;)this.links[0].die();this.patch&&this.patch.turtles&&ut(this.patch.turtles,this),this.id=-1}hatch(t=1,e=this.agentSet,s=(t=>{})){return e.create(t,t=>{t.setxy(this.x,this.y,this.z),t.theta=this.theta;for(const s of e.ownVariables)null==t[s]&&(t[s]=this[s]);s(t)})}get links(){return Object.defineProperty(this,"links",{value:new Dt(this.model),enumerable:!0}),this.links}get patch(){return this.model.patches.patch(this.x,this.y)}get heading(){return this.model.fromRads(this.theta)}set heading(t){this.theta=this.model.toRads(t)}subtractHeading(t){return G(t,this.heading)}setxy(t,e,s){const i=this.patch;this.x=t,this.y=e,null!=s&&(this.z=s),this.checkXYZ(i)}checkXYZ(t){this.checkEdge(),this.checkPatch(t)}checkEdge(){const{x:t,y:e,z:s}=this;this.model.world.isOnWorld(t,e,s)||"OK"===this.atEdge||this.handleEdge(t,e,s)}checkPatch(t){const e=this.patch;e!=t&&(t&&t.turtles&&ut(t.turtles,this),e&&e.turtles&&e.turtles.push(this))}handleEdge(t,e,s){let i=this.atEdge;if(At(i)){const{minXcor:r,maxXcor:n,minYcor:h,maxYcor:o,minZcor:a,maxZcor:c}=this.model.world;if("wrap"===i)this.x=D(t,r,n),this.y=D(e,h,o),null!=s&&(this.z=D(s,a,c));else{if("clamp"!==i&&"bounce"!==i)throw Error("turtle.handleEdge: bad atEdge: "+i);this.x=F(t,r,n),this.y=F(e,h,o),null!=s&&(this.z=F(s,a,c)),"bounce"===i&&(this.x===r||this.x===n?this.theta=Math.PI-this.theta:this.y===h||this.y===o?this.theta=-this.theta:this.z!==a&&this.z!==c||(this.pitch?this.pitch=-this.pitch:this.z=D(s,a,c)))}}else this.atEdge(this)}moveTo(t){this.setxy(t.x,t.y,t.z)}forward(t){this.setxy(this.x+t*Math.cos(this.theta),this.y+t*Math.sin(this.theta))}rotate(t){t=this.model.toCCW(t),this.heading+=t}right(t){this.rotate(-t)}left(t){this.rotate(t)}face(t){this.heading=this.towards(t)}facexy(t,e){this.heading=this.towardsXY(t,e)}patchAhead(t){return this.patchAtHeadingAndDistance(this.heading,t)}patchRightAndAhead(t,e){return t=this.model.toCCW(t),this.patchAtHeadingAndDistance(this.heading-t,e)}patchLeftAndAhead(t,e){return this.patchRightAndAhead(-t,e)}canMove(t){return null!=this.patchAhead(t)}distanceXY(t,e,s=null){return null!=s&&null!=this.z?ht(this.x,this.y,this.z,t,e,s):rt(this.x,this.y,t,e)}distance(t){const{x:e,y:s,z:i}=t;return this.distanceXY(e,s,i)}get dx(){return Math.cos(this.theta)}get dy(){return Math.sin(this.theta)}towards(t){return this.towardsXY(t.x,t.y)}towardsXY(t,e){let s=K(this.x,this.y,t,e);return this.model.fromRads(s)}patchAt(t,e){return this.model.patches.patch(this.x+t,this.y+e)}patchAtHeadingAndDistance(t,e){return this.model.patches.patchAtHeadingAndDistance(this,t,e)}otherEnd(t){return t.end0===this?t.end1:t.end0}linkNeighbors(){return this.links.map(t=>this.otherEnd(t))}isLinkNeighbor(t){return t in this.linkNeighbors()}}const Nt=[];for(let t=0;t<256;t++)Nt[t]=(t<16?"0":"")+t.toString(16);let qt=1234567;const Bt={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,s=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(Nt[255&t]+Nt[t>>8&255]+Nt[t>>16&255]+Nt[t>>24&255]+"-"+Nt[255&e]+Nt[e>>8&255]+"-"+Nt[e>>16&15|64]+Nt[e>>24&255]+"-"+Nt[63&s|128]+Nt[s>>8&255]+"-"+Nt[s>>16&255]+Nt[s>>24&255]+Nt[255&i]+Nt[i>>8&255]+Nt[i>>16&255]+Nt[i>>24&255]).toUpperCase()},clamp:function(t,e,s){return Math.max(e,Math.min(s,t))},euclideanModulo:function(t,e){return(t%e+e)%e},mapLinear:function(t,e,s,i,r){return i+(t-e)*(r-i)/(s-e)},lerp:function(t,e,s){return(1-s)*t+s*e},smoothstep:function(t,e,s){return t<=e?0:t>=s?1:(t=(t-e)/(s-e))*t*(3-2*t)},smootherstep:function(t,e,s){return t<=e?0:t>=s?1:(t=(t-e)/(s-e))*t*t*(t*(6*t-15)+10)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},seededRandom:function(t){return void 0!==t&&(qt=t%2147483647),qt=16807*qt%2147483647,(qt-1)/2147483646},degToRad:function(t){return t*Bt.DEG2RAD},radToDeg:function(t){return t*Bt.RAD2DEG},isPowerOfTwo:function(t){return 0==(t&t-1)&&0!==t},ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:function(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},setQuaternionFromProperEuler:function(t,e,s,i,r){const n=Math.cos,h=Math.sin,o=n(s/2),a=h(s/2),c=n((e+i)/2),l=h((e+i)/2),u=n((e-i)/2),d=h((e-i)/2),m=n((i-e)/2),f=h((i-e)/2);switch(r){case"XYX":t.set(o*l,a*u,a*d,o*c);break;case"YZY":t.set(a*d,o*l,a*u,o*c);break;case"ZXZ":t.set(a*u,a*d,o*l,o*c);break;case"XZX":t.set(o*l,a*f,a*m,o*c);break;case"YXY":t.set(a*m,o*l,a*f,o*c);break;case"ZYZ":t.set(a*f,a*m,o*l,o*c);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+r)}}};class Vt{constructor(t=0,e=0,s=0,i=1){Object.defineProperty(this,"isQuaternion",{value:!0}),this._x=t,this._y=e,this._z=s,this._w=i}static slerp(t,e,s,i){return s.copy(t).slerp(e,i)}static slerpFlat(t,e,s,i,r,n,h){let o=s[i+0],a=s[i+1],c=s[i+2],l=s[i+3];const u=r[n+0],d=r[n+1],m=r[n+2],f=r[n+3];if(l!==f||o!==u||a!==d||c!==m){let t=1-h;const e=o*u+a*d+c*m+l*f,s=e>=0?1:-1,i=1-e*e;if(i>Number.EPSILON){const r=Math.sqrt(i),n=Math.atan2(r,e*s);t=Math.sin(t*n)/r,h=Math.sin(h*n)/r}const r=h*s;if(o=o*t+u*r,a=a*t+d*r,c=c*t+m*r,l=l*t+f*r,t===1-h){const t=1/Math.sqrt(o*o+a*a+c*c+l*l);o*=t,a*=t,c*=t,l*=t}}t[e]=o,t[e+1]=a,t[e+2]=c,t[e+3]=l}static multiplyQuaternionsFlat(t,e,s,i,r,n){const h=s[i],o=s[i+1],a=s[i+2],c=s[i+3],l=r[n],u=r[n+1],d=r[n+2],m=r[n+3];return t[e]=h*m+c*l+o*d-a*u,t[e+1]=o*m+c*u+a*l-h*d,t[e+2]=a*m+c*d+h*u-o*l,t[e+3]=c*m-h*l-o*u-a*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,s,i){return this._x=t,this._y=e,this._z=s,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e){if(!t||!t.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const s=t._x,i=t._y,r=t._z,n=t._order,h=Math.cos,o=Math.sin,a=h(s/2),c=h(i/2),l=h(r/2),u=o(s/2),d=o(i/2),m=o(r/2);switch(n){case"XYZ":this._x=u*c*l+a*d*m,this._y=a*d*l-u*c*m,this._z=a*c*m+u*d*l,this._w=a*c*l-u*d*m;break;case"YXZ":this._x=u*c*l+a*d*m,this._y=a*d*l-u*c*m,this._z=a*c*m-u*d*l,this._w=a*c*l+u*d*m;break;case"ZXY":this._x=u*c*l-a*d*m,this._y=a*d*l+u*c*m,this._z=a*c*m+u*d*l,this._w=a*c*l-u*d*m;break;case"ZYX":this._x=u*c*l-a*d*m,this._y=a*d*l+u*c*m,this._z=a*c*m-u*d*l,this._w=a*c*l+u*d*m;break;case"YZX":this._x=u*c*l+a*d*m,this._y=a*d*l+u*c*m,this._z=a*c*m-u*d*l,this._w=a*c*l-u*d*m;break;case"XZY":this._x=u*c*l-a*d*m,this._y=a*d*l-u*c*m,this._z=a*c*m+u*d*l,this._w=a*c*l+u*d*m;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+n)}return!1!==e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const s=e/2,i=Math.sin(s);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(s),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,s=e[0],i=e[4],r=e[8],n=e[1],h=e[5],o=e[9],a=e[2],c=e[6],l=e[10],u=s+h+l;if(u>0){const t=.5/Math.sqrt(u+1);this._w=.25/t,this._x=(c-o)*t,this._y=(r-a)*t,this._z=(n-i)*t}else if(s>h&&s>l){const t=2*Math.sqrt(1+s-h-l);this._w=(c-o)/t,this._x=.25*t,this._y=(i+n)/t,this._z=(r+a)/t}else if(h>l){const t=2*Math.sqrt(1+h-s-l);this._w=(r-a)/t,this._x=(i+n)/t,this._y=.25*t,this._z=(o+c)/t}else{const t=2*Math.sqrt(1+l-s-h);this._w=(n-i)/t,this._x=(r+a)/t,this._y=(o+c)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let s=t.dot(e)+1;return s<1e-6?(s=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=s):(this._x=0,this._y=-t.z,this._z=t.y,this._w=s)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=s),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(Bt.clamp(this.dot(t),-1,1)))}rotateTowards(t,e){const s=this.angleTo(t);if(0===s)return this;const i=Math.min(1,e/s);return this.slerp(t,i),this}identity(){return this.set(0,0,0,1)}inverse(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t,e){return void 0!==e?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(t,e)):this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const s=t._x,i=t._y,r=t._z,n=t._w,h=e._x,o=e._y,a=e._z,c=e._w;return this._x=s*c+n*h+i*a-r*o,this._y=i*c+n*o+r*h-s*a,this._z=r*c+n*a+s*o-i*h,this._w=n*c-s*h-i*o-r*a,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const s=this._x,i=this._y,r=this._z,n=this._w;let h=n*t._w+s*t._x+i*t._y+r*t._z;if(h<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,h=-h):this.copy(t),h>=1)return this._w=n,this._x=s,this._y=i,this._z=r,this;const o=1-h*h;if(o<=Number.EPSILON){const t=1-e;return this._w=t*n+e*this._w,this._x=t*s+e*this._x,this._y=t*i+e*this._y,this._z=t*r+e*this._z,this.normalize(),this._onChangeCallback(),this}const a=Math.sqrt(o),c=Math.atan2(a,h),l=Math.sin((1-e)*c)/a,u=Math.sin(e*c)/a;return this._w=n*l+this._w*u,this._x=s*l+this._x*u,this._y=i*l+this._y*u,this._z=r*l+this._z*u,this._onChangeCallback(),this}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e){return void 0===e&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}}class Ht{constructor(t=0,e=0,s=0){Object.defineProperty(this,"isVector3",{value:!0}),this.x=t,this.y=e,this.z=s}set(t,e,s){return void 0===s&&(s=this.z),this.x=t,this.y=e,this.z=s,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(t,e)):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this)}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return t&&t.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(Ut.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(Ut.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,s=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*s+r[6]*i,this.y=r[1]*e+r[4]*s+r[7]*i,this.z=r[2]*e+r[5]*s+r[8]*i,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,s=this.y,i=this.z,r=t.elements,n=1/(r[3]*e+r[7]*s+r[11]*i+r[15]);return this.x=(r[0]*e+r[4]*s+r[8]*i+r[12])*n,this.y=(r[1]*e+r[5]*s+r[9]*i+r[13])*n,this.z=(r[2]*e+r[6]*s+r[10]*i+r[14])*n,this}applyQuaternion(t){const e=this.x,s=this.y,i=this.z,r=t.x,n=t.y,h=t.z,o=t.w,a=o*e+n*i-h*s,c=o*s+h*e-r*i,l=o*i+r*s-n*e,u=-r*e-n*s-h*i;return this.x=a*o+u*-r+c*-h-l*-n,this.y=c*o+u*-n+l*-r-a*-h,this.z=l*o+u*-h+a*-n-c*-r,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,s=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*s+r[8]*i,this.y=r[1]*e+r[5]*s+r[9]*i,this.z=r[2]*e+r[6]*s+r[10]*i,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(Math.max(t,Math.min(e,s)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this.z=t.z+(e.z-t.z)*s,this}cross(t,e){return void 0!==e?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e)):this.crossVectors(this,t)}crossVectors(t,e){const s=t.x,i=t.y,r=t.z,n=e.x,h=e.y,o=e.z;return this.x=i*o-r*h,this.y=r*n-s*o,this.z=s*h-i*n,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const s=t.dot(this)/e;return this.copy(t).multiplyScalar(s)}projectOnPlane(t){return $t.copy(this).projectOnVector(t),this.sub($t)}reflect(t){return this.sub($t.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(Bt.clamp(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return e*e+s*s+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,s){const i=Math.sin(e)*t;return this.x=i*Math.sin(s),this.y=Math.cos(e)*t,this.z=i*Math.cos(s),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,s){return this.x=t*Math.sin(e),this.y=s,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),s=this.setFromMatrixColumn(t,1).length(),i=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=s,this.z=i,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e,s){return void 0!==s&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}}const $t=new Ht,Ut=new Vt;class Lt{constructor(){Object.defineProperty(this,"isMatrix4",{value:!0}),this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(t,e,s,i,r,n,h,o,a,c,l,u,d,m,f,y){const x=this.elements;return x[0]=t,x[4]=e,x[8]=s,x[12]=i,x[1]=r,x[5]=n,x[9]=h,x[13]=o,x[2]=a,x[6]=c,x[10]=l,x[14]=u,x[3]=d,x[7]=m,x[11]=f,x[15]=y,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Lt).fromArray(this.elements)}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],e[9]=s[9],e[10]=s[10],e[11]=s[11],e[12]=s[12],e[13]=s[13],e[14]=s[14],e[15]=s[15],this}copyPosition(t){const e=this.elements,s=t.elements;return e[12]=s[12],e[13]=s[13],e[14]=s[14],this}extractBasis(t,e,s){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),s.setFromMatrixColumn(this,2),this}makeBasis(t,e,s){return this.set(t.x,e.x,s.x,0,t.y,e.y,s.y,0,t.z,e.z,s.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,s=t.elements,i=1/Qt.setFromMatrixColumn(t,0).length(),r=1/Qt.setFromMatrixColumn(t,1).length(),n=1/Qt.setFromMatrixColumn(t,2).length();return e[0]=s[0]*i,e[1]=s[1]*i,e[2]=s[2]*i,e[3]=0,e[4]=s[4]*r,e[5]=s[5]*r,e[6]=s[6]*r,e[7]=0,e[8]=s[8]*n,e[9]=s[9]*n,e[10]=s[10]*n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){t&&t.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");const e=this.elements,s=t.x,i=t.y,r=t.z,n=Math.cos(s),h=Math.sin(s),o=Math.cos(i),a=Math.sin(i),c=Math.cos(r),l=Math.sin(r);if("XYZ"===t.order){const t=n*c,s=n*l,i=h*c,r=h*l;e[0]=o*c,e[4]=-o*l,e[8]=a,e[1]=s+i*a,e[5]=t-r*a,e[9]=-h*o,e[2]=r-t*a,e[6]=i+s*a,e[10]=n*o}else if("YXZ"===t.order){const t=o*c,s=o*l,i=a*c,r=a*l;e[0]=t+r*h,e[4]=i*h-s,e[8]=n*a,e[1]=n*l,e[5]=n*c,e[9]=-h,e[2]=s*h-i,e[6]=r+t*h,e[10]=n*o}else if("ZXY"===t.order){const t=o*c,s=o*l,i=a*c,r=a*l;e[0]=t-r*h,e[4]=-n*l,e[8]=i+s*h,e[1]=s+i*h,e[5]=n*c,e[9]=r-t*h,e[2]=-n*a,e[6]=h,e[10]=n*o}else if("ZYX"===t.order){const t=n*c,s=n*l,i=h*c,r=h*l;e[0]=o*c,e[4]=i*a-s,e[8]=t*a+r,e[1]=o*l,e[5]=r*a+t,e[9]=s*a-i,e[2]=-a,e[6]=h*o,e[10]=n*o}else if("YZX"===t.order){const t=n*o,s=n*a,i=h*o,r=h*a;e[0]=o*c,e[4]=r-t*l,e[8]=i*l+s,e[1]=l,e[5]=n*c,e[9]=-h*c,e[2]=-a*c,e[6]=s*l+i,e[10]=t-r*l}else if("XZY"===t.order){const t=n*o,s=n*a,i=h*o,r=h*a;e[0]=o*c,e[4]=-l,e[8]=a*c,e[1]=t*l+r,e[5]=n*c,e[9]=s*l-i,e[2]=i*l-s,e[6]=h*c,e[10]=r*l+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(Gt,t,Kt)}lookAt(t,e,s){const i=this.elements;return se.subVectors(t,e),0===se.lengthSq()&&(se.z=1),se.normalize(),te.crossVectors(s,se),0===te.lengthSq()&&(1===Math.abs(s.z)?se.x+=1e-4:se.z+=1e-4,se.normalize(),te.crossVectors(s,se)),te.normalize(),ee.crossVectors(se,te),i[0]=te.x,i[4]=ee.x,i[8]=se.x,i[1]=te.y,i[5]=ee.y,i[9]=se.y,i[2]=te.z,i[6]=ee.z,i[10]=se.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(t,e)):this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,r=this.elements,n=s[0],h=s[4],o=s[8],a=s[12],c=s[1],l=s[5],u=s[9],d=s[13],m=s[2],f=s[6],y=s[10],x=s[14],g=s[3],p=s[7],w=s[11],b=s[15],M=i[0],_=i[4],z=i[8],O=i[12],A=i[1],v=i[5],S=i[9],k=i[13],E=i[2],C=i[6],X=i[10],R=i[14],Y=i[3],j=i[7],P=i[11],T=i[15];return r[0]=n*M+h*A+o*E+a*Y,r[4]=n*_+h*v+o*C+a*j,r[8]=n*z+h*S+o*X+a*P,r[12]=n*O+h*k+o*R+a*T,r[1]=c*M+l*A+u*E+d*Y,r[5]=c*_+l*v+u*C+d*j,r[9]=c*z+l*S+u*X+d*P,r[13]=c*O+l*k+u*R+d*T,r[2]=m*M+f*A+y*E+x*Y,r[6]=m*_+f*v+y*C+x*j,r[10]=m*z+f*S+y*X+x*P,r[14]=m*O+f*k+y*R+x*T,r[3]=g*M+p*A+w*E+b*Y,r[7]=g*_+p*v+w*C+b*j,r[11]=g*z+p*S+w*X+b*P,r[15]=g*O+p*k+w*R+b*T,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[4],i=t[8],r=t[12],n=t[1],h=t[5],o=t[9],a=t[13],c=t[2],l=t[6],u=t[10],d=t[14];return t[3]*(+r*o*l-i*a*l-r*h*u+s*a*u+i*h*d-s*o*d)+t[7]*(+e*o*d-e*a*u+r*n*u-i*n*d+i*a*c-r*o*c)+t[11]*(+e*a*l-e*h*d-r*n*l+s*n*d+r*h*c-s*a*c)+t[15]*(-i*h*c-e*o*l+e*h*u+i*n*l-s*n*u+s*o*c)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,s){const i=this.elements;return t.isVector3?(i[12]=t.x,i[13]=t.y,i[14]=t.z):(i[12]=t,i[13]=e,i[14]=s),this}getInverse(t,e){void 0!==e&&console.warn("THREE.Matrix4: .getInverse() can no longer be configured to throw on degenerate.");const s=this.elements,i=t.elements,r=i[0],n=i[1],h=i[2],o=i[3],a=i[4],c=i[5],l=i[6],u=i[7],d=i[8],m=i[9],f=i[10],y=i[11],x=i[12],g=i[13],p=i[14],w=i[15],b=m*p*u-g*f*u+g*l*y-c*p*y-m*l*w+c*f*w,M=x*f*u-d*p*u-x*l*y+a*p*y+d*l*w-a*f*w,_=d*g*u-x*m*u+x*c*y-a*g*y-d*c*w+a*m*w,z=x*m*l-d*g*l-x*c*f+a*g*f+d*c*p-a*m*p,O=r*b+n*M+h*_+o*z;if(0===O)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const A=1/O;return s[0]=b*A,s[1]=(g*f*o-m*p*o-g*h*y+n*p*y+m*h*w-n*f*w)*A,s[2]=(c*p*o-g*l*o+g*h*u-n*p*u-c*h*w+n*l*w)*A,s[3]=(m*l*o-c*f*o-m*h*u+n*f*u+c*h*y-n*l*y)*A,s[4]=M*A,s[5]=(d*p*o-x*f*o+x*h*y-r*p*y-d*h*w+r*f*w)*A,s[6]=(x*l*o-a*p*o-x*h*u+r*p*u+a*h*w-r*l*w)*A,s[7]=(a*f*o-d*l*o+d*h*u-r*f*u-a*h*y+r*l*y)*A,s[8]=_*A,s[9]=(x*m*o-d*g*o-x*n*y+r*g*y+d*n*w-r*m*w)*A,s[10]=(a*g*o-x*c*o+x*n*u-r*g*u-a*n*w+r*c*w)*A,s[11]=(d*c*o-a*m*o-d*n*u+r*m*u+a*n*y-r*c*y)*A,s[12]=z*A,s[13]=(d*g*h-x*m*h+x*n*f-r*g*f-d*n*p+r*m*p)*A,s[14]=(x*c*h-a*g*h-x*n*l+r*g*l+a*n*p-r*c*p)*A,s[15]=(a*m*h-d*c*h+d*n*l-r*m*l-a*n*f+r*c*f)*A,this}scale(t){const e=this.elements,s=t.x,i=t.y,r=t.z;return e[0]*=s,e[4]*=i,e[8]*=r,e[1]*=s,e[5]*=i,e[9]*=r,e[2]*=s,e[6]*=i,e[10]*=r,e[3]*=s,e[7]*=i,e[11]*=r,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,s,i))}makeTranslation(t,e,s){return this.set(1,0,0,t,0,1,0,e,0,0,1,s,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),s=Math.sin(t);return this.set(1,0,0,0,0,e,-s,0,0,s,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,0,s,0,0,1,0,0,-s,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,0,s,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const s=Math.cos(e),i=Math.sin(e),r=1-s,n=t.x,h=t.y,o=t.z,a=r*n,c=r*h;return this.set(a*n+s,a*h-i*o,a*o+i*h,0,a*h+i*o,c*h+s,c*o-i*n,0,a*o-i*h,c*o+i*n,r*o*o+s,0,0,0,0,1),this}makeScale(t,e,s){return this.set(t,0,0,0,0,e,0,0,0,0,s,0,0,0,0,1),this}makeShear(t,e,s){return this.set(1,e,s,0,t,1,s,0,t,e,1,0,0,0,0,1),this}compose(t,e,s){const i=this.elements,r=e._x,n=e._y,h=e._z,o=e._w,a=r+r,c=n+n,l=h+h,u=r*a,d=r*c,m=r*l,f=n*c,y=n*l,x=h*l,g=o*a,p=o*c,w=o*l,b=s.x,M=s.y,_=s.z;return i[0]=(1-(f+x))*b,i[1]=(d+w)*b,i[2]=(m-p)*b,i[3]=0,i[4]=(d-w)*M,i[5]=(1-(u+x))*M,i[6]=(y+g)*M,i[7]=0,i[8]=(m+p)*_,i[9]=(y-g)*_,i[10]=(1-(u+f))*_,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}decompose(t,e,s){const i=this.elements;let r=Qt.set(i[0],i[1],i[2]).length();const n=Qt.set(i[4],i[5],i[6]).length(),h=Qt.set(i[8],i[9],i[10]).length();this.determinant()<0&&(r=-r),t.x=i[12],t.y=i[13],t.z=i[14],Jt.copy(this);const o=1/r,a=1/n,c=1/h;return Jt.elements[0]*=o,Jt.elements[1]*=o,Jt.elements[2]*=o,Jt.elements[4]*=a,Jt.elements[5]*=a,Jt.elements[6]*=a,Jt.elements[8]*=c,Jt.elements[9]*=c,Jt.elements[10]*=c,e.setFromRotationMatrix(Jt),s.x=r,s.y=n,s.z=h,this}makePerspective(t,e,s,i,r,n){void 0===n&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const h=this.elements,o=2*r/(e-t),a=2*r/(s-i),c=(e+t)/(e-t),l=(s+i)/(s-i),u=-(n+r)/(n-r),d=-2*n*r/(n-r);return h[0]=o,h[4]=0,h[8]=c,h[12]=0,h[1]=0,h[5]=a,h[9]=l,h[13]=0,h[2]=0,h[6]=0,h[10]=u,h[14]=d,h[3]=0,h[7]=0,h[11]=-1,h[15]=0,this}makeOrthographic(t,e,s,i,r,n){const h=this.elements,o=1/(e-t),a=1/(s-i),c=1/(n-r),l=(e+t)*o,u=(s+i)*a,d=(n+r)*c;return h[0]=2*o,h[4]=0,h[8]=0,h[12]=-l,h[1]=0,h[5]=2*a,h[9]=0,h[13]=-u,h[2]=0,h[6]=0,h[10]=-2*c,h[14]=-d,h[3]=0,h[7]=0,h[11]=0,h[15]=1,this}equals(t){const e=this.elements,s=t.elements;for(let t=0;t<16;t++)if(e[t]!==s[t])return!1;return!0}fromArray(t,e){void 0===e&&(e=0);for(let s=0;s<16;s++)this.elements[s]=t[s+e];return this}toArray(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t[e+9]=s[9],t[e+10]=s[10],t[e+11]=s[11],t[e+12]=s[12],t[e+13]=s[13],t[e+14]=s[14],t[e+15]=s[15],t}}const Qt=new Ht,Jt=new Lt,Gt=new Ht(0,0,0),Kt=new Ht(1,1,1),te=new Ht,ee=new Ht,se=new Ht;function ie(){}Object.assign(ie.prototype,{addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});const s=this._listeners;void 0===s[t]&&(s[t]=[]),-1===s[t].indexOf(e)&&s[t].push(e)},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;const s=this._listeners;return void 0!==s[t]&&-1!==s[t].indexOf(e)},removeEventListener:function(t,e){if(void 0===this._listeners)return;const s=this._listeners[t];if(void 0!==s){const t=s.indexOf(e);-1!==t&&s.splice(t,1)}},dispatchEvent:function(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const s=e.slice(0);for(let e=0,i=s.length;e<i;e++)s[e].call(this,t)}}});class re{constructor(t=0,e=0,s=0,i=re.DefaultOrder){Object.defineProperty(this,"isEuler",{value:!0}),this._x=t,this._y=e,this._z=s,this._order=i}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,s,i){return this._x=t,this._y=e,this._z=s,this._order=i||this._order,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e,s){const i=Bt.clamp,r=t.elements,n=r[0],h=r[4],o=r[8],a=r[1],c=r[5],l=r[9],u=r[2],d=r[6],m=r[10];switch(e=e||this._order){case"XYZ":this._y=Math.asin(i(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-l,m),this._z=Math.atan2(-h,n)):(this._x=Math.atan2(d,c),this._z=0);break;case"YXZ":this._x=Math.asin(-i(l,-1,1)),Math.abs(l)<.9999999?(this._y=Math.atan2(o,m),this._z=Math.atan2(a,c)):(this._y=Math.atan2(-u,n),this._z=0);break;case"ZXY":this._x=Math.asin(i(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(-u,m),this._z=Math.atan2(-h,c)):(this._y=0,this._z=Math.atan2(a,n));break;case"ZYX":this._y=Math.asin(-i(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(d,m),this._z=Math.atan2(a,n)):(this._x=0,this._z=Math.atan2(-h,c));break;case"YZX":this._z=Math.asin(i(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-l,c),this._y=Math.atan2(-u,n)):(this._x=0,this._y=Math.atan2(o,m));break;case"XZY":this._z=Math.asin(-i(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(d,c),this._y=Math.atan2(o,n)):(this._x=Math.atan2(-l,m),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,!1!==s&&this._onChangeCallback(),this}setFromQuaternion(t,e,s){return ne.makeRotationFromQuaternion(t),this.setFromRotationMatrix(ne,e,s)}setFromVector3(t,e){return this.set(t.x,t.y,t.z,e||this._order)}reorder(t){return he.setFromEuler(this),this.setFromQuaternion(he,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}toVector3(t){return t?t.set(this._x,this._y,this._z):new Ht(this._x,this._y,this._z)}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}}re.DefaultOrder="XYZ",re.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];const ne=new Lt,he=new Vt;class oe{constructor(){this.mask=1}set(t){this.mask=1<<t|0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return 0!=(this.mask&t.mask)}}class ae{constructor(){Object.defineProperty(this,"isMatrix3",{value:!0}),this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}set(t,e,s,i,r,n,h,o,a){const c=this.elements;return c[0]=t,c[1]=i,c[2]=h,c[3]=e,c[4]=r,c[5]=o,c[6]=s,c[7]=n,c[8]=a,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}clone(){return(new this.constructor).fromArray(this.elements)}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],this}extractBasis(t,e,s){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),s.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,r=this.elements,n=s[0],h=s[3],o=s[6],a=s[1],c=s[4],l=s[7],u=s[2],d=s[5],m=s[8],f=i[0],y=i[3],x=i[6],g=i[1],p=i[4],w=i[7],b=i[2],M=i[5],_=i[8];return r[0]=n*f+h*g+o*b,r[3]=n*y+h*p+o*M,r[6]=n*x+h*w+o*_,r[1]=a*f+c*g+l*b,r[4]=a*y+c*p+l*M,r[7]=a*x+c*w+l*_,r[2]=u*f+d*g+m*b,r[5]=u*y+d*p+m*M,r[8]=u*x+d*w+m*_,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],h=t[5],o=t[6],a=t[7],c=t[8];return e*n*c-e*h*a-s*r*c+s*h*o+i*r*a-i*n*o}getInverse(t,e){void 0!==e&&console.warn("THREE.Matrix3: .getInverse() can no longer be configured to throw on degenerate.");const s=t.elements,i=this.elements,r=s[0],n=s[1],h=s[2],o=s[3],a=s[4],c=s[5],l=s[6],u=s[7],d=s[8],m=d*a-c*u,f=c*l-d*o,y=u*o-a*l,x=r*m+n*f+h*y;if(0===x)return this.set(0,0,0,0,0,0,0,0,0);const g=1/x;return i[0]=m*g,i[1]=(h*u-d*n)*g,i[2]=(c*n-h*a)*g,i[3]=f*g,i[4]=(d*r-h*l)*g,i[5]=(h*o-c*r)*g,i[6]=y*g,i[7]=(n*l-u*r)*g,i[8]=(a*r-n*o)*g,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).getInverse(this).transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,s,i,r,n,h){const o=Math.cos(r),a=Math.sin(r);this.set(s*o,s*a,-s*(o*n+a*h)+n+t,-i*a,i*o,-i*(-a*n+o*h)+h+e,0,0,1)}scale(t,e){const s=this.elements;return s[0]*=t,s[3]*=t,s[6]*=t,s[1]*=e,s[4]*=e,s[7]*=e,this}rotate(t){const e=Math.cos(t),s=Math.sin(t),i=this.elements,r=i[0],n=i[3],h=i[6],o=i[1],a=i[4],c=i[7];return i[0]=e*r+s*o,i[3]=e*n+s*a,i[6]=e*h+s*c,i[1]=-s*r+e*o,i[4]=-s*n+e*a,i[7]=-s*h+e*c,this}translate(t,e){const s=this.elements;return s[0]+=t*s[2],s[3]+=t*s[5],s[6]+=t*s[8],s[1]+=e*s[2],s[4]+=e*s[5],s[7]+=e*s[8],this}equals(t){const e=this.elements,s=t.elements;for(let t=0;t<9;t++)if(e[t]!==s[t])return!1;return!0}fromArray(t,e){void 0===e&&(e=0);for(let s=0;s<9;s++)this.elements[s]=t[s+e];return this}toArray(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t}}let ce=0;const le=new Ht,ue=new Vt,de=new Lt,me=new Ht,fe=new Ht,ye=new Ht,xe=new Vt,ge=new Ht(1,0,0),pe=new Ht(0,1,0),we=new Ht(0,0,1),be={type:"added"},Me={type:"removed"};function _e(){Object.defineProperty(this,"id",{value:ce++}),this.uuid=Bt.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=_e.DefaultUp.clone();const t=new Ht,e=new re,s=new Vt,i=new Ht(1,1,1);e._onChange((function(){s.setFromEuler(e,!1)})),s._onChange((function(){e.setFromQuaternion(s,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:s},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new Lt},normalMatrix:{value:new ae}}),this.matrix=new Lt,this.matrixWorld=new Lt,this.matrixAutoUpdate=_e.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new oe,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={}}_e.DefaultUp=new Ht(0,1,0),_e.DefaultMatrixAutoUpdate=!0,_e.prototype=Object.assign(Object.create(ie.prototype),{constructor:_e,isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix4:function(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(t){return this.quaternion.premultiply(t),this},setRotationFromAxisAngle:function(t,e){this.quaternion.setFromAxisAngle(t,e)},setRotationFromEuler:function(t){this.quaternion.setFromEuler(t,!0)},setRotationFromMatrix:function(t){this.quaternion.setFromRotationMatrix(t)},setRotationFromQuaternion:function(t){this.quaternion.copy(t)},rotateOnAxis:function(t,e){return ue.setFromAxisAngle(t,e),this.quaternion.multiply(ue),this},rotateOnWorldAxis:function(t,e){return ue.setFromAxisAngle(t,e),this.quaternion.premultiply(ue),this},rotateX:function(t){return this.rotateOnAxis(ge,t)},rotateY:function(t){return this.rotateOnAxis(pe,t)},rotateZ:function(t){return this.rotateOnAxis(we,t)},translateOnAxis:function(t,e){return le.copy(t).applyQuaternion(this.quaternion),this.position.add(le.multiplyScalar(e)),this},translateX:function(t){return this.translateOnAxis(ge,t)},translateY:function(t){return this.translateOnAxis(pe,t)},translateZ:function(t){return this.translateOnAxis(we,t)},localToWorld:function(t){return t.applyMatrix4(this.matrixWorld)},worldToLocal:function(t){return t.applyMatrix4(de.getInverse(this.matrixWorld))},lookAt:function(t,e,s){t.isVector3?me.copy(t):me.set(t,e,s);const i=this.parent;this.updateWorldMatrix(!0,!1),fe.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?de.lookAt(fe,me,this.up):de.lookAt(me,fe,this.up),this.quaternion.setFromRotationMatrix(de),i&&(de.extractRotation(i.matrixWorld),ue.setFromRotationMatrix(de),this.quaternion.premultiply(ue.inverse()))},add:function(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(null!==t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t),t.dispatchEvent(be)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)},remove:function(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(Me)),this},attach:function(t){return this.updateWorldMatrix(!0,!1),de.getInverse(this.matrixWorld),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),de.multiply(t.parent.matrixWorld)),t.applyMatrix4(de),t.updateWorldMatrix(!1,!1),this.add(t),this},getObjectById:function(t){return this.getObjectByProperty("id",t)},getObjectByName:function(t){return this.getObjectByProperty("name",t)},getObjectByProperty:function(t,e){if(this[t]===e)return this;for(let s=0,i=this.children.length;s<i;s++){const i=this.children[s].getObjectByProperty(t,e);if(void 0!==i)return i}},getWorldPosition:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldPosition() target is now required"),t=new Ht),this.updateMatrixWorld(!0),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldQuaternion() target is now required"),t=new Vt),this.updateMatrixWorld(!0),this.matrixWorld.decompose(fe,t,ye),t},getWorldScale:function(t){return void 0===t&&(console.warn("THREE.Object3D: .getWorldScale() target is now required"),t=new Ht),this.updateMatrixWorld(!0),this.matrixWorld.decompose(fe,xe,t),t},getWorldDirection:function(t){void 0===t&&(console.warn("THREE.Object3D: .getWorldDirection() target is now required"),t=new Ht),this.updateMatrixWorld(!0);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()},raycast:function(){},traverse:function(t){t(this);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].traverse(t)},traverseVisible:function(t){if(!1===this.visible)return;t(this);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].traverseVisible(t)},traverseAncestors:function(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].updateMatrixWorld(t)},updateWorldMatrix:function(t,e){const s=this.parent;if(!0===t&&null!==s&&s.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===e){const t=this.children;for(let e=0,s=t.length;e<s;e++)t[e].updateWorldMatrix(!1,!0)}},toJSON:function(t){const e=void 0===t||"string"==typeof t,s={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{}},s.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const i={};function r(e,s){return void 0===e[s.uuid]&&(e[s.uuid]=s.toJSON(t)),s.uuid}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),!0===this.castShadow&&(i.castShadow=!0),!0===this.receiveShadow&&(i.receiveShadow=!0),!1===this.visible&&(i.visible=!1),!1===this.frustumCulled&&(i.frustumCulled=!1),0!==this.renderOrder&&(i.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON()),this.isMesh||this.isLine||this.isPoints){i.geometry=r(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const s=e.shapes;if(Array.isArray(s))for(let e=0,i=s.length;e<i;e++){const i=s[e];r(t.shapes,i)}else r(t.shapes,s)}}if(void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let s=0,i=this.material.length;s<i;s++)e.push(r(t.materials,this.material[s]));i.material=e}else i.material=r(t.materials,this.material);if(this.children.length>0){i.children=[];for(let e=0;e<this.children.length;e++)i.children.push(this.children[e].toJSON(t).object)}if(e){const e=n(t.geometries),i=n(t.materials),r=n(t.textures),h=n(t.images),o=n(t.shapes);e.length>0&&(s.geometries=e),i.length>0&&(s.materials=i),r.length>0&&(s.textures=r),h.length>0&&(s.images=h),o.length>0&&(s.shapes=o)}return s.object=i,s;function n(t){const e=[];for(const s in t){const i=t[s];delete i.metadata,e.push(i)}return e}},clone:function(t){return(new this.constructor).copy(this,t)},copy:function(t,e){if(void 0===e&&(e=!0),this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const s=t.children[e];this.add(s.clone())}return this}});class ze extends Zt{static defaultVariables(){return{atEdge:"wrap"}}constructor(){super(),Object.assign(this,ze.defaultVariables())}agentConstructor(){this.obj3d=new _e,this.obj3d.rotation.order="ZYX",this.reset()}reset(){this.obj3d.position.set(0,0,0),this.obj3d.rotation.set(0,0,0),this.heading=0}setxyz(t,e,s){super.setxy(t,e,s)}getxyz(){return this.obj3d.position.toArray()}setRotation(t,e,s){this.obj3d.rotation.set(t,e,s)}getRotation(){const{x:t,y:e,z:s}=this.obj3d.rotation;return[t,e,s]}getThetaPhiPsi(){return this.getRotation().reverse()}getHeadingPitchRoll(){const[t,e,s]=this.getRotation();return[V(s),B(-e),B(t)]}getDxDyDz(){return[this.dx,this.dy,this.dz]}get x(){return this.obj3d.position.x}set x(t){this.obj3d.position.x=t}get y(){return this.obj3d.position.y}set y(t){this.obj3d.position.y=t}get z(){return this.obj3d.position.z}set z(t){this.obj3d.position.z=t}get theta(){return this.obj3d.rotation.z}set theta(t){this.obj3d&&(this.obj3d.rotation.z=t)}get heading(){return this.model.fromRads(this.obj3d.rotation.z)}set heading(t){this.obj3d.rotation.z=this.model.toRads(t)}get pitch(){return-this.model.fromAngleRads(this.obj3d.rotation.y)}set pitch(t){this.obj3d.rotation.y=-this.model.toAngleRads(t)}get roll(){return this.model.fromAngleRads(this.obj3d.rotation.x)}set roll(t){this.obj3d.rotation.x=this.model.toAngleRads(t)}forward(t){const e=this.patch;this.obj3d.translateX(t),super.checkXYZ(e)}right(t){this.left(-t)}left(t){this.obj3d.rotateZ(this.model.toAngleRads(t))}tiltUp(t){this.tiltDown(-t)}tiltDown(t){this.obj3d.rotateY(this.model.toAngleRads(t))}rollRight(t){this.obj3d.rotateX(this.model.toAngleRads(t))}rollLeft(t){this.rollRight(-t)}facexyz(t,e,s){const i=this.towardsXY(t,e),r=this.towardsPitchXYZ(t,e,s);this.heading=i,this.pitch=r}face(t){const{x:e,y:s,z:i}=t;this.facexyz(e,s,i)}towardsPitchXYZ(t,e,s){const[i,r,n]=this.getxyz(),[h,o,a]=[t-i,e-r,s-n],c=Math.hypot(h,o);return this.model.fromRads(Math.atan2(a,c))}towardsPitch(t){const{x:e,y:s,z:i}=t;this.towardsPitchXYZ(e,s,i)}distance(t){const{x:e,y:s,z:i}=t;return this.distanceXYZ(e,s,i)}distanceXYZ(t,e,s){const{x:i,y:r,z:n}=this;return ht(i,r,n,t,e,s)}get dx(){const{y:t,z:e}=this.obj3d.rotation;return Math.cos(t)*Math.cos(e)}get dy(){const{y:t,z:e}=this.obj3d.rotation;return Math.cos(t)*Math.sin(e)}get dz(){const t=this.obj3d.rotation.y;return Math.sin(t)}}class Oe{world;patches;turtles;links;ticks;constructor(t=Pt.defaultOptions(),e=!0){this.resetModel(t),e&&this.autoTick()}initAgentSet(t,e,s){this[t]=new e(this,s,t)}resetModel(t){this.ticks=0,this.world=void 0===t.maxXcor?new Pt(t):t,this.initAgentSet("patches",Ft,It),this.initAgentSet("turtles",Wt,ze),this.initAgentSet("links",jt,Yt)}reset(t=this.world){this.resetModel(t)}tick(){this.ticks++}async startup(){}setup(){}step(){}stepAndTick(){this.step0(),this.tick()}autoTick(){this.step0=this.step,this.step=this.stepAndTick}patchBreeds(t){for(const e of t.split(" "))this[e]=this.patches.newBreed(e)}turtleBreeds(t){for(const e of t.split(" "))this[e]=this.turtles.newBreed(e)}linkBreeds(t){for(const e of t.split(" "))this[e]=this.links.newBreed(e)}toRads=t=>(90-t)*ve;fromRads=t=>90-t*Ae;toAngleRads=t=>t*ve;fromAngleRads=t=>t*Ae;toCCW=t=>-t}const Ae=180/Math.PI,ve=Math.PI/180;class Se extends Rt{static rgbToInt24(t,e,s){return 256*t*256+256*e+s}constructor(t,e=Se.rgbToInt24,s=Float32Array){super(t.width,t.height,new s(t.width*t.height)),Array.isArray(e)&&(e=Se.newRgbDataFunction(e));const i=p(t.width,t.height);z(i,t);const r=_(i),n=this.data;for(var h=0;h<n.length;h++){const t=r.data[4*h],s=r.data[4*h+1],i=r.data[4*h+2];n[h]=e(t,s,i)}}}console.warn("util.js is deprecated, please use utils.js which has individual exports\n    To replace: import util from src/util.js\n    Use: import * as util from src/utils.js");export{Ct as AgentArray,Xt as AgentSet,Rt as DataSet,Yt as Link,jt as Links,Oe as Model,It as Patch,Ft as Patches,Se as RGBDataSet,Zt as Turtle,Wt as Turtles,Pt as World,d as gis,Et as util};
